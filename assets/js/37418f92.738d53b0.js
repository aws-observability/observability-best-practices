"use strict";(globalThis.webpackChunkobservability_best_practices=globalThis.webpackChunkobservability_best_practices||[]).push([[9955],{28453(e,n,t){t.d(n,{R:()=>i,x:()=>a});var s=t(96540);const r={},o=s.createContext(r);function i(e){const n=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),s.createElement(o.Provider,{value:n},e.children)}},41494(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>i,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"recipes/recipes/amp-mixin-dashboards","title":"Adding [**kubernetes-mixin**](https://github.com/kubernetes-monitoring/kubernetes-mixin) dashboards to Managed Grafana","description":"Even as a managed service, EKS still exposes many of the metrics from the Kubernetes control plane. The Prometheus community has put together a series of dashboards to review and investigate these metrics. This document will show you how to install them in an environment hosted by Amazon Managed Service for Prometheus.","source":"@site/docs/recipes/recipes/amp-mixin-dashboards.md","sourceDirName":"recipes/recipes","slug":"/recipes/recipes/amp-mixin-dashboards","permalink":"/observability-best-practices/recipes/recipes/amp-mixin-dashboards","draft":false,"unlisted":false,"editUrl":"https://github.com/aws-observability/observability-best-practices/blob/main/docusaurus/docs/recipes/recipes/amp-mixin-dashboards.md","tags":[],"version":"current","frontMatter":{}}');var r=t(74848),o=t(28453);const i={},a="Adding kubernetes-mixin dashboards to Managed Grafana",l={},d=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Installing the mixin dashboards",id:"installing-the-mixin-dashboards",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsxs)(n.h1,{id:"adding-kubernetes-mixin-dashboards-to-managed-grafana",children:["Adding ",(0,r.jsx)(n.a,{href:"https://github.com/kubernetes-monitoring/kubernetes-mixin",children:(0,r.jsx)(n.strong,{children:"kubernetes-mixin"})})," dashboards to Managed Grafana"]})}),"\n",(0,r.jsx)(n.p,{children:"Even as a managed service, EKS still exposes many of the metrics from the Kubernetes control plane. The Prometheus community has put together a series of dashboards to review and investigate these metrics. This document will show you how to install them in an environment hosted by Amazon Managed Service for Prometheus."}),"\n",(0,r.jsx)(n.p,{children:"The Prometheus mixin project expects prometheus to be installed via the Prometheus Operator, but the Terraform blueprints install the Prometheus agent via the default helm charts. In order for the scraping jobs and the dashboards to line up, we need to update the Prometheus rules and the mixin dashboard configuration, then upload the dashboard to our Grafana instance."}),"\n",(0,r.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["An EKS cluster - Starting from: ",(0,r.jsx)(n.a,{href:"https://github.com/aws-ia/terraform-aws-eks-blueprints/tree/main/",children:"https://github.com/aws-ia/terraform-aws-eks-blueprints/tree/main/examples/complete-kubernetes-addons"})]}),"\n",(0,r.jsx)(n.li,{children:"A Cloud9 environment"}),"\n",(0,r.jsx)(n.li,{children:"kubectl in Cloud9 configured to manage the EKS cluster"}),"\n",(0,r.jsx)(n.li,{children:"IAM credentials for EKS"}),"\n",(0,r.jsx)(n.li,{children:"An instance of AMP"}),"\n",(0,r.jsx)(n.li,{children:"An instance of Amazon Managed Grafana"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"installing-the-mixin-dashboards",children:"Installing the mixin dashboards"}),"\n",(0,r.jsx)(n.p,{children:"Starting from a fresh Cloud9 instance and using the AWS blueprint for terraform complete addon example as the target EKS cluster as linked in the Prerequisites:"}),"\n",(0,r.jsx)(n.p,{children:"Expand the file system of the Cloud9 instance to at least 20 gb. In the EC2 console, extend the EBS volume to 20 GB thenfrom the Cloud9 shell, run the commands below:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"sudo growpart /dev/nvme0n1 1\nsudo xfs_growfs -d /\n"})}),"\n",(0,r.jsx)(n.p,{children:"Upgrade awscli to version 2:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'sudo yum remove -y awscli\ncurl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"\nunzip awscliv2.zip\nsudo ./aws/install\nln -s /usr/local/bin/aws /usr/bin/aws\n'})}),"\n",(0,r.jsx)(n.p,{children:"Install prerequisites:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'sudo yum install -y jsonnet\ngo install -a github.com/jsonnet-bundler/jsonnet-bundler/cmd/jb@latest\nexport PATH="$PATH:~/go/bin"\n'})}),"\n",(0,r.jsx)(n.p,{children:"Download and install the jsonnet libraries for the kubernetes-mixin project:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"git clone https://github.com/kubernetes-monitoring/kubernetes-mixincd kubernetes-mixin/\njb install\n"})}),"\n",(0,r.jsx)(n.p,{children:"Edit config.libsonnet and replace the \u201cselectors\u201c section with the following in order to match the prometheus job names:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:" // Selectors are inserted between {} in Prometheus queries.\n cadvisorSelector: 'job=\"kubernetes-nodes-cadvisor\"',\n kubeletSelector: 'job=\"kubernetes-nodes\"',\n kubeStateMetricsSelector: 'job=\"kubernetes-service-endpoints\"',\n nodeExporterSelector: 'job=\"kubernetes-service-endpoints\"',\n kubeSchedulerSelector: 'job=\"kube-scheduler\"',\n kubeControllerManagerSelector: 'job=\"kube-controller-manager\"',\n kubeApiserverSelector: 'job=\"kubernetes-apiservers\"',\n kubeProxySelector: 'job=\"kubernetes-nodes\"',\n podLabel: 'pod',\n hostNetworkInterfaceSelector: 'device!~\"veth.+\"',\n hostMountpointSelector: 'mountpoint=\"/\"',\n windowsExporterSelector: 'job=\"kubernetes-windows-exporter\"',\n containerfsSelector: 'container!=\"\"',\n"})}),"\n",(0,r.jsx)(n.p,{children:"Build the prometheus rules, alerts, and grafana dashboards:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"make prometheus_alerts.yaml\nmake prometheus_rules.yaml\nmake dashboards_out\n"})}),"\n",(0,r.jsx)(n.p,{children:'Upload the prometheus rules to managed prometheus. Replace "WORKSPACE-ID" with the ID of your managed prometheus instance and "REGION" with the appropriate value'}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"base64 prometheus_rules.yaml > prometheus_rules.b64\naws amp create-rule-groups-namespace --data file://prometheus_rules.b64 --name kubernetes-mixin  --workspace-id <<WORKSPACE-ID> --region <<REGION>>\n"})}),"\n",(0,r.jsx)(n.p,{children:"Download the contents of the \u2018dashboard_out\u2019 folder from the Cloud9 environment and upload them using the Grafana web UI."})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}}}]);