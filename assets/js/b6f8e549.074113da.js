"use strict";(self.webpackChunkobservability_best_practices=self.webpackChunkobservability_best_practices||[]).push([[2886],{8388:(e,t,i)=>{i.d(t,{A:()=>o});const o=i.p+"assets/images/EMF-Alarm-ce48a40336b1ea8336cb1bf87216ffa2.png"},28453:(e,t,i)=>{i.d(t,{R:()=>a,x:()=>r});var o=i(96540);const s={},n=o.createContext(s);function a(e){const t=o.useContext(n);return o.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),o.createElement(n.Provider,{value:t},e.children)}},40045:(e,t,i)=>{i.d(t,{A:()=>o});const o=i.p+"assets/images/emf_extracted_CWLogs-0648411bca1c6b317395e9fe7229df7a.png"},57699:(e,t,i)=>{i.d(t,{A:()=>o});const o=i.p+"assets/images/emf_extracted_metrics-e58bd40dc8c6711406164f696972172e.png"},64557:(e,t,i)=>{i.r(t),i.d(t,{assets:()=>c,contentTitle:()=>r,default:()=>h,frontMatter:()=>a,metadata:()=>o,toc:()=>d});const o=JSON.parse('{"id":"guides/signal-collection/emf","title":"CloudWatch Embedded Metric Format","description":"Introduction","source":"@site/docs/guides/signal-collection/emf.md","sourceDirName":"guides/signal-collection","slug":"/guides/signal-collection/emf","permalink":"/observability-best-practices/guides/signal-collection/emf","draft":false,"unlisted":false,"editUrl":"https://github.com/aws-observability/observability-best-practices/blob/main/docusaurus/docs/guides/signal-collection/emf.md","tags":[],"version":"current","frontMatter":{},"sidebar":"guides","previous":{"title":"CloudWatch Dashboard","permalink":"/observability-best-practices/tools/cloudwatch-dashboard"},"next":{"title":"Databricks Monitoring and Observability Best Practices in AWS","permalink":"/observability-best-practices/guides/partners/databricks"}}');var s=i(74848),n=i(28453);const a={},r="CloudWatch Embedded Metric Format",c={},d=[{value:"Introduction",id:"introduction",level:2},{value:"How Embedded Metric Format (EMF) logs work",id:"how-embedded-metric-format-emf-logs-work",level:2},{value:"When to use Embedded Metric Format (EMF) logs",id:"when-to-use-embedded-metric-format-emf-logs",level:2},{value:"Generating Embedded Metric Format (EMF) logs",id:"generating-embedded-metric-format-emf-logs",level:2},{value:"Viewing Embedded Metric Format logs in CloudWatch console",id:"viewing-embedded-metric-format-logs-in-cloudwatch-console",level:2},{value:"Alarms on metrics created with EMF logs",id:"alarms-on-metrics-created-with-emf-logs",level:2},{value:"Latest features of EMF Logs",id:"latest-features-of-emf-logs",level:2},{value:"Additional References:",id:"additional-references",level:2}];function l(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,n.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.header,{children:(0,s.jsx)(t.h1,{id:"cloudwatch-embedded-metric-format",children:"CloudWatch Embedded Metric Format"})}),"\n",(0,s.jsx)(t.h2,{id:"introduction",children:"Introduction"}),"\n",(0,s.jsx)(t.p,{children:"CloudWatch Embedded Metric Format (EMF) enables customers to ingest complex high-cardinality application data to Amazon CloudWatch in the form of logs and generate actionable metrics. With Embedded Metric Format customers do not have to rely on complex architecture or need to use any third party tools to gain insights into their environments. Although this feature can be used in all environments, it\u2019s particularly useful in workloads that have ephemeral resources like AWS Lambda functions or containers in Amazon Elastic Container Service (Amazon ECS), Amazon Elastic Kubernetes Service (Amazon EKS), or Kubernetes on EC2. Embedded Metric Format lets customers easily create custom metrics without having to instrument or maintain separate code, while gaining powerful analytical capabilities on log data."}),"\n",(0,s.jsx)(t.h2,{id:"how-embedded-metric-format-emf-logs-work",children:"How Embedded Metric Format (EMF) logs work"}),"\n",(0,s.jsx)(t.p,{children:"Compute environments like Amazon EC2, On-premise Servers, containers in Amazon Elastic Container Service (Amazon ECS), Amazon Elastic Kubernetes Service (Amazon EKS), or Kubernetes on EC2 can generate & send Embedded Metric Format (EMF) logs through the CloudWatch Agent to Amazon CloudWatch."}),"\n",(0,s.jsx)(t.p,{children:"AWS Lambda allows customers to easily generate custom metrics without requiring any custom code, making blocking network calls or relying on any third party software to generate and ingest Embedded Metric Format (EMF) logs to Amazon CloudWatch."}),"\n",(0,s.jsxs)(t.p,{children:["Customers can embed custom metrics alongside detailed log event data asynchronously without requiring to provide special header declaration while publishing structured logs aligning the ",(0,s.jsx)(t.a,{href:"https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Embedded_Metric_Format_Specification.html",children:"EMF specification"}),". CloudWatch automatically extracts the custom metrics so that customers can visualize & set alarm for real-time incident detection. The detailed log events and high-cardinality context associated with the extracted metrics can be queried using CloudWatch Logs Insights to provide deep insights into the root causes of operational events."]}),"\n",(0,s.jsxs)(t.p,{children:["The Amazon CloudWatch output plugin for ",(0,s.jsx)(t.a,{href:"https://docs.fluentbit.io/manual/pipeline/outputs/cloudwatch",children:"Fluent Bit"})," allows customers to ingest metrics & logs data into the Amazon CloudWatch service that includes support for ",(0,s.jsx)(t.a,{href:"https://github.com/aws/aws-for-fluent-bit",children:"Embedded Metric Format"})," (EMF)."]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"CloudWatch EMF Architecture",src:i(87163).A+"",width:"1163",height:"472"})}),"\n",(0,s.jsx)(t.h2,{id:"when-to-use-embedded-metric-format-emf-logs",children:"When to use Embedded Metric Format (EMF) logs"}),"\n",(0,s.jsx)(t.p,{children:"Traditionally, monitoring has been structured into three categories. The first category is the classic health check of an application. The second category is 'metrics', through which customers instrument their application using models like counters, timers, and gauges. The third category is 'logs', that are invaluable for the overall observability of the application. Logs provide customers continuous information about how their application is behaving. Now, customers have a way to significantly improve the way they can observe their application, without having to make sacrifices in data granularity or richness by unifying and simplifying all the instrumentation of their application while gaining incredible analytical capabilities through Embedded Metric Format (EMF) logs."}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.a,{href:"https://aws.amazon.com/blogs/mt/enhancing-workload-observability-using-amazon-cloudwatch-embedded-metric-format/",children:"Embedded Metric Format (EMF) logs"})," is ideal for environments which generate high cardinality application data, that can be part of the EMF logs without having to increase metric dimensions. This still allows customers to slice and dice the application data by querying EMF logs through CloudWatch Logs Insights and CloudWatch Metrics Insights without needing to put every attribute as a metric dimension."]}),"\n",(0,s.jsxs)(t.p,{children:["Customers aggregating ",(0,s.jsx)(t.a,{href:"https://aws.amazon.com/blogs/mt/how-bt-uses-amazon-cloudwatch-to-monitor-millions-of-devices/",children:"telemetry data from millions of Telco or IoT devices"})," require insights into their devices performance and ability to quickly deep dive into unique telemetry that the devices report. They also need to troubleshoot problems easier & faster without requiring to dig through humongous data to provide a quality service. By using Embedded Metric Format (EMF) logs customers can accomplish large scale observability by combining metrics and logs into single entity and improve troubleshooting with cost efficiency and better performance."]}),"\n",(0,s.jsx)(t.h2,{id:"generating-embedded-metric-format-emf-logs",children:"Generating Embedded Metric Format (EMF) logs"}),"\n",(0,s.jsx)(t.p,{children:"The following methods can be used to generate Embedded metric format logs"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsxs)(t.p,{children:["Generate and send the EMF logs through an agent (like ",(0,s.jsx)(t.a,{href:"https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Embedded_Metric_Format_Generation_CloudWatch_Agent.html",children:"CloudWatch"})," or Fluent-Bit or Firelens) using open-sourced client libraries."]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["Open-sourced client libraries are available in the following languages which can be used to create EMF logs","\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"https://github.com/awslabs/aws-embedded-metrics-node",children:"Node.Js"})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"https://github.com/awslabs/aws-embedded-metrics-python",children:"Python"})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"https://github.com/awslabs/aws-embedded-metrics-java",children:"Java"})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"https://github.com/awslabs/aws-embedded-metrics-dotnet",children:"C#"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["EMF logs can be generated using AWS Distro for OpenTelemetry (ADOT). ADOT is a secure, production-ready, AWS-supported distribution of the OpenTelemetry project part of the Cloud Native Computing Foundation (CNCF). OpenTelemetry is an open-source initiative that provides APIs, libraries, and agents to collect distributed traces, logs and metrics for application monitoring & removes boundaries and restrictions between vendor-specific formats. There are two components required for this, an OpenTelemetry compliant data source and ",(0,s.jsx)(t.a,{href:"https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/exporter/awsemfexporter",children:"ADOT Collector"})," enabled for use with ",(0,s.jsx)(t.a,{href:"https://aws-otel.github.io/docs/getting-started/cloudwatch-metrics#cloudwatch-emf-exporter-awsemf",children:"CloudWatch EMF"})," logs."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsxs)(t.p,{children:["Manually constructed logs conforming to ",(0,s.jsx)(t.a,{href:"https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Embedded_Metric_Format_Specification.html",children:"defined specification in JSON format"}),", can be sent through ",(0,s.jsx)(t.a,{href:"https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Embedded_Metric_Format_Generation_CloudWatch_Agent.html",children:"CloudWatch agent"})," or ",(0,s.jsx)(t.a,{href:"https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Embedded_Metric_Format_Generation_PutLogEvents.html",children:"PutLogEvents API"})," to CloudWatch."]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"viewing-embedded-metric-format-logs-in-cloudwatch-console",children:"Viewing Embedded Metric Format logs in CloudWatch console"}),"\n",(0,s.jsxs)(t.p,{children:["After generating the Embedded Metric Format (EMF) logs that extract metrics customers can ",(0,s.jsx)(t.a,{href:"https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Embedded_Metric_Format_View.html",children:"view them in CloudWatch console"})," under Metrics. Embedded metrics have the dimensions that are specified while generating the logs. Embedded metrics generated using client libraries have ServiceType, ServiceName, LogGroup as default dimensions."]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"ServiceName"}),": The name of the service is overridden, however for services where the name cannot be inferred (e.g. Java process running on EC2) a default value of Unknown is used if not explicitly set."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"ServiceType"}),": The type of the service is overridden, however for services where the type cannot be inferred (e.g. Java process running on EC2) a default value of Unknown is used if not explicitly set."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"LogGroupName"}),": Customers can optionally configure the destination log group that metrics should be delivered to, for agent-based platforms. This value is passed from the library to the agent in the Embedded Metric payload. If a LogGroup is not provided, the default value will be derived from the service name: -metrics"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"LogStreamName"}),": Customers can optionally configure the destination log stream that metrics should be delivered to, for agent-based platforms. This value will be passed from the library to the agent in the Embedded Metric payload. If a LogStreamName is not provided, the default value will be derived by the agent (this will likely be the hostname)."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"NameSpace"}),": Overrides the CloudWatch namespace. If not set, a default value of aws-embedded-metrics is used."]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"A sample EMF logs looks like below in the CloudWatch Console logs"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-json",children:'2023-05-19T15:20:39.391Z 238196b6-c8da-4341-a4b7-0c322e0ef5bb INFO\n{\n    "LogGroup": "emfTestFunction",\n    "ServiceName": "emfTestFunction",\n    "ServiceType": "AWS::Lambda::Function",\n    "Service": "Aggregator",\n    "AccountId": "XXXXXXXXXXXX",\n    "RequestId": "422b1569-16f6-4a03-b8f0-fe3fd9b100f8",\n    "DeviceId": "61270781-c6ac-46f1-baf7-22c808af8162",\n    "Payload": {\n        "sampleTime": 123456789,\n        "temperature": 273,\n        "pressure": 101.3\n    },\n    "executionEnvironment": "AWS_Lambda_nodejs18.x",\n    "memorySize": "256",\n    "functionVersion": "$LATEST",\n    "logStreamId": "2023/05/19/[$LATEST]f3377848231140c185570caa9f97abc8",\n    "_aws": {\n        "Timestamp": 1684509639390,\n        "CloudWatchMetrics": [\n            {\n                "Dimensions": [\n                    [\n                        "LogGroup",\n                        "ServiceName",\n                        "ServiceType",\n                        "Service"\n                    ]\n                ],\n                "Metrics": [\n                    {\n                        "Name": "ProcessingLatency",\n                        "Unit": "Milliseconds"\n                    }\n                ],\n                "Namespace": "aws-embedded-metrics"\n            }\n        ]\n    },\n    "ProcessingLatency": 100\n}\n'})}),"\n",(0,s.jsxs)(t.p,{children:["For the same EMF log, the extracted metrics looks like below, which can be queried in ",(0,s.jsx)(t.strong,{children:"CloudWatch Metrics"}),"."]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"CloudWatch EMF Metrics",src:i(57699).A+"",width:"942",height:"606"})}),"\n",(0,s.jsxs)(t.p,{children:["Customers can query the detailed log events associated with the extracted metrics using ",(0,s.jsx)(t.strong,{children:"CloudWatch Logs Insights"})," to get deep insights into the root causes of operational events. One of the benefits of extracting metrics from EMF logs is that the customers can filter logs by the unique metric (metric name plus unique dimension set) and metric values, to get context on the events that contributed to the aggregated metric value."]}),"\n",(0,s.jsx)(t.p,{children:"For the same EMF logs discussed above, an example query having ProcessingLatency as a metric and Service as a dimension to get an impacted request id or device id is shown below as sample query in CloudWatch Logs Insights."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-json",children:'filter ProcessingLatency < 200 and Service = "Aggregator"\n| fields @requestId, @ingestionTime, @DeviceId\n'})}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"CloudWatch EMF Logs",src:i(40045).A+"",width:"1497",height:"717"})}),"\n",(0,s.jsx)(t.h2,{id:"alarms-on-metrics-created-with-emf-logs",children:"Alarms on metrics created with EMF logs"}),"\n",(0,s.jsxs)(t.p,{children:["Creating ",(0,s.jsx)(t.a,{href:"https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Embedded_Metric_Format_Alarms.html",children:"alarms on metrics generated by EMF"})," follows the same pattern as creating alarms on any other metrics. The key thing to note here is, EMF metric generation depends on log publishing flow, because the CloudWatch Logs process the EMF logs & transform the metrics. So it\u2019s important to publish logs in a timely manner so that the metric datapoints are created within the period of time in which alarms are evaluated."]}),"\n",(0,s.jsx)(t.p,{children:"For the same EMF logs discussed above, an example alarm is created and shown below using the ProcessingLatency metric as a datapoint with a threshold."}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"CloudWatch EMF Alarm",src:i(8388).A+"",width:"1648",height:"960"})}),"\n",(0,s.jsx)(t.h2,{id:"latest-features-of-emf-logs",children:"Latest features of EMF Logs"}),"\n",(0,s.jsxs)(t.p,{children:["Customers can send EMF logs to CloudWatch Logs using ",(0,s.jsx)(t.a,{href:"https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Embedded_Metric_Format_Generation_PutLogEvents.html",children:"PutLogEvents API"})," and may optionally include the HTTP header ",(0,s.jsx)(t.code,{children:"x-amzn-logs-format: json/emf"})," to instruct CloudWatch Logs that the metrics should be extracted, it is no longer necessary."]}),"\n",(0,s.jsxs)(t.p,{children:["Amazon CloudWatch supports ",(0,s.jsx)(t.a,{href:"https://aws.amazon.com/about-aws/whats-new/2023/02/amazon-cloudwatch-high-resolution-metric-extraction-structured-logs/",children:"high resolution metric extraction"})," with up to 1 second granularity from structured logs using Embedded Metric Format (EMF). Customers can provide an optional ",(0,s.jsx)(t.a,{href:"https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/cloudwatch_concepts.html#Resolution_definition",children:"StorageResolution"})," parameter within EMF specification logs with a value of 1 or 60 (default) to indicate the desired resolution (in seconds) of the metric. Customers can publish both standard resolution (60 seconds) and high resolution (1 second) metrics via EMF, enabling granular visibility into their applications\u2019 health and performance."]}),"\n",(0,s.jsxs)(t.p,{children:["Amazon CloudWatch provides ",(0,s.jsx)(t.a,{href:"https://aws.amazon.com/about-aws/whats-new/2023/01/amazon-cloudwatch-enhanced-error-visibility-embedded-metric-format-emf/",children:"enhanced visibility into errors"})," in Embedded Metric Format (EMF) with two error metrics (",(0,s.jsx)(t.a,{href:"https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CloudWatch-Logs-Monitoring-CloudWatch-Metrics.html",children:"EMFValidationErrors & EMFParsingErrors"}),"). This enhanced visibility helps customers quickly identify and remediate errors when leveraging EMF, thereby simplifying the instrumentation process ."]}),"\n",(0,s.jsxs)(t.p,{children:["With the increased complexity of managing modern applications, customers need more flexibility when defining and analyzing custom metrics. Hence the maximum number of metric dimensions has been increased from 10 to 30. Customers can create custom metrics using ",(0,s.jsx)(t.a,{href:"https://aws.amazon.com/about-aws/whats-new/2022/08/amazon-cloudwatch-metrics-increases-throughput/",children:"EMF logs with up to 30 dimensions"}),"."]}),"\n",(0,s.jsx)(t.h2,{id:"additional-references",children:"Additional References:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["One Observability Workshop on ",(0,s.jsx)(t.a,{href:"https://catalog.workshops.aws/observability/en-US/aws-native/metrics/emf/clientlibrary",children:"Embedded Metric Format with an AWS Lambda function"})," sample using NodeJS Library."]}),"\n",(0,s.jsxs)(t.li,{children:["Serverless Observability Workshop on ",(0,s.jsx)(t.a,{href:"https://serverless-observability.workshop.aws/en/030_cloudwatch/async_metrics_emf.html",children:"Async metrics using Embedded Metrics Format"})," (EMF)"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.a,{href:"https://catalog.workshops.aws/observability/en-US/aws-native/metrics/emf/putlogevents",children:"Java code sample using PutLogEvents API"})," to send EMF logs to CloudWatch Logs"]}),"\n",(0,s.jsxs)(t.li,{children:["Blog article: ",(0,s.jsx)(t.a,{href:"https://aws.amazon.com/blogs/mt/lowering-costs-and-focusing-on-our-customers-with-amazon-cloudwatch-embedded-custom-metrics/",children:"Lowering costs and focusing on our customers with Amazon CloudWatch embedded custom metrics"})]}),"\n"]})]})}function h(e={}){const{wrapper:t}={...(0,n.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},87163:(e,t,i)=>{i.d(t,{A:()=>o});const o=i.p+"assets/images/EMF-Arch-46358de68242627eb3772fd87fbeb613.png"}}]);