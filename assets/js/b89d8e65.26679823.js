"use strict";(self.webpackChunkobservability_best_practices=self.webpackChunkobservability_best_practices||[]).push([[5368],{22336:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>n,metadata:()=>r,toc:()=>l});var o=s(74848),a=s(28453);const n={},i="Metrics",r={id:"tools/metrics",title:"Metrics",description:"Metrics are data about the performance of your system. Having all the metrics related to system or the resources available in a centralised place grants you the ability to compare metrics, analyse performance, and make better strategic decisions like scaling-up or scaling-in resources. Metrics are also important for the knowing the health of the resources and take proactive measures.",source:"@site/docs/tools/metrics.md",sourceDirName:"tools",slug:"/tools/metrics",permalink:"/observability-best-practices/docs/tools/metrics",draft:!1,unlisted:!1,editUrl:"https://github.com/aws-observability/observability-best-practices/docs/tools/metrics.md",tags:[],version:"current",frontMatter:{},sidebar:"tools",previous:{title:"Application Signals for Kotlin Services",permalink:"/observability-best-practices/docs/tools/application-signals/kotlin-signals"},next:{title:"Real User Monitoring",permalink:"/observability-best-practices/docs/tools/rum"}},c={},l=[{value:"Vended metrics",id:"vended-metrics",level:2},{value:"Querying metrics",id:"querying-metrics",level:2},{value:"Collecting metrics",id:"collecting-metrics",level:2},{value:"Anomaly detection",id:"anomaly-detection",level:2}];function d(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.h1,{id:"metrics",children:"Metrics"}),"\n",(0,o.jsx)(t.p,{children:"Metrics are data about the performance of your system. Having all the metrics related to system or the resources available in a centralised place grants you the ability to compare metrics, analyse performance, and make better strategic decisions like scaling-up or scaling-in resources. Metrics are also important for the knowing the health of the resources and take proactive measures."}),"\n",(0,o.jsxs)(t.p,{children:["Metric data is foundational and used to drive ",(0,o.jsx)(t.a,{href:"../signals/alarms/",children:"alarms"}),", anomaly detection, ",(0,o.jsx)(t.a,{href:"../signals/events/",children:"events"}),", ",(0,o.jsx)(t.a,{href:"../tools/dashboards",children:"dashboards"})," and more."]}),"\n",(0,o.jsx)(t.h2,{id:"vended-metrics",children:"Vended metrics"}),"\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.a,{href:"https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/working_with_metrics.html",children:"CloudWatch metrics"})," collects data about the performance of your systems. By default, most AWS services provide free metrics for their resources. This includes  ",(0,o.jsx)(t.a,{href:"https://aws.amazon.com/ec2/",children:"Amazon EC2"})," instances, ",(0,o.jsx)(t.a,{href:"https://aws.amazon.com/rds/",children:"Amazon RDS"}),", ",(0,o.jsx)(t.a,{href:"https://aws.amazon.com/s3/?p=pm&c=s3&z=4",children:"Amazon S3"})," buckets, and many more."]}),"\n",(0,o.jsxs)(t.p,{children:["We refer to these metrics as ",(0,o.jsx)(t.em,{children:"vended metrics"}),". There is no charge for the collection of vended metrics in your AWS account."]}),"\n",(0,o.jsx)(t.admonition,{type:"info",children:(0,o.jsxs)(t.p,{children:["For a complete list of AWS services that emit metrics to CloudWatch see ",(0,o.jsx)(t.a,{href:"https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/aws-services-cloudwatch-metrics.html",children:"this page"}),"."]})}),"\n",(0,o.jsx)(t.h2,{id:"querying-metrics",children:"Querying metrics"}),"\n",(0,o.jsxs)(t.p,{children:["You can utilise the ",(0,o.jsx)(t.a,{href:"https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/using-metric-math.html",children:"metric math"})," feature in CloudWatch to query multiple metrics and use math expressions to analyse the metrics for more granularity. For example, you can write a metric math expression to find out the Lambda error rate by query as:"]}),"\n",(0,o.jsx)(t.p,{children:"Errors/Requests"}),"\n",(0,o.jsx)(t.p,{children:"Below you see an example of how this can appear in the CloudWatch console:"}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"Metric math example",src:s(65042).A+"",width:"1319",height:"626"})}),"\n",(0,o.jsx)(t.admonition,{type:"info",children:(0,o.jsx)(t.p,{children:"Use metric math to get the most value from your data and derive values from the performance of separate data sources."})}),"\n",(0,o.jsxs)(t.p,{children:["CloudWatch also supports conditional statements. For example, to return a value of ",(0,o.jsx)(t.code,{children:"1"})," for each timeseries where latency is over a specific threshold, and ",(0,o.jsx)(t.code,{children:"0"})," for all other data points, a query would resemble this:"]}),"\n",(0,o.jsx)(t.p,{children:"IF(latency>threshold, 1, 0)"}),"\n",(0,o.jsxs)(t.p,{children:["In the CloudWatch console we can use this logic to create boolean values, which in turn can trigger ",(0,o.jsx)(t.a,{href:"../tools/alarms",children:"CloudWatch alarms"})," or other actions. This can enable automatic actions from derived datapoints. An example from the CloudWatch console is below:"]}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"Alarm creation from a derived value",src:s(30185).A+"",width:"789",height:"988"})}),"\n",(0,o.jsx)(t.admonition,{type:"info",children:(0,o.jsx)(t.p,{children:"Use conditional statements to trigger alarms and notifications when performance exceeds thresholds for derived values."})}),"\n",(0,o.jsxs)(t.p,{children:["You can also use a ",(0,o.jsx)(t.code,{children:"SEARCH"})," function to show the top ",(0,o.jsx)(t.code,{children:"n"})," for any metric. When visualizing the best or worst performing metrics across a large number timeseries (e.g. thousands of servers) this approach allows you to see only the data that matters most. Here is an example of a search returning the top two CPU-consuming EC2 instances, averaged over the last five minutes:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{children:"\tSLICE(SORT(SEARCH('{AWS/EC2,InstanceId} MetricName=\"CPUUtilization\"', 'Average', 300), MAX, DESC),0, 2)\n"})}),"\n",(0,o.jsx)(t.p,{children:"And a view of the same in the CloudWatch console:"}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"Search query in CloudWatch metrics",src:s(59008).A+"",width:"1393",height:"810"})}),"\n",(0,o.jsx)(t.admonition,{type:"info",children:(0,o.jsxs)(t.p,{children:["Use the ",(0,o.jsx)(t.code,{children:"SEARCH"})," approach to rapidly display the valuable or worst performing resources in your environment, and then display these in ",(0,o.jsx)(t.a,{href:"../tools/dashboards",children:"dashboards"}),"."]})}),"\n",(0,o.jsx)(t.h2,{id:"collecting-metrics",children:"Collecting metrics"}),"\n",(0,o.jsxs)(t.p,{children:["If you would like to have additional metrics like memory or disk space utilization for your EC2 instances, you use the ",(0,o.jsx)(t.a,{href:"../tools/cloudwatch_agent/",children:"CloudWatch agent"})," to push this data to CloudWatch on your behalf. Or if you have custom processing data which needs to be visualised in graphical manner, and you want this data to be present as CloudWatch metric, then you can use ",(0,o.jsxs)(t.a,{href:"https://docs.aws.amazon.com/AmazonCloudWatch/latest/APIReference/API_PutMetricData.html",children:[(0,o.jsx)(t.code,{children:"PutMetricData"})," API"]})," to publish custom metrics to CloudWatch."]}),"\n",(0,o.jsx)(t.admonition,{type:"info",children:(0,o.jsxs)(t.p,{children:["Use one of the ",(0,o.jsx)(t.a,{href:"https://aws.amazon.com/developer/tools/",children:"AWS SDKs"})," to push metric data to CloudWatch rather than the bare API."]})}),"\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.code,{children:"PutMetricData"})," API calls are charges on number of queries. The best practise to use the ",(0,o.jsx)(t.code,{children:"PutMetricData"})," API optimally. Using the Values and Counts method in this API, enables you to publish up to 150 values per metric with one ",(0,o.jsx)(t.code,{children:"PutMetricData"})," request, and supports retrieving percentile statistics on this data. Thus, instead of making separate API calls for each of the datapoint, you should group all your datapoints together and then push to CloudWatch in a single ",(0,o.jsx)(t.code,{children:"PutMetricData"})," API call. This approach benefits the user in two ways:"]}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsx)(t.li,{children:"CloudWatch pricing"}),"\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.code,{children:"PutMetricData"})," API throttling can be prevented"]}),"\n"]}),"\n",(0,o.jsx)(t.admonition,{type:"info",children:(0,o.jsxs)(t.p,{children:["When using ",(0,o.jsx)(t.code,{children:"PutMetricData"}),", the best practice is to batch your data into single ",(0,o.jsx)(t.code,{children:"PUT"})," operations whenever possible."]})}),"\n",(0,o.jsx)(t.admonition,{type:"info",children:(0,o.jsxs)(t.p,{children:["If large volumes of metrics are emitted into CloudWatch then consider using ",(0,o.jsx)(t.a,{href:"https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Embedded_Metric_Format_Manual.html",children:"Embedded Metric Format"})," as an alternative approach. Note that Embedded Metric Format does not use, nor charge, for the use of ",(0,o.jsx)(t.code,{children:"PutMetricData"}),", though it does incur billing from the use of ",(0,o.jsx)(t.a,{href:"../tools/logs/",children:"CloudWatch Logs"}),"."]})}),"\n",(0,o.jsx)(t.h2,{id:"anomaly-detection",children:"Anomaly detection"}),"\n",(0,o.jsxs)(t.p,{children:["CloudWatch has an ",(0,o.jsx)(t.a,{href:"https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Anomaly_Detection.html",children:"anomaly detection"})," feature that augments your observability strategy by learning what ",(0,o.jsx)(t.em,{children:"normal"})," is based on recorded metrics. The use of anomaly detection is a ",(0,o.jsx)(t.a,{href:"../signals/metrics/#use-anomaly-detection-algorithms",children:"best practice"})," for any metric signal collection system."]}),"\n",(0,o.jsx)(t.p,{children:"Anomaly detection builds a model over a two-week period of time."}),"\n",(0,o.jsx)(t.admonition,{type:"warning",children:(0,o.jsx)(t.p,{children:"Anomaly detection only builds its model from the time of creation forward. It does not project backwards in time to find previous outliers."})}),"\n",(0,o.jsx)(t.admonition,{type:"warning",children:(0,o.jsxs)(t.p,{children:["Anomaly detection does not know what ",(0,o.jsx)(t.em,{children:"good"})," is for a metric, only what ",(0,o.jsx)(t.em,{children:"normal"})," is based on standard deviation."]})}),"\n",(0,o.jsx)(t.admonition,{type:"info",children:(0,o.jsx)(t.p,{children:"The best practice is to train your anomaly detection models to only analyze the times of day that normal behaviour is expected. You can define time periods to exclude from training (such as nights, weekends, or holidays)."})}),"\n",(0,o.jsx)(t.p,{children:"An example of an anomaly detection band can be seen here, with the band in grey."}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"Anomaly detection band",src:s(34015).A+"",width:"1372",height:"855"})}),"\n",(0,o.jsxs)(t.p,{children:["Setting exclusion windows for anomaly detection can be done with the CloudWatch console, ",(0,o.jsx)(t.a,{href:"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-cloudwatch-anomalydetector-configuration.html",children:"CloudFormation"}),", or using one of the AWS SDKs."]})]})}function h(e={}){const{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},65042:(e,t,s)=>{s.d(t,{A:()=>o});const o=s.p+"assets/images/metrics1-166a8df857b34989d46828d939c09399.png"},30185:(e,t,s)=>{s.d(t,{A:()=>o});const o=s.p+"assets/images/metrics2-f704ad209961f687125bc4c78719300f.png"},59008:(e,t,s)=>{s.d(t,{A:()=>o});const o=s.p+"assets/images/metrics3-93552c3d9c53b8d63555a868c861a604.png"},34015:(e,t,s)=>{s.d(t,{A:()=>o});const o=s.p+"assets/images/metrics4-a7dcf38fb4698f551d5aa680bd61b214.png"},28453:(e,t,s)=>{s.d(t,{R:()=>i,x:()=>r});var o=s(96540);const a={},n=o.createContext(a);function i(e){const t=o.useContext(n);return o.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),o.createElement(n.Provider,{value:t},e.children)}}}]);