<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-guides/containers/aws-native/eks/log-aggregation" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">Log Aggregation | AWS Observability best practices</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://aws-observability.github.io/observability-best-practices/docs/guides/containers/aws-native/eks/log-aggregation"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" property="og:locale:alternate" content="ja"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Log Aggregation | AWS Observability best practices"><meta data-rh="true" name="description" content="In this section of Observability best practices guide, we will deep dive on to following topics related to Amazon EKS Logging with AWS Native services:"><meta data-rh="true" property="og:description" content="In this section of Observability best practices guide, we will deep dive on to following topics related to Amazon EKS Logging with AWS Native services:"><link data-rh="true" rel="icon" href="/observability-best-practices/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://aws-observability.github.io/observability-best-practices/docs/guides/containers/aws-native/eks/log-aggregation"><link data-rh="true" rel="alternate" href="https://aws-observability.github.io/observability-best-practices/docs/guides/containers/aws-native/eks/log-aggregation" hreflang="en"><link data-rh="true" rel="alternate" href="https://aws-observability.github.io/observability-best-practices/ja/docs/guides/containers/aws-native/eks/log-aggregation" hreflang="ja"><link data-rh="true" rel="alternate" href="https://aws-observability.github.io/observability-best-practices/docs/guides/containers/aws-native/eks/log-aggregation" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/observability-best-practices/blog/rss.xml" title="AWS Observability best practices RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/observability-best-practices/blog/atom.xml" title="AWS Observability best practices Atom Feed"><link rel="stylesheet" href="/observability-best-practices/assets/css/styles.2859e3e9.css">
<script src="/observability-best-practices/assets/js/runtime~main.240bb889.js" defer="defer"></script>
<script src="/observability-best-practices/assets/js/main.21eb589f.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/observability-best-practices/"><div class="navbar__logo"><img src="/observability-best-practices/img/logo.svg" alt="AWS Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/observability-best-practices/img/logo.svg" alt="AWS Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">AWS Observability Best Practices</b></a><a class="navbar__item navbar__link" href="/observability-best-practices/docs/home">Home</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/observability-best-practices/docs/guides/">Guides</a><a class="navbar__item navbar__link" href="/observability-best-practices/docs/signals/alarms">Signals</a><a class="navbar__item navbar__link" href="/observability-best-practices/docs/tools/observability_accelerator">Tools</a><a class="navbar__item navbar__link" href="/observability-best-practices/docs/recipes/">Recipes</a><a class="navbar__item navbar__link" href="/observability-best-practices/docs/faq/adot">FAQ</a><a class="navbar__item navbar__link" href="/observability-best-practices/docs/patterns/multiaccount">Patterns</a><a class="navbar__item navbar__link" href="/observability-best-practices/docs/contributors">Contributors</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link" href="/observability-best-practices/docs/guides/containers/aws-native/eks/log-aggregation"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/observability-best-practices/docs/guides/containers/aws-native/eks/log-aggregation" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/observability-best-practices/ja/docs/guides/containers/aws-native/eks/log-aggregation" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="ja">日本語</a></li></ul></div><a href="https://github.com/aws-observability/observability-best-practices" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/observability-best-practices/docs/guides/">Guides</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/observability-best-practices/docs/guides/">Best practices overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/observability-best-practices/docs/guides/choosing-a-tracing-agent">Choosing a tracing agent</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/observability-best-practices/docs/guides/cost/kubecost">Cost</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/observability-best-practices/docs/guides/databases/rds-and-aurora">Databases</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/observability-best-practices/docs/guides/ec2-monitoring">EC2 Monitoring and Observability</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/observability-best-practices/docs/guides/containers/aws-native/ecs/best-practices-metrics-collection-1">ECS best practices</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/observability-best-practices/docs/guides/containers/aws-native/eks/amazon-cloudwatch-container-insights">EKS best practices</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/observability-best-practices/docs/guides/containers/aws-native/eks/amazon-cloudwatch-container-insights">AWS Native</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/observability-best-practices/docs/guides/containers/aws-native/eks/amazon-cloudwatch-container-insights">Amazon CloudWatch Container Insights</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/observability-best-practices/docs/guides/containers/aws-native/eks/log-aggregation">Log Aggregation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/observability-best-practices/docs/guides/containers/aws-native/eks/eks-api-server-monitoring">Amazon EKS API Server Monitoring</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/observability-best-practices/docs/guides/containers/aws-native/eks/container-tracing-with-aws-xray">Container Tracing with AWS X-Ray</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/observability-best-practices/docs/guides/containers/oss/eks/best-practices-metrics-collection">Open Source</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/observability-best-practices/docs/guides/serverless/aws-native/lambda-based-observability">Serverless best practices</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/observability-best-practices/docs/guides/hybrid-and-multicloud">Best practices for hybrid and multicloud</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector">Operational</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/observability-best-practices/docs/guides/signal-collection/emf">Signal collection</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/observability-best-practices/docs/guides/partners/databricks">Partners</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/observability-best-practices/docs/guides/observability-maturity-model">AWS Observability Maturity Model</a></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/observability-best-practices/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Guides</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">EKS best practices</span><meta itemprop="position" content="2"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">AWS Native</span><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Log Aggregation</span><meta itemprop="position" content="4"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Log Aggregation</h1>
<p>In this section of Observability best practices guide, we will deep dive on to following topics related to Amazon EKS Logging with AWS Native services:</p>
<ul>
<li>Introduction to AWS EKS logging</li>
<li>Amazon EKS control plane logging</li>
<li>Amazon EKS data plane logging</li>
<li>Amazon EKS application logging</li>
<li>Unified log aggregation from Amazon EKS and other compute platforms using AWS Native services</li>
<li>Conclusion</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction" href="/observability-best-practices/docs/guides/containers/aws-native/eks/log-aggregation#introduction">​</a></h3>
<p>Amazon EKS logging can be divided into three types such as control plane logging, node logging, and application logging. The <a href="https://kubernetes.io/docs/concepts/overview/components/#control-plane-components" target="_blank" rel="noopener noreferrer">Kubernetes control plane</a> is a set of components that manage Kubernetes clusters and produce logs used for auditing and diagnostic purposes. With Amazon EKS, you can <a href="https://docs.aws.amazon.com/eks/latest/userguide/control-plane-logs.html" target="_blank" rel="noopener noreferrer">turn on logs for different control plane components</a> and send them to CloudWatch.</p>
<p>Kubernetes also runs system components such as <code>kubelet</code> and <code>kube-proxy</code> on each Kubernetes node that runs your pods. These components write logs within each node and you can configure CloudWatch and Container Insights to capture these logs for each Amazon EKS node.</p>
<p>Containers are grouped as <a href="https://kubernetes.io/docs/concepts/workloads/pods/" target="_blank" rel="noopener noreferrer">pods</a> within a Kubernetes cluster and are scheduled to run on your Kubernetes nodes. Most containerized applications write to standard output and standard error, and the container engine redirects the output to a logging driver. In Kubernetes, the container logs are found in the <code>/var/log/pods</code> directory on a node. You can configure CloudWatch and Container Insights to capture these logs for each of your Amazon EKS pods.</p>
<p>There are three common approaches for capturing logs Shipping container logs to a centralized log aggregation system in Kubernetes:</p>
<ul>
<li>Node level agent, like a <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/Container-Insights-setup-logs.html" target="_blank" rel="noopener noreferrer">Fluentd daemonset</a>. This is the recommended pattern.</li>
<li>Sidecar container, like a Fluentd sidecar container.</li>
<li>Directly writing to log collection system. In this approach, the application is responsible for shipping the logs. This is the least recommended option because you will have to include the log aggregation system’s SDK in your application code instead of reusing community build solutions like Fluentd. This pattern also disobeys the <em>principle of separation of concerns</em>, according to which, logging implementation should be independent of the application. Doing so allows you to change the logging infrastructure without impacting or changing your application.</li>
</ul>
<p>We will now dive in to each of these logging categories for Amazon EKS logging along with talking about unified log aggregation from Amazon EKS and other compute platforms.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="amazon-eks-control-plane-logging">Amazon EKS control plane logging<a class="hash-link" aria-label="Direct link to Amazon EKS control plane logging" title="Direct link to Amazon EKS control plane logging" href="/observability-best-practices/docs/guides/containers/aws-native/eks/log-aggregation#amazon-eks-control-plane-logging">​</a></h3>
<p>An Amazon EKS cluster consists of a high availability, single-tenant control plane for your Kubernetes cluster and the Amazon EKS nodes that run your containers. The control plane nodes run in an account managed by AWS. The Amazon EKS cluster control plane nodes are integrated with CloudWatch and you can turn on logging for specific control plane components. Logs are provided for each Kubernetes control plane component instance. AWS manages the health of your control plane nodes and provides a <a href="http://aws.amazon.com/eks/sla/" target="_blank" rel="noopener noreferrer">service-level agreement (SLA) for the Kubernetes endpoint</a>.</p>
<p><a href="https://docs.aws.amazon.com/eks/latest/userguide/control-plane-logs.html" target="_blank" rel="noopener noreferrer">Amazon EKS control plane logging</a> consists of following cluster control plane log types. Each log type corresponds to a component of the Kubernetes control plane. To learn more about these components, see <a href="https://kubernetes.io/docs/concepts/overview/components/" target="_blank" rel="noopener noreferrer">Kubernetes Components</a> in the Kubernetes documentation.</p>
<ul>
<li><strong>API server (<code>api</code>)</strong> – Your cluster&#x27;s API server is the control plane component that exposes the Kubernetes API. If you enable API server logs when you launch the cluster, or shortly thereafter, the logs include API server flags that were used to start the API server. For more information, see <a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/" target="_blank" rel="noopener noreferrer"><code>kube-apiserver</code></a> and the <a href="https://github.com/kubernetes/kubernetes/blob/master/cluster/gce/gci/configure-helper.sh#L1129-L1255" target="_blank" rel="noopener noreferrer">audit policy</a> in the Kubernetes documentation.</li>
<li><strong>Audit (<code>audit</code>)</strong> – Kubernetes audit logs provide a record of the individual users, administrators, or system components that have affected your cluster. For more information, see <a href="https://kubernetes.io/docs/tasks/debug-application-cluster/audit/" target="_blank" rel="noopener noreferrer">Auditing</a> in the Kubernetes documentation.</li>
<li><strong>Authenticator (<code>authenticator</code>)</strong> – Authenticator logs are unique to Amazon EKS. These logs represent the control plane component that Amazon EKS uses for Kubernetes <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/" target="_blank" rel="noopener noreferrer">Role Based Access Control</a> (RBAC) authentication using IAM credentials. For more information, see <a href="https://docs.aws.amazon.com/eks/latest/userguide/eks-managing.html" target="_blank" rel="noopener noreferrer">Cluster management</a>.</li>
<li><strong>Controller manager (<code>controllerManager</code>)</strong> – The controller manager manages the core control loops that are shipped with Kubernetes. For more information, see <a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-controller-manager/" target="_blank" rel="noopener noreferrer">kube-controller-manager</a> in the Kubernetes documentation.</li>
<li><strong>Scheduler (<code>scheduler</code>)</strong> – The scheduler component manages when and where to run pods in your cluster. For more information, see <a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-scheduler/" target="_blank" rel="noopener noreferrer">kube-scheduler</a> in the Kubernetes documentation.</li>
</ul>
<p>Please follow <a href="https://docs.aws.amazon.com/eks/latest/userguide/control-plane-logs.html#:~:text=the%20Kubernetes%20documentation.-,Enabling%20and%20disabling%20control%20plane%20logs,-By%20default%2C%20cluster" target="_blank" rel="noopener noreferrer">enabling and disabling control plane logs</a> section and enable control plane logs via AWS console or via AWS CLI.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="querying-control-plane-logs-from-cloudwatch-console">Querying control plane logs from CloudWatch console<a class="hash-link" aria-label="Direct link to Querying control plane logs from CloudWatch console" title="Direct link to Querying control plane logs from CloudWatch console" href="/observability-best-practices/docs/guides/containers/aws-native/eks/log-aggregation#querying-control-plane-logs-from-cloudwatch-console">​</a></h4>
<p>After you enable control plane logging on your Amazon EKS cluster, you can find EKS control plane logs in the <code>/aws/eks/cluster-name/cluster</code> log group. For more information, see <a href="https://docs.aws.amazon.com/eks/latest/userguide/control-plane-logs.html#viewing-control-plane-logs" target="_blank" rel="noopener noreferrer">Viewing cluster control plane logs</a>. Please make sure to replace <code>cluster-name</code> with your cluster&#x27;s name.</p>
<p>You can use CloudWatch Logs Insights to search through the EKS control plane log data. For more information, see <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/AnalyzingLogData.html" target="_blank" rel="noopener noreferrer">Analyzing log data with CloudWatch Insights</a>. It is important to node that, you can view log events in CloudWatch Logs only after you turn on control plane logging in a cluster. Before you select a time range to run queries in CloudWatch Logs Insights, verify that you turned on control plane logging. Please check the screenshot below showing an example of a EKS control plane log query with query output.</p>
<p><img decoding="async" loading="lazy" alt="LOG-AGGREG-1" src="/observability-best-practices/assets/images/log-aggreg-1-d56eabe20f149270bb73c9bb01044805.jpg" width="1522" height="644" class="img_ev3q"></p>
<p><em>Figure: CloudWatch Logs Insights.</em></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="sample-queries-for-common-eks-use-cases-on-cloudwatch-logs-insights">Sample queries for common EKS use cases on CloudWatch Logs Insights<a class="hash-link" aria-label="Direct link to Sample queries for common EKS use cases on CloudWatch Logs Insights" title="Direct link to Sample queries for common EKS use cases on CloudWatch Logs Insights" href="/observability-best-practices/docs/guides/containers/aws-native/eks/log-aggregation#sample-queries-for-common-eks-use-cases-on-cloudwatch-logs-insights">​</a></h4>
<p>To find the cluster creator, search for the IAM entity that&#x27;s mapped to the <strong>kubernetes-admin</strong> user.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">fields @logStream, @timestamp, @message| sort @timestamp desc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| filter @logStream like /authenticator/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| filter @message like &quot;username=kubernetes-admin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| limit 50</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Example output:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@logStream, @timestamp @messageauthenticator-71976 ca11bea5d3083393f7d32dab75b,2021-08-11-10:09:49.020,&quot;time=&quot;&quot;2021-08-11T10:09:43Z&quot;&quot; level=info msg=&quot;&quot;access granted&quot;&quot; arn=&quot;&quot;arn:aws:iam::12345678910:user/awscli&quot;&quot; client=&quot;&quot;127.0.0.1:51326&quot;&quot; groups=&quot;&quot;[system:masters]&quot;&quot; method=POST path=/authenticate sts=sts.eu-west-1.amazonaws.com uid=&quot;&quot;heptio-authenticator-aws:12345678910:ABCDEFGHIJKLMNOP&quot;&quot; username=kubernetes-admin&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this output, IAM user <strong>arn:aws:iam::<a href="tel:12345678910" target="_blank" rel="noopener noreferrer">12345678910</a>:user<!-- -->/awscli</strong> is mapped to user <strong>kubernetes-admin</strong>.</p>
<p>To find requests that a specific user performed, search for operations that the <strong>kubernetes-admin</strong> user performed.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fields @logStream, @timestamp, @message| filter @logStream like /^kube-apiserver-audit/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| filter strcontains(user.username,&quot;kubernetes-admin&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| sort @timestamp desc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| limit 50</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Example output:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@logStream,@timestamp,@messagekube-apiserver-audit-71976ca11bea5d3083393f7d32dab75b,2021-08-11 09:29:13.095,&quot;{...&quot;&quot;requestURI&quot;&quot;:&quot;&quot;/api/v1/namespaces/kube-system/endpoints?limit=500&quot;;&quot;,&quot;string&quot;&quot;verb&quot;&quot;:&quot;&quot;list&quot;&quot;,&quot;&quot;user&quot;&quot;:{&quot;&quot;username&quot;&quot;:&quot;&quot;kubernetes-admin&quot;&quot;,&quot;&quot;uid&quot;&quot;:&quot;&quot;heptio-authenticator-aws:12345678910:ABCDEFGHIJKLMNOP&quot;&quot;,&quot;&quot;groups&quot;&quot;:[&quot;&quot;system:masters&quot;&quot;,&quot;&quot;system:authenticated&quot;&quot;],&quot;&quot;extra&quot;&quot;:{&quot;&quot;accessKeyId&quot;&quot;:[&quot;&quot;ABCDEFGHIJKLMNOP&quot;&quot;],&quot;&quot;arn&quot;&quot;:[&quot;&quot;arn:aws:iam::12345678910:user/awscli&quot;&quot;],&quot;&quot;canonicalArn&quot;&quot;:[&quot;&quot;arn:aws:iam::12345678910:user/awscli&quot;&quot;],&quot;&quot;sessionName&quot;&quot;:[&quot;&quot;&quot;&quot;]}},&quot;&quot;sourceIPs&quot;&quot;:[&quot;&quot;12.34.56.78&quot;&quot;],&quot;&quot;userAgent&quot;&quot;:&quot;&quot;kubectl/v1.22.0 (darwin/amd64) kubernetes/c2b5237&quot;&quot;,&quot;&quot;objectRef&quot;&quot;:{&quot;&quot;resource&quot;&quot;:&quot;&quot;endpoints&quot;&quot;,&quot;&quot;namespace&quot;&quot;:&quot;&quot;kube-system&quot;&quot;,&quot;&quot;apiVersion&quot;&quot;:&quot;&quot;v1&quot;&quot;}...}&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To find API calls that a specific userAgent made, you can use this example query:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fields @logStream, @timestamp, userAgent, verb, requestURI, @message| filter @logStream like /kube-apiserver-audit/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| filter userAgent like /kubectl\/v1.22.0/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| sort @timestamp desc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| filter verb like /(get)/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Shortened example output:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@logStream,@timestamp,userAgent,verb,requestURI,@messagekube-apiserver-audit-71976ca11bea5d3083393f7d32dab75b,2021-08-11 14:06:47.068,kubectl/v1.22.0 (darwin/amd64) kubernetes/c2b5237,get,/apis/metrics.k8s.io/v1beta1?timeout=32s,&quot;{&quot;&quot;kind&quot;&quot;:&quot;&quot;Event&quot;&quot;,&quot;&quot;apiVersion&quot;&quot;:&quot;&quot;audit.k8s.io/v1&quot;&quot;,&quot;&quot;level&quot;&quot;:&quot;&quot;Metadata&quot;&quot;,&quot;&quot;auditID&quot;&quot;:&quot;&quot;863d9353-61a2-4255-a243-afaeb9183524&quot;&quot;,&quot;&quot;stage&quot;&quot;:&quot;&quot;ResponseComplete&quot;&quot;,&quot;&quot;requestURI&quot;&quot;:&quot;&quot;/apis/metrics.k8s.io/v1beta1?timeout=32s&quot;&quot;,&quot;&quot;verb&quot;&quot;:&quot;&quot;get&quot;&quot;,&quot;&quot;user&quot;&quot;:{&quot;&quot;username&quot;&quot;:&quot;&quot;kubernetes-admin&quot;&quot;,&quot;&quot;uid&quot;&quot;:&quot;&quot;heptio-authenticator-aws:12345678910:AIDAUQGC5HFOHXON7M22F&quot;&quot;,&quot;&quot;groups&quot;&quot;:[&quot;&quot;system:masters&quot;&quot;,&quot;&quot;system:authenticated&quot;&quot;],&quot;&quot;extra&quot;&quot;:{&quot;&quot;accessKeyId&quot;&quot;:[&quot;&quot;ABCDEFGHIJKLMNOP&quot;&quot;],&quot;&quot;arn&quot;&quot;:[&quot;&quot;arn:aws:iam::12345678910:user/awscli&quot;&quot;],&quot;&quot;canonicalArn&quot;&quot;:[&quot;&quot;arn:aws:iam::12345678910:user/awscli&quot;&quot;],&quot;&quot;sourceIPs&quot;&quot;:[&quot;&quot;12.34.56.78&quot;&quot;],&quot;&quot;userAgent&quot;&quot;:&quot;&quot;kubectl/v1.22.0 (darwin/amd64) kubernetes/c2b5237&quot;&quot;...}&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To find mutating changes made to the <strong>aws-auth</strong> ConfigMap, you can use this example query:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fields @logStream, @timestamp, @message| filter @logStream like /^kube-apiserver-audit/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| filter requestURI like /\/api\/v1\/namespaces\/kube-system\/configmaps/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| filter objectRef.name = &quot;aws-auth&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| filter verb like /(create|delete|patch)/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| sort @timestamp desc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| limit 50</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Shortened example output:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@logStream,@timestamp,@messagekube-apiserver-audit-f01c77ed8078a670a2eb63af6f127163,2021-10-27 05:43:01.850,{&quot;&quot;kind&quot;&quot;:&quot;&quot;Event&quot;&quot;,&quot;&quot;apiVersion&quot;&quot;:&quot;&quot;audit.k8s.io/v1&quot;&quot;,&quot;&quot;level&quot;&quot;:&quot;&quot;RequestResponse&quot;&quot;,&quot;&quot;auditID&quot;&quot;:&quot;&quot;8f9a5a16-f115-4bb8-912f-ee2b1d737ff1&quot;&quot;,&quot;&quot;stage&quot;&quot;:&quot;&quot;ResponseComplete&quot;&quot;,&quot;&quot;requestURI&quot;&quot;:&quot;&quot;/api/v1/namespaces/kube-system/configmaps/aws-auth?timeout=19s&quot;&quot;,&quot;&quot;verb&quot;&quot;:&quot;&quot;patch&quot;&quot;,&quot;&quot;responseStatus&quot;&quot;: {&quot;&quot;metadata&quot;&quot;: {},&quot;&quot;code&quot;&quot;: 200 },&quot;&quot;requestObject&quot;&quot;: {&quot;&quot;data&quot;&quot;: { contents of aws-auth ConfigMap } },&quot;&quot;requestReceivedTimestamp&quot;&quot;:&quot;&quot;2021-10-27T05:43:01.033516Z&quot;&quot;,&quot;&quot;stageTimestamp&quot;&quot;:&quot;&quot;2021-10-27T05:43:01.042364Z&quot;&quot; }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To find requests that were denied, you can use this example query:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fields @logStream, @timestamp, @message| filter @logStream like /^authenticator/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| filter @message like &quot;denied&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| sort @timestamp desc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| limit 50</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Example output:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@logStream,@timestamp,@messageauthenticator-8c0c570ea5676c62c44d98da6189a02b,2021-08-08 20:04:46.282,&quot;time=&quot;&quot;2021-08-08T20:04:44Z&quot;&quot; level=warning msg=&quot;&quot;access denied&quot;&quot; client=&quot;&quot;127.0.0.1:52856&quot;&quot; error=&quot;&quot;sts getCallerIdentity failed: error from AWS (expected 200, got 403)&quot;&quot; method=POST path=/authenticate&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To find the node that a pod was scheduled on, query the <strong>kube-scheduler</strong> logs.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fields @logStream, @timestamp, @message| sort @timestamp desc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| filter @logStream like /kube-scheduler/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| filter @message like &quot;aws-6799fc88d8-jqc2r&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| limit 50</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Example output:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@logStream,@timestamp,@messagekube-scheduler-bb3ea89d63fd2b9735ba06b144377db6,2021-08-15 12:19:43.000,&quot;I0915 12:19:43.933124       1 scheduler.go:604] &quot;&quot;Successfully bound pod to node&quot;&quot; pod=&quot;&quot;kube-system/aws-6799fc88d8-jqc2r&quot;&quot; node=&quot;&quot;ip-192-168-66-187.eu-west-1.compute.internal&quot;&quot; evaluatedNodes=3 feasibleNodes=2&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this example output, pod <strong>aws-6799fc88d8-jqc2r</strong> was scheduled on node <strong>ip-192-168-66-187.eu-west-1.compute.internal</strong>.</p>
<p>To find HTTP 5xx server errors for Kubernetes API server requests, you can use this example query:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fields @logStream, @timestamp, responseStatus.code, @message| filter @logStream like /^kube-apiserver-audit/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| filter responseStatus.code &gt;= 500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| limit 50</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Shortened example output:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@logStream,@timestamp,responseStatus.code,@messagekube-apiserver-audit-4d5145b53c40d10c276ad08fa36d1f11,2021-08-04 07:22:06.518,503,&quot;...&quot;&quot;requestURI&quot;&quot;:&quot;&quot;/apis/metrics.k8s.io/v1beta1?timeout=32s&quot;&quot;,&quot;&quot;verb&quot;&quot;:&quot;&quot;get&quot;&quot;,&quot;&quot;user&quot;&quot;:{&quot;&quot;username&quot;&quot;:&quot;&quot;system:serviceaccount:kube-system:resourcequota-controller&quot;&quot;,&quot;&quot;uid&quot;&quot;:&quot;&quot;36d9c3dd-f1fd-4cae-9266-900d64d6a754&quot;&quot;,&quot;&quot;groups&quot;&quot;:[&quot;&quot;system:serviceaccounts&quot;&quot;,&quot;&quot;system:serviceaccounts:kube-system&quot;&quot;,&quot;&quot;system:authenticated&quot;&quot;]},&quot;&quot;sourceIPs&quot;&quot;:[&quot;&quot;12.34.56.78&quot;&quot;],&quot;&quot;userAgent&quot;&quot;:&quot;&quot;kube-controller-manager/v1.21.2 (linux/amd64) kubernetes/d2965f0/system:serviceaccount:kube-system:resourcequota-controller&quot;&quot;,&quot;&quot;responseStatus&quot;&quot;:{&quot;&quot;metadata&quot;&quot;:{},&quot;&quot;code&quot;&quot;:503},...&quot;}}&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To troubleshoot a CronJob activation, search for API calls that the <strong>cronjob-controller</strong> made.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fields @logStream, @timestamp, @message| filter @logStream like /kube-apiserver-audit/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| filter user.username like &quot;system:serviceaccount:kube-system:cronjob-controller&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| display @logStream, @timestamp, @message, objectRef.namespace, objectRef.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| sort @timestamp desc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| limit 50</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Shortened example output:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{ &quot;kind&quot;: &quot;Event&quot;, &quot;apiVersion&quot;: &quot;audit.k8s.io/v1&quot;, &quot;objectRef&quot;: { &quot;resource&quot;: &quot;cronjobs&quot;, &quot;namespace&quot;: &quot;default&quot;, &quot;name&quot;: &quot;hello&quot;, &quot;apiGroup&quot;: &quot;batch&quot;, &quot;apiVersion&quot;: &quot;v1&quot; }, &quot;responseObject&quot;: { &quot;kind&quot;: &quot;CronJob&quot;, &quot;apiVersion&quot;: &quot;batch/v1&quot;, &quot;spec&quot;: { &quot;schedule&quot;: &quot;*/1 * * * *&quot; }, &quot;status&quot;: { &quot;lastScheduleTime&quot;: &quot;2021-08-09T07:19:00Z&quot; } } }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this example output, the <strong>hello</strong> job in the <strong>default</strong> namespace runs every minute and was last scheduled at <strong>2021-08-09T07:19:00Z</strong>.</p>
<p>To find API calls that the <strong>replicaset-controller</strong> made, you can use this example query:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fields @logStream, @timestamp, @message| filter @logStream like /kube-apiserver-audit/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| filter user.username like &quot;system:serviceaccount:kube-system:replicaset-controller&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| display @logStream, @timestamp, requestURI, verb, user.username</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| sort @timestamp desc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| limit 50</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Example output:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@logStream,@timestamp,requestURI,verb,user.usernamekube-apiserver-audit-8c0c570ea5676c62c44d98da6189a02b,2021-08-10 17:13:53.281,/api/v1/namespaces/kube-system/pods,create,system:serviceaccount:kube-system:replicaset-controller</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-apiserver-audit-4d5145b53c40d10c276ad08fa36d1f11,2021-08-04 0718:44.561,/apis/apps/v1/namespaces/kube-system/replicasets/coredns-6496b6c8b9/status,update,system:serviceaccount:kube-system:replicaset-controller</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To find operations that are made against a Kubernetes resource, you can use this example query:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fields @logStream, @timestamp, @message| filter @logStream like /^kube-apiserver-audit/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| filter verb == &quot;delete&quot; and requestURI like &quot;/api/v1/namespaces/default/pods/my-app&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| sort @timestamp desc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| limit 10</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The preceding example query filters for <strong>delete</strong> API calls on the <strong>default</strong> namespace for pod <strong>my-app</strong>.
Shortened example output:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@logStream,@timestamp,@messagekube-apiserver-audit-e7b3cb08c0296daf439493a6fc9aff8c,2021-08-11 14:09:47.813,&quot;...&quot;&quot;requestURI&quot;&quot;:&quot;&quot;/api/v1/namespaces/default/pods/my-app&quot;&quot;,&quot;&quot;verb&quot;&quot;:&quot;&quot;delete&quot;&quot;,&quot;&quot;user&quot;&quot;:{&quot;&quot;username&quot;&quot;&quot;&quot;kubernetes-admin&quot;&quot;,&quot;&quot;uid&quot;&quot;:&quot;&quot;heptio-authenticator-aws:12345678910:ABCDEFGHIJKLMNOP&quot;&quot;,&quot;&quot;groups&quot;&quot;:[&quot;&quot;system:masters&quot;&quot;,&quot;&quot;system:authenticated&quot;&quot;],&quot;&quot;extra&quot;&quot;:{&quot;&quot;accessKeyId&quot;&quot;:[&quot;&quot;ABCDEFGHIJKLMNOP&quot;&quot;],&quot;&quot;arn&quot;&quot;:[&quot;&quot;arn:aws:iam::12345678910:user/awscli&quot;&quot;],&quot;&quot;canonicalArn&quot;&quot;:[&quot;&quot;arn:aws:iam::12345678910:user/awscli&quot;&quot;],&quot;&quot;sessionName&quot;&quot;:[&quot;&quot;&quot;&quot;]}},&quot;&quot;sourceIPs&quot;&quot;:[&quot;&quot;12.34.56.78&quot;&quot;],&quot;&quot;userAgent&quot;&quot;:&quot;&quot;kubectl/v1.22.0 (darwin/amd64) kubernetes/c2b5237&quot;&quot;,&quot;&quot;objectRef&quot;&quot;:{&quot;&quot;resource&quot;&quot;:&quot;&quot;pods&quot;&quot;,&quot;&quot;namespace&quot;&quot;:&quot;&quot;default&quot;&quot;,&quot;&quot;name&quot;&quot;:&quot;&quot;my-app&quot;&quot;,&quot;&quot;apiVersion&quot;&quot;:&quot;&quot;v1&quot;&quot;},&quot;&quot;responseStatus&quot;&quot;:{&quot;&quot;metadata&quot;&quot;:{},&quot;&quot;code&quot;&quot;:200},&quot;&quot;requestObject&quot;&quot;:{&quot;&quot;kind&quot;&quot;:&quot;&quot;DeleteOptions&quot;&quot;,&quot;&quot;apiVersion&quot;&quot;:&quot;&quot;v1&quot;&quot;,&quot;&quot;propagationPolicy&quot;&quot;:&quot;&quot;Background&quot;&quot;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To retrieve a count of HTTP response codes for calls made to the Kubernetes API server, you can use this example query:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fields @logStream, @timestamp, @message| filter @logStream like /^kube-apiserver-audit/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| stats count(*) as count by responseStatus.code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| sort count desc</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Example output:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">responseStatus.code,count200,35066</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">201,525</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">403,125</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">404,116</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">101,2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To find changes that are made to DaemonSets/Addons in the <strong>kube-system</strong> namespace, you can use this example query:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter @logStream like /^kube-apiserver-audit/| fields @logStream, @timestamp, @message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| filter verb like /(create|update|delete)/ and strcontains(requestURI,&quot;/apis/apps/v1/namespaces/kube-system/daemonsets&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| sort @timestamp desc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| limit 50</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Example output:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{ &quot;kind&quot;: &quot;Event&quot;, &quot;apiVersion&quot;: &quot;audit.k8s.io/v1&quot;, &quot;level&quot;: &quot;RequestResponse&quot;, &quot;auditID&quot;: &quot;93e24148-0aa6-4166-8086-a689b0031612&quot;, &quot;stage&quot;: &quot;ResponseComplete&quot;, &quot;requestURI&quot;: &quot;/apis/apps/v1/namespaces/kube-system/daemonsets/aws-node?fieldManager=kubectl-set&quot;, &quot;verb&quot;: &quot;patch&quot;, &quot;user&quot;: { &quot;username&quot;: &quot;kubernetes-admin&quot;, &quot;groups&quot;: [ &quot;system:masters&quot;, &quot;system:authenticated&quot; ] }, &quot;userAgent&quot;: &quot;kubectl/v1.22.2 (darwin/amd64) kubernetes/8b5a191&quot;, &quot;objectRef&quot;: { &quot;resource&quot;: &quot;daemonsets&quot;, &quot;namespace&quot;: &quot;kube-system&quot;, &quot;name&quot;: &quot;aws-node&quot;, &quot;apiGroup&quot;: &quot;apps&quot;, &quot;apiVersion&quot;: &quot;v1&quot; }, &quot;requestObject&quot;: { &quot;REDACTED&quot;: &quot;REDACTED&quot; }, &quot;requestReceivedTimestamp&quot;: &quot;2021-08-09T08:07:21.868376Z&quot;, &quot;stageTimestamp&quot;: &quot;2021-08-09T08:07:21.883489Z&quot;, &quot;annotations&quot;: { &quot;authorization.k8s.io/decision&quot;: &quot;allow&quot;, &quot;authorization.k8s.io/reason&quot;: &quot;&quot; } }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this example output, the <strong>kubernetes-admin</strong> user used <strong>kubectl</strong> v1.22.2 to patch the <strong>aws-node</strong> DaemonSet.</p>
<p>To find the user that deleted a node, you can use this example query:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fields @logStream, @timestamp, @message| filter @logStream like /^kube-apiserver-audit/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| filter verb == &quot;delete&quot; and requestURI like &quot;/api/v1/nodes&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| sort @timestamp desc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| limit 10</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Shortened example output:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@logStream,@timestamp,@messagekube-apiserver-audit-e503271cd443efdbd2050ae8ca0794eb,2022-03-25 07:26:55.661,&quot;{&quot;kind&quot;:&quot;Event&quot;,&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Finally, if you have started using control plane logging feature, we would highly recommend you to learn more about <a href="https://aws.amazon.com/blogs/containers/understanding-and-cost-optimizing-amazon-eks-control-plane-logs/" target="_blank" rel="noopener noreferrer">Understanding and Cost Optimizing Amazon EKS Control Plane Logs</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="amazon-eks-data-plane-logging">Amazon EKS data plane logging<a class="hash-link" aria-label="Direct link to Amazon EKS data plane logging" title="Direct link to Amazon EKS data plane logging" href="/observability-best-practices/docs/guides/containers/aws-native/eks/log-aggregation#amazon-eks-data-plane-logging">​</a></h3>
<p>We recommend that you use <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/Container-Insights-setup-logs.html" target="_blank" rel="noopener noreferrer">CloudWatch Container Insights</a> to capture logs and metrics for Amazon EKS. <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/ContainerInsights.html" target="_blank" rel="noopener noreferrer">Container Insights</a> implements cluster, node, and pod-level metrics with the CloudWatch agent, and <a href="https://fluentbit.io/" target="_blank" rel="noopener noreferrer">Fluent Bit</a> or <a href="https://www.fluentd.org/" target="_blank" rel="noopener noreferrer">Fluentd</a> for log capture to CloudWatch. Container Insights also provides automatic dashboards with layered views of your captured CloudWatch metrics. Container Insights is deployed as CloudWatch DaemonSet and Fluent Bit DaemonSet that runs on every Amazon EKS node. Fargate nodes are not supported by Container Insights because the nodes are managed by AWS and don’t support DaemonSets. Fargate logging for Amazon EKS is covered separately in this guide.</p>
<p>The following table shows the CloudWatch log groups and logs captured by the <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/Container-Insights-setup-logs-FluentBit.html" target="_blank" rel="noopener noreferrer">default Fluentd or Fluent Bit log capture configuration</a> for Amazon EKS.</p>
<table><thead><tr><th><code>/aws/containerinsights/Cluster_Name/host</code></th><th>Logs from <code>/var/log/dmesg</code>, <code>/var/log/secure</code>, and <code>/var/log/messages</code>.</th></tr></thead><tbody><tr><td><code>/aws/containerinsights/Cluster_Name/dataplane</code></td><td>The logs in <code>/var/log/journal</code> for <code>kubelet.service</code>, <code>kubeproxy.service</code>, and <code>docker.service</code>.</td></tr></tbody></table>
<p>If you don’t want to use Container Insights with Fluent Bit or Fluentd for logging, you can capture node and container logs with the CloudWatch agent installed on Amazon EKS nodes. Amazon EKS nodes are EC2 instances, which means you should include them in your standard system-level logging approach for Amazon EC2. If you install the CloudWatch agent using Distributor and State Manager, then Amazon EKS nodes are also included in the CloudWatch agent installation, configuration, and update. The following table shows logs that are specific to Kubernetes and that you must capture if you aren’t using Container Insights with Fluent Bit or Fluentd for logging.</p>
<table><thead><tr><th><code>var/log/aws-routed-eni/ipamd.log``/var/log/aws-routed-eni/plugin.log</code></th><th>The logs for the L-IPAM daemon can be found here</th></tr></thead></table>
<p>Please reference <a href="https://docs.aws.amazon.com/prescriptive-guidance/latest/implementing-logging-monitoring-cloudwatch/kubernetes-eks-logging.html" target="_blank" rel="noopener noreferrer">Amazon EKS node logging prescriptive guidance</a> to learn more about data plane logging.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="amazon-eks-application-logging">Amazon EKS application logging<a class="hash-link" aria-label="Direct link to Amazon EKS application logging" title="Direct link to Amazon EKS application logging" href="/observability-best-practices/docs/guides/containers/aws-native/eks/log-aggregation#amazon-eks-application-logging">​</a></h3>
<p>Amazon EKS application logging becomes inevitable while running applications at scale in Kubernetes environment. To collect application logs you must install a log aggregator, such as <a href="https://fluentbit.io/" target="_blank" rel="noopener noreferrer">Fluent Bit</a>, <a href="https://www.fluentd.org/" target="_blank" rel="noopener noreferrer">Fluentd</a>, or <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/ContainerInsights.html" target="_blank" rel="noopener noreferrer">CloudWatch Container Insights</a>, in your Amazon EKS cluster.</p>
<p><a href="https://fluentbit.io/" target="_blank" rel="noopener noreferrer">Fluent Bit</a> is an open-source log processor and forwarder that is written in C++, which means that you can collect data from different sources, enrich them with filters, and send them to multiple destinations. By using this guide&#x27;s solution you can enable <code>aws-for-fluent-bit</code> or <code>fargate-fluentbit</code> for logging. <a href="https://www.fluentd.org/" target="_blank" rel="noopener noreferrer">Fluentd</a> is an open-source data collector for unified logging layer and written in Ruby. Fluentd acts as a unified logging layer that can aggregate data from multiple sources, unify data with different formats into JSON-formatted objects, and route them to different output destinations. Choosing a log collector is important for CPU and memory utilization when you monitor thousands of servers. If you have multiple Amazon EKS clusters, you can use Fluent Bit as a lightweight shipper to collect data from different nodes in the cluster and forward it to Fluentd for aggregation, processing and routing to a supported output destination.</p>
<p>We recommend to use Fluent Bit as the log collector and forwarder to send application and cluster logs to CloudWatch. You can then stream the logs to Amazon OpenSearch Service by using a subscription filter in CloudWatch. This option is shown in this section&#x27;s architecture diagram.</p>
<p><img decoding="async" loading="lazy" alt="LOG-AGGREG-2" src="/observability-best-practices/assets/images/log-aggreg-2-00f7a9a952c2a1d217a6c668bad25d47.jpg" width="1280" height="720" class="img_ev3q"></p>
<p><em>Figure: Amazon EKS application logging architecture.</em></p>
<p>The diagram shows the following workflow when application logs from Amazon EKS clusters are streamed to Amazon OpenSearch Service. The Fluent Bit service in the Amazon EKS cluster pushes the logs to CloudWatch. The AWS Lambda function streams the logs to Amazon OpenSearch Service using a subscription filter. You can then use Kibana to visualize the logs in the configured indexes. You can also stream logs by using Amazon Kinesis Data Firehose and store them in an S3 bucket for analysis and querying with <a href="https://docs.aws.amazon.com/athena/latest/ug/what-is.html" target="_blank" rel="noopener noreferrer">Amazon Athena</a>.</p>
<p>In most clusters, using Fluentd or Fluent Bit for log aggregation needs little optimization. This changes when you’re dealing with larger clusters with thousands of pods and nodes. We have published our findings from studying the <a href="https://aws.amazon.com/blogs/containers/fluentd-considerations-and-actions-required-at-scale-in-amazon-eks/" target="_blank" rel="noopener noreferrer">impact of Fluentd and Fluent Bit in clusters with thousands of pods</a>. For further learning, we would recommend you to check on <a href="https://aws.amazon.com/blogs/containers/capturing-logs-at-scale-with-fluent-bit-and-amazon-eks/" target="_blank" rel="noopener noreferrer">enhancement to Fluent Bit that is designed to reduce the volume API calls</a> it makes to the Kubernetes API servers using <em>Use_Kubelet</em> option. This Fluent Bit’s <code>Use_Kubelet</code> feature allows it to retrieve pod metadata from the kubelet on the host. Amazon EKS customers can use Fluent Bit to capture logs in clusters that run tens of thousands of pods with this feature enabled without overloading the Kubernetes API server. We recommend enabling the feature even if you aren’t running a large Kubernetes cluster.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="logging-for-amazon-eks-on-fargate">Logging for Amazon EKS on Fargate<a class="hash-link" aria-label="Direct link to Logging for Amazon EKS on Fargate" title="Direct link to Logging for Amazon EKS on Fargate" href="/observability-best-practices/docs/guides/containers/aws-native/eks/log-aggregation#logging-for-amazon-eks-on-fargate">​</a></h4>
<p>With Amazon EKS on Fargate, you can deploy pods without allocating or managing your Kubernetes nodes. This removes the need to capture system-level logs for your Kubernetes nodes. To capture the logs from your Fargate pods, you can use Fluent Bit to forward the logs directly to CloudWatch. This enables you to automatically route logs to CloudWatch without further configuration or a sidecar container for your Amazon EKS pods on Fargate. For more information about this, see <a href="https://docs.aws.amazon.com/eks/latest/userguide/fargate-logging.html" target="_blank" rel="noopener noreferrer">Fargate logging</a> in the Amazon EKS documentation and <a href="http://aws.amazon.com/blogs/containers/fluent-bit-for-amazon-eks-on-aws-fargate-is-here/" target="_blank" rel="noopener noreferrer">Fluent Bit for Amazon EKS</a> on the AWS Blog. This solution captures the <code>STDOUT</code> and <code>STDERR</code> input/output (I/O) streams from your container and sends them to CloudWatch through Fluent Bit, based on the Fluent Bit configuration established for the Amazon EKS cluster on Fargate.</p>
<p>With Fluent Bit support for Amazon EKS, you no longer need to run a sidecar to route container logs from Amazon EKS pods running on Fargate. With the new built-in logging support, you can select a destination of your choice to send the records to. Amazon EKS on Fargate uses a version of Fluent Bit for AWS, an upstream conformant distribution of Fluent Bit managed by AWS.</p>
<p><img decoding="async" loading="lazy" alt="LOG-AGGREG-3" src="/observability-best-practices/assets/images/log-aggreg-3-528257eb46bf1bbbc7f6df093780daa1.jpg" width="412" height="397" class="img_ev3q"></p>
<p><em>Figure: Logging for Amazon EKS on Fargate.</em></p>
<p>Please learn more about Fluent Bit support for Amazon EKS see <a href="https://docs.aws.amazon.com/eks/latest/userguide/fargate-logging.html" target="_blank" rel="noopener noreferrer">Fargate logging</a> in the Amazon EKS documentation.</p>
<p>For some reasons, for pods running on AWS Fargate where you need to use the sidecar pattern. You can run a Fluentd (or <a href="http://fluentbit.io/" target="_blank" rel="noopener noreferrer">Fluent Bit</a>) sidecar container to capture logs produced by your applications. This option requires that the application writes logs to filesystem instead of <code>stdout</code> or <code>stderr</code>. A consequence of this approach is that you will not be able use <code>kubectl</code> logs to view container logs. To make logs appear in <code>kubectl logs</code>, you can write application logs to both <code>stdout</code> and filesystem simultaneously.</p>
<p><a href="https://docs.aws.amazon.com/eks/latest/userguide/fargate-pod-configuration.html" target="_blank" rel="noopener noreferrer">Pods on Fargate get 20GB of ephemeral storage</a>, which is available to all the containers that belong to a pod. You can configure your application to write logs to the local filesystem and instruct Fluentd to watch the log directory (or file). Fluentd will read events from the tail of log files and send the events to a destination like CloudWatch for storage. Ensure that you rotate logs regularly to prevent logs from usurping the entire volume.</p>
<p>Please learn more about <a href="https://aws.amazon.com/blogs/containers/how-to-capture-application-logs-when-using-amazon-eks-on-aws-fargate/" target="_blank" rel="noopener noreferrer">How to capture application logs when using Amazon EKS on AWS Fargate</a> to operate and observe your kubernets applications at scale on AWS Fargate. We will also <code>tee</code> write to file and <code>stdout</code> so we see logs in <code>kubectl logs</code> in this approach.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="unified-log-aggregation-from-amazon-eks-and-other-compute-platforms-using-aws-native-services">Unified log aggregation from Amazon EKS and other compute platforms using AWS Native services<a class="hash-link" aria-label="Direct link to Unified log aggregation from Amazon EKS and other compute platforms using AWS Native services" title="Direct link to Unified log aggregation from Amazon EKS and other compute platforms using AWS Native services" href="/observability-best-practices/docs/guides/containers/aws-native/eks/log-aggregation#unified-log-aggregation-from-amazon-eks-and-other-compute-platforms-using-aws-native-services">​</a></h3>
<p>Customers these days want to  unify and centralize logs across different computing platforms such as <a href="https://aws.amazon.com/eks/" target="_blank" rel="noopener noreferrer">Amazon Elastic Kubernetes Service</a> (Amazon EKS), <a href="https://aws.amazon.com/ec2/" target="_blank" rel="noopener noreferrer">Amazon Elastic Compute Cloud</a> (Amazon EC2), <a href="https://aws.amazon.com/ecs/" target="_blank" rel="noopener noreferrer">Amazon Elastic Container Service</a> (Amazon ECS), <a href="https://aws.amazon.com/kinesis/data-firehose/" target="_blank" rel="noopener noreferrer">Amazon Kinesis Data Firehose</a>, and <a href="https://aws.amazon.com/lambda/" target="_blank" rel="noopener noreferrer">AWS Lambda</a> using agents, log routers, and extensions. We can then use <a href="https://aws.amazon.com/opensearch-service/" target="_blank" rel="noopener noreferrer">Amazon OpenSearch Service</a> with OpenSearch Dashboards to visualize and analyze the logs, collected across different computing platforms to get application insights.</p>
<p>A unified aggregated log system provides the following benefits:</p>
<ul>
<li>A single point of access to all the logs across different computing platforms</li>
<li>Help defining and standardizing the transformations of logs before they get delivered to downstream systems like <a href="http://aws.amazon.com/s3" target="_blank" rel="noopener noreferrer">Amazon Simple Storage Service</a> (Amazon S3), Amazon OpenSearch Service, <a href="https://aws.amazon.com/redshift" target="_blank" rel="noopener noreferrer">Amazon Redshift</a>, and other services</li>
<li>The ability to use Amazon OpenSearch Service to quickly index, and OpenSearch Dashboards to search and visualize logs from its routers, applications, and other devices</li>
</ul>
<p>The following diagram shows the architecture which performs log aggregation across different compute platforms such as  <a href="https://aws.amazon.com/eks/" target="_blank" rel="noopener noreferrer">Amazon Elastic Kubernetes Service</a> (Amazon EKS), <a href="https://aws.amazon.com/ec2/" target="_blank" rel="noopener noreferrer">Amazon Elastic Compute Cloud</a> (Amazon EC2), <a href="https://aws.amazon.com/ecs/" target="_blank" rel="noopener noreferrer">Amazon Elastic Container Service</a> (Amazon ECS),and <a href="https://aws.amazon.com/lambda/" target="_blank" rel="noopener noreferrer">AWS Lambda</a>.</p>
<p><img decoding="async" loading="lazy" alt="LOG-AGGREG-4" src="/observability-best-practices/assets/images/log-aggreg-4-f1dfa866696f7a94c7790d6ee508bb31.jpg" width="1106" height="691" class="img_ev3q"></p>
<p><em>Figure: Log aggregation across different compute platforms.</em></p>
<p>The architecture uses various log aggregation tools such as log agents, log routers, and Lambda extensions to collect logs from multiple compute platforms and deliver them to Kinesis Data Firehose. Kinesis Data Firehose streams the logs to Amazon OpenSearch Service. Log records that fail to get persisted in Amazon OpenSearch service will get written to AWS S3. To scale this architecture, each of these compute platforms streams the logs to a different Firehose delivery stream, added as a separate index, and rotated every 24 hours.</p>
<p>For further learning check on <a href="https://aws.amazon.com/blogs/big-data/unify-log-aggregation-and-analytics-across-compute-platforms/" target="_blank" rel="noopener noreferrer">how to unify and centralize logs across different compute platforms</a> such as <a href="https://aws.amazon.com/eks/" target="_blank" rel="noopener noreferrer">Amazon Elastic Kubernetes Service</a> (Amazon EKS), <a href="https://aws.amazon.com/ec2/" target="_blank" rel="noopener noreferrer">Amazon Elastic Compute Cloud</a> (Amazon EC2), <a href="https://aws.amazon.com/ecs/" target="_blank" rel="noopener noreferrer">Amazon Elastic Container Service</a> (Amazon ECS),and <a href="https://aws.amazon.com/lambda/" target="_blank" rel="noopener noreferrer">AWS Lambda</a> using Kinesis Data Firehose and Amazon OpenSearch Service. This approach allows you to analyze logs quickly and the root cause of failures, using a single platform rather than different platforms for different services.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion" href="/observability-best-practices/docs/guides/containers/aws-native/eks/log-aggregation#conclusion">​</a></h2>
<p>In this section of Observability best practices guide, we started with deep diving in three types of Kubernetes logging such as control plane logging, node logging, and application logging. Further we learned about unified log aggregation from Amazon EKS and other compute platforms using AWS Native services such as Kinesis Data Firehose and Amazon OpenSearch Service. For further deep dive, we would highly recommend you to practice Logs and Insights modules under AWS native Observability category of AWS <a href="https://catalog.workshops.aws/observability/en-US" target="_blank" rel="noopener noreferrer">One Observability Workshop</a>.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/aws-observability/observability-best-practices/docs/guides/containers/aws-native/eks/log-aggregation.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/observability-best-practices/docs/guides/containers/aws-native/eks/amazon-cloudwatch-container-insights"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Amazon CloudWatch Container Insights</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/observability-best-practices/docs/guides/containers/aws-native/eks/eks-api-server-monitoring"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Amazon EKS API Server Monitoring</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a class="table-of-contents__link toc-highlight" href="/observability-best-practices/docs/guides/containers/aws-native/eks/log-aggregation#introduction">Introduction</a></li><li><a class="table-of-contents__link toc-highlight" href="/observability-best-practices/docs/guides/containers/aws-native/eks/log-aggregation#amazon-eks-control-plane-logging">Amazon EKS control plane logging</a></li><li><a class="table-of-contents__link toc-highlight" href="/observability-best-practices/docs/guides/containers/aws-native/eks/log-aggregation#amazon-eks-data-plane-logging">Amazon EKS data plane logging</a></li><li><a class="table-of-contents__link toc-highlight" href="/observability-best-practices/docs/guides/containers/aws-native/eks/log-aggregation#amazon-eks-application-logging">Amazon EKS application logging</a></li><li><a class="table-of-contents__link toc-highlight" href="/observability-best-practices/docs/guides/containers/aws-native/eks/log-aggregation#unified-log-aggregation-from-amazon-eks-and-other-compute-platforms-using-aws-native-services">Unified log aggregation from Amazon EKS and other compute platforms using AWS Native services</a></li><li><a class="table-of-contents__link toc-highlight" href="/observability-best-practices/docs/guides/containers/aws-native/eks/log-aggregation#conclusion">Conclusion</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Built with ❤️ at AWS. <br> © 2024.  Amazon.com, Inc. or its affiliates. All Rights Reserved.</div></div></div></footer></div>
</body>
</html>