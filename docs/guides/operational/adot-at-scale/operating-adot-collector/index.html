<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-guides/operational/adot-at-scale/operating-adot-collector" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">Operating the AWS Distro for OpenTelemetry (ADOT) Collector | AWS Observability best practices</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://aws-observability.github.io/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" property="og:locale:alternate" content="ja"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Operating the AWS Distro for OpenTelemetry (ADOT) Collector | AWS Observability best practices"><meta data-rh="true" name="description" content="The ADOT collector is a downstream distribution of the open-source OpenTelemetry Collector by CNCF."><meta data-rh="true" property="og:description" content="The ADOT collector is a downstream distribution of the open-source OpenTelemetry Collector by CNCF."><link data-rh="true" rel="icon" href="/observability-best-practices/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://aws-observability.github.io/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector"><link data-rh="true" rel="alternate" href="https://aws-observability.github.io/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector" hreflang="en"><link data-rh="true" rel="alternate" href="https://aws-observability.github.io/observability-best-practices/ja/docs/guides/operational/adot-at-scale/operating-adot-collector" hreflang="ja"><link data-rh="true" rel="alternate" href="https://aws-observability.github.io/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/observability-best-practices/blog/rss.xml" title="AWS Observability best practices RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/observability-best-practices/blog/atom.xml" title="AWS Observability best practices Atom Feed"><link rel="stylesheet" href="/observability-best-practices/assets/css/styles.2859e3e9.css">
<script src="/observability-best-practices/assets/js/runtime~main.240bb889.js" defer="defer"></script>
<script src="/observability-best-practices/assets/js/main.21eb589f.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/observability-best-practices/"><div class="navbar__logo"><img src="/observability-best-practices/img/logo.svg" alt="AWS Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/observability-best-practices/img/logo.svg" alt="AWS Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">AWS Observability Best Practices</b></a><a class="navbar__item navbar__link" href="/observability-best-practices/docs/home">Home</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/observability-best-practices/docs/guides/">Guides</a><a class="navbar__item navbar__link" href="/observability-best-practices/docs/signals/alarms">Signals</a><a class="navbar__item navbar__link" href="/observability-best-practices/docs/tools/observability_accelerator">Tools</a><a class="navbar__item navbar__link" href="/observability-best-practices/docs/recipes/">Recipes</a><a class="navbar__item navbar__link" href="/observability-best-practices/docs/faq/adot">FAQ</a><a class="navbar__item navbar__link" href="/observability-best-practices/docs/patterns/multiaccount">Patterns</a><a class="navbar__item navbar__link" href="/observability-best-practices/docs/contributors">Contributors</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/observability-best-practices/ja/docs/guides/operational/adot-at-scale/operating-adot-collector" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="ja">日本語</a></li></ul></div><a href="https://github.com/aws-observability/observability-best-practices" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/observability-best-practices/docs/guides/">Guides</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/observability-best-practices/docs/guides/">Best practices overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/observability-best-practices/docs/guides/choosing-a-tracing-agent">Choosing a tracing agent</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/observability-best-practices/docs/guides/cost/kubecost">Cost</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/observability-best-practices/docs/guides/databases/rds-and-aurora">Databases</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/observability-best-practices/docs/guides/ec2-monitoring">EC2 Monitoring and Observability</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/observability-best-practices/docs/guides/containers/aws-native/ecs/best-practices-metrics-collection-1">ECS best practices</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/observability-best-practices/docs/guides/containers/aws-native/eks/amazon-cloudwatch-container-insights">EKS best practices</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/observability-best-practices/docs/guides/serverless/aws-native/lambda-based-observability">Serverless best practices</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/observability-best-practices/docs/guides/hybrid-and-multicloud">Best practices for hybrid and multicloud</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector">Operational</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector">ADOT Collector</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector">Operating the AWS Distro for OpenTelemetry (ADOT) Collector</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/observability-best-practices/docs/guides/operational/adot-at-scale/adot-java-spring/">Instrumenting Java Spring Integration Applications</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/observability-best-practices/docs/guides/operational/business/monitoring-for-business-outcomes">Why should you do observability?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/observability-best-practices/docs/guides/operational/business/sla-percentile">Percentiles are important</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/observability-best-practices/docs/guides/operational/business/key-performance-indicators">key-performance-indicators</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/observability-best-practices/docs/guides/rust-custom-metrics/">Creating Custom Metrics with the AWS Rust SDK</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/observability-best-practices/docs/guides/operational/alerting/amp-alertmgr">Alerting</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/observability-best-practices/docs/guides/operational/gitops-with-amg/">GitOps</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/observability-best-practices/docs/tools/cloudwatch-dashboard">Dashboards</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/observability-best-practices/docs/guides/signal-collection/emf">Signal collection</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/observability-best-practices/docs/guides/partners/databricks">Partners</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/observability-best-practices/docs/guides/observability-maturity-model">AWS Observability Maturity Model</a></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/observability-best-practices/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Guides</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Operational</span><meta itemprop="position" content="2"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">ADOT Collector</span><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Operating the AWS Distro for OpenTelemetry (ADOT) Collector</span><meta itemprop="position" content="4"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Operating the AWS Distro for OpenTelemetry (ADOT) Collector</h1>
<p>The <a href="https://aws-otel.github.io/" target="_blank" rel="noopener noreferrer">ADOT collector</a> is a downstream distribution of the open-source <a href="https://opentelemetry.io/docs/collector/" target="_blank" rel="noopener noreferrer">OpenTelemetry Collector</a> by <a href="https://www.cncf.io/" target="_blank" rel="noopener noreferrer">CNCF</a>.</p>
<p>Customers can use the ADOT Collector to collect signals such as metrics and traces from different environments including on-prem, AWS and from other cloud providers.</p>
<p>In order to operate the ADOT Collector in a real world environment and at scale, operators should monitor the collector health, and scale as needed. In this guide, you will learn about the actions one can take to operate the ADOT Collector in a production environment.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="deployment-architecture">Deployment architecture<a class="hash-link" aria-label="Direct link to Deployment architecture" title="Direct link to Deployment architecture" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector#deployment-architecture">​</a></h2>
<p>Depending on the your requirements, there are a few deployment options that you might want to consider.</p>
<ul>
<li>No Collector</li>
<li>Agent</li>
<li>Gateway</li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Check out the <a href="https://opentelemetry.io/docs/collector/deployment/" target="_blank" rel="noopener noreferrer">OpenTelemetry documentation</a>
for additional information on these concepts.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="no-collector">No Collector<a class="hash-link" aria-label="Direct link to No Collector" title="Direct link to No Collector" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector#no-collector">​</a></h3>
<p>This option essentially skips the collector from the equation completely. If you are not aware, it is possible to make the API calls to destination services directly from the OTEL SDK and send the signals. Think about you making calls to the AWS X-Ray&#x27;s <a href="https://docs.aws.amazon.com/xray/latest/api/API_PutTraceSegments.html" target="_blank" rel="noopener noreferrer">PutTraceSegments</a> API directly from your application process instead of sending the spans to an out-of-process agent such as the ADOT Collector.</p>
<p>We strongly encourage you to take a look at the <a href="https://opentelemetry.io/docs/collector/deployment/no-collector/" target="_blank" rel="noopener noreferrer">section</a> in the upstream documentation for more specifics as there isn&#x27;t any AWS specific aspect that changes the guidance for this approach.</p>
<p><img decoding="async" loading="lazy" alt="No Collector option" src="/observability-best-practices/assets/images/adot-collector-deployment-no-collector-999d5d3495ed9914d29593b8acc5db7c.png" width="761" height="481" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="agent">Agent<a class="hash-link" aria-label="Direct link to Agent" title="Direct link to Agent" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector#agent">​</a></h3>
<p>In this approach, you will run the collector in a distributed manner and collect signals into the destinations. Unlike the <code>No Collector</code> option, here we separate the concerns and decouple the application from having to use its resources to make remote API calls and instead communicate to a locally accessible agent.</p>
<p>Essentially it will look like this below in an Amazon EKS environment <strong>running the collector as a Kubernetes sidecar:</strong></p>
<p><img decoding="async" loading="lazy" alt="ADOT Collector Sidecar" src="/observability-best-practices/assets/images/adot-collector-eks-sidecar-97f88928e556e84a5d69a91a04aa0678.png" width="761" height="481" class="img_ev3q"></p>
<p>In this above architecture, your scrape configuration shouldn&#x27;t really have to make use of any service discovery mechanisms at all since you will be scraping the targets from <code>localhost</code> given that the collector is running in the same pod as the application container.</p>
<p>The same architecture applies to collecting traces as well. You will simply have to create a OTEL pipeline as <a href="https://aws-otel.github.io/docs/getting-started/x-ray#sample-collector-configuration-putting-it-together" target="_blank" rel="noopener noreferrer">shown here</a></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="pros-and-cons">Pros and Cons<a class="hash-link" aria-label="Direct link to Pros and Cons" title="Direct link to Pros and Cons" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector#pros-and-cons">​</a></h5>
<ul>
<li>
<p>One argument advocating for this design is that you don&#x27;t have to allocate extra-ordinary amount of resources (CPU, Memory) for the Collector to do its job since the targets are limited to localhost sources.</p>
</li>
<li>
<p>The disadvantage of using this approach could be that, the number of varied configurations for the collector pod configuration is directly proportional to the number of applications you are running on the cluster.
This means, you will have to manage CPU, Memory and other resource allocation individually for each Pod depending on the workload that is expected for the Pod. By not being careful with this, you might over or under-allocate resources for the Collector Pod that will result in either under-performing or locking up CPU cycles and Memory which could otherwise be used by other Pods in the Node.</p>
</li>
</ul>
<p>You could also deploy the collector in other models such as Deployments, Daemonset, Statefulset etc based on your needs.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="running-the-collector-as-a-daemonset-on-amazon-eks">Running the collector as a Daemonset on Amazon EKS<a class="hash-link" aria-label="Direct link to Running the collector as a Daemonset on Amazon EKS" title="Direct link to Running the collector as a Daemonset on Amazon EKS" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector#running-the-collector-as-a-daemonset-on-amazon-eks">​</a></h4>
<p>You can choose to run the collector as a <a href="https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/" target="_blank" rel="noopener noreferrer">Daemonset</a> in case you want to evenly distribute the load (scraping and sending the metrics to Amazon Managed Service for Prometheus workspace) of the collectors across the EKS Nodes.</p>
<p><img decoding="async" loading="lazy" alt="ADOT Collector Daemonset" src="/observability-best-practices/assets/images/adot-collector-eks-daemonset-1fafe074d6b58e68da18cd163138d70e.png" width="761" height="481" class="img_ev3q"></p>
<p>Ensure you have the <code>keep</code> action that makes the collector only scrape targets from its own host/Node.</p>
<p>See sample below for reference. Find more such configuration details <a href="https://aws-otel.github.io/docs/getting-started/adot-eks-add-on/config-advanced#daemonset-collector-configuration" target="_blank" rel="noopener noreferrer">here.</a></p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">scrape_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">job_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kubernetes</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">apiservers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">bearer_token_file</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /var/run/secrets/kubernetes.io/serviceaccount/token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kubernetes_sd_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">role</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> endpoints</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">relabel_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">action</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> keep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">regex</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $K8S_NODE_NAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">source_labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">__meta_kubernetes_endpoint_node_name</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">scheme</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">tls_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">ca_file</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">insecure_skip_verify</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The same architecture can also be used for collecting traces. In this case, instead of the Collector reaching out to the endpoints to scrape Prometheus metrics, the trace spans will be sent to the Collector by the application pods.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="pros-and-cons-1">Pros and Cons<a class="hash-link" aria-label="Direct link to Pros and Cons" title="Direct link to Pros and Cons" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector#pros-and-cons-1">​</a></h5>
<p><strong>Advantages</strong></p>
<ul>
<li>Minimal scaling concerns</li>
<li>Configuring High-Availability is a challenge</li>
<li>Too many copies of Collector in use</li>
<li>Can be easy for Logs support</li>
</ul>
<p><strong>Disadvantages</strong></p>
<ul>
<li>Not the most optimal in terms of resource utilization</li>
<li>Disproportionate resource allocation</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="running-the-collector-on-amazon-ec2">Running the collector on Amazon EC2<a class="hash-link" aria-label="Direct link to Running the collector on Amazon EC2" title="Direct link to Running the collector on Amazon EC2" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector#running-the-collector-on-amazon-ec2">​</a></h4>
<p>As there is no side car approach in running the collector on EC2, you would be running the collector as an agent on the EC2 instance. You can set a static scrape configuration such as the one below to discover targets in the instance to scrape metrics from.</p>
<p>The config below scrapes endpoints at ports <code>9090</code> and <code>8081</code> on localhost.</p>
<p>Get a hands-on deep dive experience in this topic by going through our <a href="https://catalog.workshops.aws/observability/en-US/aws-managed-oss/ec2-monitoring" target="_blank" rel="noopener noreferrer">EC2 focused module in the One Observability Workshop.</a></p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">global</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">scrape_interval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 15s </span><span class="token comment" style="color:#999988;font-style:italic"># By default, scrape targets every 15 seconds.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">scrape_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">job_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;prometheus&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">static_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">targets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;localhost:9090&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;localhost:8081&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="running-the-collector-as-deployment-on-amazon-eks">Running the collector as Deployment on Amazon EKS<a class="hash-link" aria-label="Direct link to Running the collector as Deployment on Amazon EKS" title="Direct link to Running the collector as Deployment on Amazon EKS" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector#running-the-collector-as-deployment-on-amazon-eks">​</a></h4>
<p>Running the collector as a Deployment is particularly useful when you want to also provide High Availability for your collectors. Depending on the number of targets, metrics available to scrape etc the resources for the Collector should be adjusted to ensure the collector isn&#x27;t starving and hence causing issues in signal collection.</p>
<p><a href="https://aws-observability.github.io/observability-best-practices/guides/containers/oss/eks/best-practices-metrics-collection" target="_blank" rel="noopener noreferrer">Read more about this topic in the guide here.</a></p>
<p>The following architecture shows how a collector is deployed in a separate node outside of the workload nodes to collect metrics and traces.</p>
<p><img decoding="async" loading="lazy" alt="ADOT Collector Deployment" src="/observability-best-practices/assets/images/adot-collector-deployment-deployment-1ee93ef82de431619a70cc04486aca30.png" width="761" height="711" class="img_ev3q"></p>
<p>To setup High-Availability for metric collection, <a href="https://docs.aws.amazon.com/prometheus/latest/userguide/Send-high-availability-prom-community.html" target="_blank" rel="noopener noreferrer">read our docs that provide detailed instructions on how you can set that up</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="running-the-collector-as-a-central-task-on-amazon-ecs-for-metrics-collection">Running the collector as a central task on Amazon ECS for metrics collection<a class="hash-link" aria-label="Direct link to Running the collector as a central task on Amazon ECS for metrics collection" title="Direct link to Running the collector as a central task on Amazon ECS for metrics collection" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector#running-the-collector-as-a-central-task-on-amazon-ecs-for-metrics-collection">​</a></h4>
<p>You can use the <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/extension/observer/ecsobserver" target="_blank" rel="noopener noreferrer">ECS Observer extension</a> to collect Prometheus metrics across different tasks in an ECS cluster or across clusters.</p>
<p><img decoding="async" loading="lazy" alt="ADOT Collector Deployment ECS" src="/observability-best-practices/assets/images/adot-collector-deployment-ecs-b0d7e3d9a570c3c47b96544a2f9f451c.png" width="761" height="711" class="img_ev3q"></p>
<p>Sample collector configuration for the extension:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">extensions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ecs_observer</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">refresh_interval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 60s </span><span class="token comment" style="color:#999988;font-style:italic"># format is https://golang.org/pkg/time/#ParseDuration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">cluster_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Cluster-1&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># cluster name need manual config</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">cluster_region</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;us-west-2&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># region can be configured directly or use AWS_REGION env var</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">result_file</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;/etc/ecs_sd_targets.yaml&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># the directory for file must already exists</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">services</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name_pattern</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;^retail-.*$&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">docker_labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">port_label</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;ECS_PROMETHEUS_EXPORTER_PORT&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">task_definitions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">job_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;task_def_1&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">metrics_path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;/metrics&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">metrics_ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9113</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9090</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">arn_pattern</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;.*:task-definition/nginx:[0-9]+&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="pros-and-cons-2">Pros and Cons<a class="hash-link" aria-label="Direct link to Pros and Cons" title="Direct link to Pros and Cons" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector#pros-and-cons-2">​</a></h5>
<ul>
<li>An advantage in this model is that there are fewer collectors and configurations to manage yourself.</li>
<li>When the cluster is rather large and there are thousands of targets to scrape, you will have to carefully design the architecture in such a way that the load is balanced across the collectors. Adding this to having to run near-clones of the same collectors for HA reasons should be done carefully in order to avoid operational issues.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="gateway">Gateway<a class="hash-link" aria-label="Direct link to Gateway" title="Direct link to Gateway" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector#gateway">​</a></h3>
<p><img decoding="async" loading="lazy" alt="ADOT Collector Gateway" src="/observability-best-practices/assets/images/adot-collector-deployment-gateway-7b89190cb3c31a2e3883885b0df572a7.png" width="841" height="531" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="managing-collector-health">Managing Collector health<a class="hash-link" aria-label="Direct link to Managing Collector health" title="Direct link to Managing Collector health" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector#managing-collector-health">​</a></h2>
<p>The OTEL Collector exposes several signals for us to keep tab of its health and performance. It is essential that the collector&#x27;s health is closely monitored in order to take corrective actions such as,</p>
<ul>
<li>Scaling the collector horizontally</li>
<li>Provisioning additional resources to the collector for it to function as desired</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="collecting-health-metrics-from-the-collector">Collecting health metrics from the Collector<a class="hash-link" aria-label="Direct link to Collecting health metrics from the Collector" title="Direct link to Collecting health metrics from the Collector" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector#collecting-health-metrics-from-the-collector">​</a></h3>
<p>The OTEL Collector can be configured to expose metrics in Prometheus Exposition Format by simply adding the <code>telemetry</code> section to the <code>service</code> pipeline. The collector also can expose its own logs to stdout.</p>
<p>More details on telemetry configuration can be found in the <a href="https://opentelemetry.io/docs/collector/configuration/#service" target="_blank" rel="noopener noreferrer">OpenTelemetry documentation here.</a></p>
<p>Sample telemetry configuration for the collector.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">telemetry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">logs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">level</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> debug</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">metrics</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">level</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> detailed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.0.0.0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">8888</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once configured, the collector will start exporting metrics such as this below at <code>http://localhost:8888/metrics</code>.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># HELP otelcol_exporter_enqueue_failed_spans Number of spans failed to be added to the sending queue.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># TYPE otelcol_exporter_enqueue_failed_spans counter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">otelcol_exporter_enqueue_failed_spans{exporter=&quot;awsxray&quot;,service_instance_id=&quot;523a2182-539d-47f6-ba3c-13867b60092a&quot;,service_name=&quot;aws-otel-collector&quot;,service_version=&quot;v0.25.0&quot;} 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># HELP otelcol_process_runtime_total_sys_memory_bytes Total bytes of memory obtained from the OS (see &#x27;go doc runtime.MemStats.Sys&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># TYPE otelcol_process_runtime_total_sys_memory_bytes gauge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">otelcol_process_runtime_total_sys_memory_bytes{service_instance_id=&quot;523a2182-539d-47f6-ba3c-13867b60092a&quot;,service_name=&quot;aws-otel-collector&quot;,service_version=&quot;v0.25.0&quot;} 2.4462344e+07</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># HELP otelcol_process_memory_rss Total physical memory (resident set size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># TYPE otelcol_process_memory_rss gauge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">otelcol_process_memory_rss{service_instance_id=&quot;523a2182-539d-47f6-ba3c-13867b60092a&quot;,service_name=&quot;aws-otel-collector&quot;,service_version=&quot;v0.25.0&quot;} 6.5675264e+07</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># HELP otelcol_exporter_enqueue_failed_metric_points Number of metric points failed to be added to the sending queue.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># TYPE otelcol_exporter_enqueue_failed_metric_points counter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">otelcol_exporter_enqueue_failed_metric_points{exporter=&quot;awsxray&quot;,service_instance_id=&quot;d234b769-dc8a-4b20-8b2b-9c4f342466fe&quot;,service_name=&quot;aws-otel-collector&quot;,service_version=&quot;v0.25.0&quot;} 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">otelcol_exporter_enqueue_failed_metric_points{exporter=&quot;logging&quot;,service_instance_id=&quot;d234b769-dc8a-4b20-8b2b-9c4f342466fe&quot;,service_name=&quot;aws-otel-collector&quot;,service_version=&quot;v0.25.0&quot;} 0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In the above sample output, you can see that the collector is exposing a metric called <code>otelcol_exporter_enqueue_failed_spans</code> showing the number of spans that were failed to get added to the sending queue. This metric is one to watch out to understand if the collector is having issues in sending trace data to the destination configured. In this case, you can see that the <code>exporter</code> label with value <code>awsxray</code> indicating the trace destination in use.</p>
<p>The other metric <code>otelcol_process_runtime_total_sys_memory_bytes</code> is an indicator to understand the amount of memory being used by the collector. If this memory goes too close to the value in <code>otelcol_process_memory_rss</code> metric, that is an indication that the Collector is getting close to exhausting the allocated memory for the process and it might be time for you to take action such as allocating more memory for the collector to avoid issues.</p>
<p>Likewise, you can see that there is another counter metric called <code>otelcol_exporter_enqueue_failed_metric_points</code> that indicates the number of metrics that failed to be sent to the remote destination</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="collector-health-check">Collector health check<a class="hash-link" aria-label="Direct link to Collector health check" title="Direct link to Collector health check" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector#collector-health-check">​</a></h4>
<p>There is a liveness probe that the collector exposes in-order for you to check whether the collector is live or not. It is recommended to use that endpoint to periodically check the collector&#x27;s availability.</p>
<p>The <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/extension/healthcheckextension" target="_blank" rel="noopener noreferrer"><code>healthcheck</code></a> extension can be used to have the collector expose the endpoint. See sample configuration below:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">extensions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">health_check</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">endpoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.0.0.0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">13133</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>For the complete configuration options, refer to <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/extension/healthcheckextension" target="_blank" rel="noopener noreferrer">the GitHub repo here.</a></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">❯ curl -v http://localhost:13133</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*   Trying 127.0.0.1:13133...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* Connected to localhost (127.0.0.1) port 13133 (#0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; GET / HTTP/1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; Host: localhost:13133</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; User-Agent: curl/7.79.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; Accept: */*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* Mark bundle as not supporting multiuse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt; HTTP/1.1 200 OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt; Date: Fri, 24 Feb 2023 19:09:22 GMT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt; Content-Length: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* Connection #0 to host localhost left intact</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="setting-limits-to-prevent-catastrophic-failures">Setting limits to prevent catastrophic failures<a class="hash-link" aria-label="Direct link to Setting limits to prevent catastrophic failures" title="Direct link to Setting limits to prevent catastrophic failures" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector#setting-limits-to-prevent-catastrophic-failures">​</a></h4>
<p>Given that resources (CPU, Memory) are finite in any environment, you should set limits to the collector components in-order to avoid failures due to unforeseen situations.</p>
<p>It is particularly important when you are operating the ADOT Collector to collect Prometheus metrics.
Take this scenario - You are in the DevOps team and are responsible for deploying and operating the ADOT Collector in an Amazon EKS cluster. Your application teams can simply drop their application Pods at will anytime of the day, and they expect the metrics exposed from their pods to be collected into an Amazon Managed Service for Prometheus workspace.</p>
<p>Now it is your responsibility to ensure that this pipeline works without any hiccups. There are two ways to solve this problem at a high level:</p>
<ul>
<li>Scaling the collector infinitely (hence adding Nodes to the cluster if needed) to support this requirement</li>
<li>Set limits on metric collection and advertise the upper threshold to the application teams</li>
</ul>
<p>There are pros and cons to both approaches. You can argue that you want to choose option 1, if you are fully committed to supporting your ever growing business needs not considering the costs or the overhead that it might bring in. While supporting the ever growing business needs infinitely might sound like <code>cloud is for infinite scalability</code> point of view, this can bring in a lot of operational overhead and might lead into much more catastrophical situations if not given infinite amount of time, and people resources to ensure continual uninterrupted operations, which in most cases is not practical.</p>
<p>A much more pragmatic and frugal approach would be to choose option 2, where you are setting upper limits (and potentially increasing gradually based on needs progressively) at any given time to ensure the operational boundary is obvious.</p>
<p>Here is an example of how you can do that with using Prometheus receiver in the ADOT Collector.</p>
<p>In Prometheus <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#relabel_config" target="_blank" rel="noopener noreferrer">scrape_config,</a> you can set several limits for any particular scrape job. You could put limits on,</p>
<ul>
<li>The total body size of the scrape</li>
<li>Limit number of labels to accept (the scrape will be discarded if this limit exceeds and you can see that in the Collector logs)</li>
<li>Limit the number of targets to scrape</li>
<li>..more</li>
</ul>
<p>You can see all available options in the <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#relabel_config" target="_blank" rel="noopener noreferrer">Prometheus documentation.</a></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="limiting-memory-usage">Limiting Memory usage<a class="hash-link" aria-label="Direct link to Limiting Memory usage" title="Direct link to Limiting Memory usage" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector#limiting-memory-usage">​</a></h5>
<p>The Collector pipeline can be configured to use <a href="https://github.com/open-telemetry/opentelemetry-collector/tree/main/processor/memorylimiterprocessor" target="_blank" rel="noopener noreferrer"><code>memorylimiterprocessor</code></a> to limit the amount of memory the processor component will use. It is common to see customers wanting the Collector to do complex operations that require intense Memory and CPU requirements.</p>
<p>While using processors such as <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/redactionprocessor" target="_blank" rel="noopener noreferrer"><code>redactionprocessor,</code></a><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/filterprocessor" target="_blank" rel="noopener noreferrer"><code>filterprocessor,</code></a><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/spanprocessor" target="_blank" rel="noopener noreferrer"><code>spanprocessor,</code></a> are exciting and very useful, you should also remember that processors in general deal with data transformation tasks and it requires them to keep data in-memory in-order to complete the tasks. This can lead to a specific processor breaking the Collector entirely and also the Collector not having enough memory to expose its own health metrics.</p>
<p>You can avoid this by limiting the amount of memory the Collector can use by making use of the  <a href="https://github.com/open-telemetry/opentelemetry-collector/tree/main/processor/memorylimiterprocessor" target="_blank" rel="noopener noreferrer"><code>memorylimiterprocessor.</code></a>. The recommendation for this is to provide buffer memory for the Collector to make use of for exposing health metrics and perform other tasks so the processors do not take all the allocated memory.</p>
<p>For example, if your EKS Pod has a memory limit of <code>10Gi</code>, then set the <code>memorylimitprocessor</code> to less than <code>10Gi</code>, for example <code>9Gi</code> so the buffer of <code>1Gi</code> can be used to perform other operations such as exposing health metrics, receiver and exporter tasks.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="backpressure-management">Backpressure management<a class="hash-link" aria-label="Direct link to Backpressure management" title="Direct link to Backpressure management" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector#backpressure-management">​</a></h4>
<p>Some architecture patterns (Gateway pattern) such as the one shown below can be used to centralize some operational tasks such as (but not limited to) filtering out sensitive data out of signal data to maintain compliance requirements.</p>
<p><img decoding="async" loading="lazy" alt="ADOT Collector Simple Gateway" src="/observability-best-practices/assets/images/adot-collector-deployment-simple-gateway-a47d0f8adfc55829b471b1290391279e.png" width="455" height="292" class="img_ev3q"></p>
<p>However, it is possible to overwhelm the Gateway Collector with too many such <em>processing</em> tasks that can cause issues. The recommended approach would be is to distribute the process/memory intense tasks between the individual collectors and the gateway so the workload is shared.</p>
<p>For example, you could use the <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/resourceprocessor" target="_blank" rel="noopener noreferrer"><code>resourceprocessor</code></a> to process resource attributes and use the <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/transformprocessor" target="_blank" rel="noopener noreferrer"><code>transformprocessor</code></a> to transform the signal data from within the individual Collectors as soon as the signal collection happens.</p>
<p>Then you could use the <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/filterprocessor" target="_blank" rel="noopener noreferrer"><code>filterprocessor</code></a> to filter out certain parts of the signal data and use the <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/redactionprocessor" target="_blank" rel="noopener noreferrer"><code>redactionprocessor</code></a> to redact sensitive information such as Credit Card numbers etc.</p>
<p>The high-level architecture diagram would look like the one below:</p>
<p><img decoding="async" loading="lazy" alt="ADOT Collector Simple Gateway with processors" src="/observability-best-practices/assets/images/adot-collector-deployment-simple-gateway-pressure-176e7f7853aef0c791d53bc119860d42.png" width="455" height="362" class="img_ev3q"></p>
<p>As you might have observed already, the Gateway Collector can soon become a single point of failure. One obvious choice there is to spin up more than one Gateway Collector and proxy requests through a load balancer like <a href="https://aws.amazon.com/elasticloadbalancing/application-load-balancer/" target="_blank" rel="noopener noreferrer">AWS Application Load Balancer (ALB)</a> as shown below.</p>
<p><img decoding="async" loading="lazy" alt="ADOT Collector Gateway batching pressure" src="/observability-best-practices/assets/images/adot-collector-deployment-gateway-batching-pressure-3df82da0813ea492acb62d86ce151217.png" width="842" height="532" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="handling-out-of-order-samples-in-prometheus-metric-collection">Handling out-of-order samples in Prometheus metric collection<a class="hash-link" aria-label="Direct link to Handling out-of-order samples in Prometheus metric collection" title="Direct link to Handling out-of-order samples in Prometheus metric collection" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector#handling-out-of-order-samples-in-prometheus-metric-collection">​</a></h5>
<p>Consider the following scenario in the architecture below:</p>
<p><img decoding="async" loading="lazy" alt="ADOT Collector Gateway batching pressure" src="/observability-best-practices/assets/images/adot-collector-deployment-gateway-batching-7d623347309a82aea25ab9cbd9eb5552.png" width="841" height="531" class="img_ev3q"></p>
<ol>
<li>Assume that metrics from <strong>ADOT Collector-1</strong> in the Amazon EKS Cluster are sent to the Gateway cluster, which is being directed to the <strong>Gateway ADOT Collector-1</strong></li>
<li>In a moment, the metrics from the same <strong>ADOT Collector-1</strong> (which is collecting the same targets, hence the same metric samples are being dealt with) is being sent to <strong>Gateway ADOT Collector-2</strong></li>
<li>Now if the <strong>Gateway ADOT Collector-2</strong> happens to dispatch the metrics to Amazon Managed Service for Prometheus workspace first and then followed by the <strong>Gateway ADOT Collector-1</strong> which contains older samples for the same metrics series, you will receive the <code>out of order sample</code> error from Amazon Managed Service for Prometheus.</li>
</ol>
<p>See example error below:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Error message:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 2023-03-02T21:18:54.447Z        error   exporterhelper/queued_retry.go:394      Exporting failed. The error is not retryable. Dropping data.    {&quot;kind&quot;: &quot;exporter&quot;, &quot;data_type&quot;: &quot;metrics&quot;, &quot;name&quot;: &quot;prometheusremotewrite&quot;, &quot;error&quot;: &quot;Permanent error: Permanent error: remote write returned HTTP status 400 Bad Request; err = %!w(&lt;nil&gt;): user=820326043460_ws-5f42c3b6-3268-4737-b215-1371b55a9ef2: err: out of order sample. timestamp=2023-03-02T21:17:59.782Z, series={__name__=\&quot;otelcol_exporter_send_failed_metric_points\&quot;, exporter=\&quot;logging\&quot;, http_scheme=\&quot;http\&quot;, instance=\&quot;10.195.158.91:28888\&quot;, &quot;, &quot;dropped_items&quot;: 6474}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">go.opentelemetry.io/collector/exporter/exporterhelper.(*retrySender).send</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        go.opentelemetry.io/collector@v0.66.0/exporter/exporterhelper/queued_retry.go:394</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">go.opentelemetry.io/collector/exporter/exporterhelper.(*metricsSenderWithObservability).send</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        go.opentelemetry.io/collector@v0.66.0/exporter/exporterhelper/metrics.go:135</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">go.opentelemetry.io/collector/exporter/exporterhelper.(*queuedRetrySender).start.func1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        go.opentelemetry.io/collector@v0.66.0/exporter/exporterhelper/queued_retry.go:205</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">go.opentelemetry.io/collector/exporter/exporterhelper/internal.(*boundedMemoryQueue).StartConsumers.func1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        go.opentelemetry.io/collector@v0.66.0/exporter/exporterhelper/internal/bounded_memory_queue.go:61</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="solving-out-of-order-sample-error">Solving out of order sample error<a class="hash-link" aria-label="Direct link to Solving out of order sample error" title="Direct link to Solving out of order sample error" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector#solving-out-of-order-sample-error">​</a></h6>
<p>You can solve the out of order sample error in this particular setup in a couple of ways:</p>
<ul>
<li>
<p>Use a sticky load balancer to direct requests from a particular source to go to the same target based on IP address.</p>
<p>Refer to the <a href="https://aws.amazon.com/premiumsupport/knowledge-center/elb-route-requests-with-source-ip-alb/" target="_blank" rel="noopener noreferrer">link here</a> for additional details.</p>
</li>
<li>
<p>As an alternate option, you can add an external label in the Gateway Collectors to distinguish the metric series so Amazon Managed Service for Prometheus considers these metrics are individual metric series and are not from the same.</p>
</li>
</ul>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Using this solution can will result in multiplying the metric series in proportion to the Gateway Collectors in the setup. This is might mean that you can overrun some limits such as <a href="https://docs.aws.amazon.com/prometheus/latest/userguide/AMP_quotas.html" target="_blank" rel="noopener noreferrer"><code>Active time series limits</code></a></p></div></div>
<ul>
<li><strong>If you are deploying ADOT Collector as a Daemonset</strong>: make sure you are using <code>relabel_configs</code> to only keep samples from the same node where each ADOT Collector pod is running. Check the links below to learn more.<!-- -->
<ul>
<li><a href="https://aws-otel.github.io/docs/getting-started/adot-eks-add-on/config-advanced" target="_blank" rel="noopener noreferrer">Advanced Collector Configuration for Amazon Managed Prometheus</a> - Expand the <em>Click to View</em> section, and look for the entried similar to the following:<!-- -->
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">relabel_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">action</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> keep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">regex</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $K8S_NODE_NAME</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li><a href="https://aws-otel.github.io/docs/getting-started/adot-eks-add-on/add-on-configuration" target="_blank" rel="noopener noreferrer">ADOT Add-On Advanced Configuration</a> - Learn how to deploy ADOT Collector using the ADOT Add-On for EKS advanced configurations.</li>
<li><a href="https://aws-otel.github.io/docs/getting-started/adot-eks-add-on/installation#deploy-the-adot-collector" target="_blank" rel="noopener noreferrer">ADOT Collector deployment strategies</a> - Learn more about the different alternatives to deploy ADOT Collector at scale and the advantages of each approach.</li>
</ul>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="open-agent-management-protocol-opamp">Open Agent Management Protocol (OpAMP)<a class="hash-link" aria-label="Direct link to Open Agent Management Protocol (OpAMP)" title="Direct link to Open Agent Management Protocol (OpAMP)" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector#open-agent-management-protocol-opamp">​</a></h4>
<p>OpAMP is a client/server protocol that supports communication over HTTP and over WebSockets. OpAMP is implemented in the OTel Collector and hence the OTel Collector can be used as a server as part of the control plane to manage other agents that support OpAMP, like the OTel Collector itself. The &quot;manage&quot; portion here involves being able to update configurations for collectors, monitoring health or even upgrading the Collectors.</p>
<p>The details of this protocol is well <a href="https://opentelemetry.io/docs/collector/management/" target="_blank" rel="noopener noreferrer">documented in the upstream OpenTelemetry website.</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="horizontal-scaling">Horizontal Scaling<a class="hash-link" aria-label="Direct link to Horizontal Scaling" title="Direct link to Horizontal Scaling" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector#horizontal-scaling">​</a></h3>
<p>It may become necessary to horizontally scale an ADOT Collector depending on your workload. The requirement to horizontally scale is entirely dependent on your use case, Collector configuration, and
telemetry throughput.</p>
<p>Platform specific horizontal scaling techniques can be applied to a Collector as you would any other application while being cognizant of stateful, stateless, and scraper Collector components.</p>
<p>Most collector components are <code>stateless</code>, meaning that they do not hold state in memory, and if they do it is not relevant for scaling purposes. Additional replicas of stateless Collectors can be scaled behind an
application load balancer.</p>
<p><code>Stateful</code> Collector components are collector components that retain information in memory which is crucial for the operation of that component.</p>
<p>Examples of stateful components in the ADOT Collector include but are not limited to:</p>
<ul>
<li><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/tailsamplingprocessor" target="_blank" rel="noopener noreferrer">Tail Sampling Processor</a> - requires all spans for a trace to make an accurate sampling decisions. Avanced sampling scaling techniques is <a href="https://aws-otel.github.io/docs/getting-started/advanced-sampling" target="_blank" rel="noopener noreferrer">documented on the ADOT developer portal</a>.</li>
<li><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/exporter/awsemfexporter" target="_blank" rel="noopener noreferrer">AWS EMF Exporter</a> - performs cummulative to delta conversions on some metric types. This conversion requires the previous metric value to be stored in memory.</li>
<li><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/cumulativetodeltaprocessor#cumulative-to-delta-processor" target="_blank" rel="noopener noreferrer">Cummulative to Delta Processor</a> - cummulative to delta conversion requires storing the previous metric value in memory.</li>
</ul>
<p>Collector components that are <code>scrapers</code> actively obtain telemetry data rather than passively receive it. Currently, the <a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/prometheusreceiver" target="_blank" rel="noopener noreferrer">Prometheus receiver</a> is the only scraper
type component in the ADOT Collector. Horizontally scaling a collector configuration that contains a prometheus receiver will require splitting the scraping jobs per collector to ensure
that no two Collectors scrape the same endpoint. Failure to do this may lead to Prometheus out of order sample errors.</p>
<p>The process of and techniques of scaling collectors is <a href="https://opentelemetry.io/docs/collector/scaling/" target="_blank" rel="noopener noreferrer">documunted in greater detail in the upstream OpenTelemetry website</a>.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/aws-observability/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/observability-best-practices/docs/guides/hybrid-and-multicloud"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Best practices for hybrid and multicloud</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/observability-best-practices/docs/guides/operational/adot-at-scale/adot-java-spring/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Instrumenting Java Spring Integration Applications</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a class="table-of-contents__link toc-highlight" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector#deployment-architecture">Deployment architecture</a><ul><li><a class="table-of-contents__link toc-highlight" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector#no-collector">No Collector</a></li><li><a class="table-of-contents__link toc-highlight" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector#agent">Agent</a></li><li><a class="table-of-contents__link toc-highlight" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector#gateway">Gateway</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector#managing-collector-health">Managing Collector health</a><ul><li><a class="table-of-contents__link toc-highlight" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector#collecting-health-metrics-from-the-collector">Collecting health metrics from the Collector</a></li><li><a class="table-of-contents__link toc-highlight" href="/observability-best-practices/docs/guides/operational/adot-at-scale/operating-adot-collector#horizontal-scaling">Horizontal Scaling</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Built with ❤️ at AWS. <br> © 2024.  Amazon.com, Inc. or its affiliates. All Rights Reserved.</div></div></div></footer></div>
</body>
</html>