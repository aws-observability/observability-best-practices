<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-recipes/recipes/servicemesh-monitoring-ampamg" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">Using Amazon Managed Service for Prometheus to monitor App Mesh environment configured on EKS | AWS Observability best practices</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://aws-observability.github.io/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" property="og:locale:alternate" content="ja"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Using Amazon Managed Service for Prometheus to monitor App Mesh environment configured on EKS | AWS Observability best practices"><meta data-rh="true" name="description" content="In this recipe we show you how to ingest App Mesh Envoy"><meta data-rh="true" property="og:description" content="In this recipe we show you how to ingest App Mesh Envoy"><link data-rh="true" rel="icon" href="/observability-best-practices/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://aws-observability.github.io/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg"><link data-rh="true" rel="alternate" href="https://aws-observability.github.io/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg" hreflang="en"><link data-rh="true" rel="alternate" href="https://aws-observability.github.io/observability-best-practices/ja/docs/recipes/recipes/servicemesh-monitoring-ampamg" hreflang="ja"><link data-rh="true" rel="alternate" href="https://aws-observability.github.io/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/observability-best-practices/blog/rss.xml" title="AWS Observability best practices RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/observability-best-practices/blog/atom.xml" title="AWS Observability best practices Atom Feed"><link rel="stylesheet" href="/observability-best-practices/assets/css/styles.2859e3e9.css">
<script src="/observability-best-practices/assets/js/runtime~main.240bb889.js" defer="defer"></script>
<script src="/observability-best-practices/assets/js/main.21eb589f.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/observability-best-practices/"><div class="navbar__logo"><img src="/observability-best-practices/img/logo.svg" alt="AWS Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/observability-best-practices/img/logo.svg" alt="AWS Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">AWS Observability Best Practices</b></a><a class="navbar__item navbar__link" href="/observability-best-practices/docs/home">Home</a><a class="navbar__item navbar__link" href="/observability-best-practices/docs/guides/">Guides</a><a class="navbar__item navbar__link" href="/observability-best-practices/docs/signals/alarms">Signals</a><a class="navbar__item navbar__link" href="/observability-best-practices/docs/tools/observability_accelerator">Tools</a><a class="navbar__item navbar__link" href="/observability-best-practices/docs/recipes/">Recipes</a><a class="navbar__item navbar__link" href="/observability-best-practices/docs/faq/adot">FAQ</a><a class="navbar__item navbar__link" href="/observability-best-practices/docs/patterns/multiaccount">Patterns</a><a class="navbar__item navbar__link" href="/observability-best-practices/docs/contributors">Contributors</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link" href="/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/observability-best-practices/ja/docs/recipes/recipes/servicemesh-monitoring-ampamg" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="ja">日本語</a></li></ul></div><a href="https://github.com/aws-observability/observability-best-practices" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><main class="docMainContainer_TBSr docMainContainerEnhanced_lQrH"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Using Amazon Managed Service for Prometheus to monitor App Mesh environment configured on EKS</h1>
<p>In this recipe we show you how to ingest <a href="https://docs.aws.amazon.com/app-mesh/" target="_blank" rel="noopener noreferrer">App Mesh</a> Envoy
metrics in an <a href="https://aws.amazon.com/eks/" target="_blank" rel="noopener noreferrer">Amazon Elastic Kubernetes Service</a> (EKS) cluster
to <a href="https://aws.amazon.com/prometheus/" target="_blank" rel="noopener noreferrer">Amazon Managed Service for Prometheus</a> (AMP)
and create a custom dashboard on <a href="https://aws.amazon.com/grafana/" target="_blank" rel="noopener noreferrer">Amazon Managed Grafana</a>
(AMG) to monitor the health and performance of microservices.</p>
<p>As part of the implementation, we will create an AMP workspace, install the App Mesh
Controller for Kubernetes and inject the Envoy container into the pods. We will be
collecting the Envoy metrics using <a href="https://github.com/grafana/agent" target="_blank" rel="noopener noreferrer">Grafana Agent</a>
configured in the EKS cluster and write them to AMP. Finally, we will be creating
an AMG workspace and configure the AMP as the datasource and create a custom dashboard.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>This guide will take approximately 45 minutes to complete.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="infrastructure">Infrastructure<a class="hash-link" aria-label="Direct link to Infrastructure" title="Direct link to Infrastructure" href="/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg#infrastructure">​</a></h2>
<p>In the following section we will be setting up the infrastructure for this recipe.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="architecture">Architecture<a class="hash-link" aria-label="Direct link to Architecture" title="Direct link to Architecture" href="/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg#architecture">​</a></h3>
<p><img decoding="async" loading="lazy" alt="Architecture" src="/observability-best-practices/assets/images/monitoring-appmesh-environment-50670603f0c4805834d00ec9b80f302b.png" width="1496" height="636" class="img_ev3q"></p>
<p>The Grafana agent is configured to scrape the Envoy metrics and ingest them to AMP through the AMP remote write endpoint</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>For more information on Prometheus Remote Write Exporter check out
<a href="https://aws-otel.github.io/docs/getting-started/prometheus-remote-write-exporter" target="_blank" rel="noopener noreferrer">Getting Started with Prometheus Remote Write Exporter for AMP</a>.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites" href="/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg#prerequisites">​</a></h3>
<ul>
<li>The AWS CLI is <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html" target="_blank" rel="noopener noreferrer">installed</a> and <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html" target="_blank" rel="noopener noreferrer">configured</a> in your environment.</li>
<li>You need to install the <a href="https://docs.aws.amazon.com/eks/latest/userguide/eksctl.html" target="_blank" rel="noopener noreferrer">eksctl</a> command in your environment.</li>
<li>You need to install <a href="https://docs.aws.amazon.com/eks/latest/userguide/install-kubectl.html" target="_blank" rel="noopener noreferrer">kubectl</a> in your environment.</li>
<li>You have <a href="https://docs.docker.com/get-docker/" target="_blank" rel="noopener noreferrer">Docker</a> installed into your environment.</li>
<li>You need AMP workspace configured in your AWS account.</li>
<li>You need to install <a href="https://www.eksworkshop.com/beginner/060_helm/helm_intro/install/index.html" target="_blank" rel="noopener noreferrer">Helm</a>.</li>
<li>You need to enable <a href="https://docs.aws.amazon.com/singlesignon/latest/userguide/step1.html" target="_blank" rel="noopener noreferrer">AWS-SSO</a>.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="setup-an-eks-cluster">Setup an EKS cluster<a class="hash-link" aria-label="Direct link to Setup an EKS cluster" title="Direct link to Setup an EKS cluster" href="/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg#setup-an-eks-cluster">​</a></h3>
<p>First, create an EKS cluster that will be enabled with App Mesh for running the sample application.
The <code>eksctl</code> CLI will be used to deploy the cluster using the <a href="/observability-best-practices/assets/files/eks-cluster-config-638253ba22fa7d27da64bb220b6ec663.yaml" target="_blank">eks-cluster-config.yaml</a>.
This template will create a new cluster with EKS.</p>
<p>Edit the template file and set your region to one of the available regions for AMP:</p>
<ul>
<li><code>us-east-1</code></li>
<li><code>us-east-2</code></li>
<li><code>us-west-2</code></li>
<li><code>eu-central-1</code></li>
<li><code>eu-west-1</code></li>
</ul>
<p>Make sure to overwrite this region in your session, for example, in the Bash
shell:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">export AWS_REGION=eu-west-1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Create your cluster using the following command:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">eksctl create cluster -f eks-cluster-config.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This creates an EKS cluster named <code>AMP-EKS-CLUSTER</code> and a service account
named <code>appmesh-controller</code> that will be used by the App Mesh controller for EKS.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="install-app-mesh-controller">Install App Mesh Controller<a class="hash-link" aria-label="Direct link to Install App Mesh Controller" title="Direct link to Install App Mesh Controller" href="/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg#install-app-mesh-controller">​</a></h3>
<p>Next, we will run the below commands to install the <a href="https://docs.aws.amazon.com/app-mesh/latest/userguide/getting-started-kubernetes.html" target="_blank" rel="noopener noreferrer">App Mesh Controller</a>
and configure the Custom Resource Definitions (CRDs):</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm repo add eks https://aws.github.io/eks-charts</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm upgrade -i appmesh-controller eks/appmesh-controller \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     --namespace appmesh-system \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     --set region=${AWS_REGION} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     --set serviceAccount.create=false \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     --set serviceAccount.name=appmesh-controller</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="set-up-amp">Set up AMP<a class="hash-link" aria-label="Direct link to Set up AMP" title="Direct link to Set up AMP" href="/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg#set-up-amp">​</a></h3>
<p>The AMP workspace is used to ingest the Prometheus metrics collected from Envoy.
A workspace is a logical Cortex server dedicated to a tenant. A workspace supports
fine-grained access control for authorizing its management such as update, list,
describe, and delete, and the ingestion and querying of metrics.</p>
<p>Create a workspace using the AWS CLI:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">aws amp create-workspace --alias AMP-APPMESH --region $AWS_REGION</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Add the necessary Helm repositories:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm repo add prometheus-community https://prometheus-community.github.io/helm-charts &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm repo add kube-state-metrics https://kubernetes.github.io/kube-state-metrics </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>For more details on AMP check out the <a href="https://docs.aws.amazon.com/prometheus/latest/userguide/AMP-getting-started.html" target="_blank" rel="noopener noreferrer">AMP Getting started</a> guide.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="scraping--ingesting-metrics">Scraping &amp; ingesting metrics<a class="hash-link" aria-label="Direct link to Scraping &amp; ingesting metrics" title="Direct link to Scraping &amp; ingesting metrics" href="/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg#scraping--ingesting-metrics">​</a></h3>
<p>AMP does not directly scrape operational metrics from containerized workloads in a Kubernetes cluster.
You must deploy and manage a Prometheus server or an OpenTelemetry agent such as the
<a href="https://github.com/aws-observability/aws-otel-collector" target="_blank" rel="noopener noreferrer">AWS Distro for OpenTelemetry Collector</a>
or the Grafana Agent to perform this task. In this receipe, we walk you through the
process of configuring the Grafana Agent to scrape the Envoy metrics and analyze them using AMP and AMG.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="configure-grafana-agent">Configure Grafana Agent<a class="hash-link" aria-label="Direct link to Configure Grafana Agent" title="Direct link to Configure Grafana Agent" href="/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg#configure-grafana-agent">​</a></h4>
<p>The Grafana Agent is a lightweight alternative to running a full Prometheus server.
It keeps the necessary parts for discovering and scraping Prometheus exporters and
sending metrics to a Prometheus-compatible backend. The Grafana Agent also includes
native support for AWS Signature Version 4 (Sigv4) for AWS Identity and Access Management (IAM)
authentication.</p>
<p>We now walk you through the steps to configure an IAM role to send Prometheus metrics to AMP.
We install the Grafana Agent on the EKS cluster and forward metrics to AMP.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="configure-permissions">Configure permissions<a class="hash-link" aria-label="Direct link to Configure permissions" title="Direct link to Configure permissions" href="/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg#configure-permissions">​</a></h4>
<p>The Grafana Agent scrapes operational metrics from containerized workloads running in the
EKS cluster and sends them to AMP. Data sent to AMP must be signed with valid AWS credentials
using Sigv4 to authenticate and authorize each client request for the managed service.</p>
<p>The Grafana Agent can be deployed to an EKS cluster to run under the identity of a Kubernetes service account.
With IAM roles for service accounts (IRSA), you can associate an IAM role with a Kubernetes service account
and thus provide IAM permissions to any pod that uses the service account.</p>
<p>Prepare the IRSA setup as follows:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create namespace grafana-agent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export WORKSPACE=$(aws amp list-workspaces | jq -r &#x27;.workspaces[] | select(.alias==&quot;AMP-APPMESH&quot;).workspaceId&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export ROLE_ARN=$(aws iam get-role --role-name EKS-GrafanaAgent-AMP-ServiceAccount-Role --query Role.Arn --output text)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export NAMESPACE=&quot;grafana-agent&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export REMOTE_WRITE_URL=&quot;https://aps-workspaces.$AWS_REGION.amazonaws.com/workspaces/$WORKSPACE/api/v1/remote_write&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You can use the <a href="/observability-best-practices/assets/files/gca-permissions-da5d026b7a99561bc5134fb7575d8e56.sh" target="_blank">gca-permissions.sh</a>
shell script to automate the following steps (note to replace the placeholder variable
<code>YOUR_EKS_CLUSTER_NAME</code> with the name of your EKS cluster):</p>
<ul>
<li>Creates an IAM role named <code>EKS-GrafanaAgent-AMP-ServiceAccount-Rol</code>e with an IAM policy that has permissions to remote-write into an AMP workspace.</li>
<li>Creates a Kubernetes service account named <code>grafana-agent</code> under the <code>grafana-agent</code> namespace that is associated with the IAM role.</li>
<li>Creates a trust relationship between the IAM role and the OIDC provider hosted in your Amazon EKS cluster.</li>
</ul>
<p>You need <code>kubectl</code> and <code>eksctl</code> CLI tools to run the <code>gca-permissions.sh</code> script.
They must be configured to access your Amazon EKS cluster.</p>
<p>Now create a manifest file, <a href="/observability-best-practices/assets/files/grafana-agent-fe9dfb058034910773da075aa50ad119.yaml" target="_blank">grafana-agent.yaml</a>,
with the scrape configuration to extract Envoy metrics and deploy the Grafana Agent.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>At time of writing, this solution will not work for EKS on Fargate
due to the lack of support for daemon sets there.</p></div></div>
<p>The example deploys a daemon set named <code>grafana-agent</code> and a deployment named
<code>grafana-agent-deployment</code>. The <code>grafana-agent</code> daemon set collects metrics
from pods on the cluster and the <code>grafana-agent-deployment</code> deployment collects
metrics from services that do not live on the cluster, such as the EKS control plane.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f grafana-agent.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After the <code>grafana-agent</code> is deployed, it will collect the metrics and ingest
them into the specified AMP workspace. Now deploy a sample application on the
EKS cluster and start analyzing the metrics.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sample-application">Sample application<a class="hash-link" aria-label="Direct link to Sample application" title="Direct link to Sample application" href="/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg#sample-application">​</a></h2>
<p>To install an application and inject an Envoy container, we use the AppMesh controller for Kubernetes.</p>
<p>First, install the base application by cloning the examples repo:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/aws/aws-app-mesh-examples.git</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And now apply the resources to your cluster:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f aws-app-mesh-examples/examples/apps/djapp/1_base_application</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Check the pod status and make sure it is running:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl -n prod get all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                            READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/dj-cb77484d7-gx9vk          1/1     Running   0          6m8s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/jazz-v1-6b6b6dd4fc-xxj9s    1/1     Running   0          6m8s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/metal-v1-584b9ccd88-kj7kf   1/1     Running   0          6m8s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Next, install the App Mesh controller and meshify the deployment:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f aws-app-mesh-examples/examples/apps/djapp/2_meshed_application/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rollout restart deployment -n prod dj jazz-v1 metal-v1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now we should see two containers running in each pod:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl -n prod get all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                        READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dj-7948b69dff-z6djf         2/2     Running   0          57s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jazz-v1-7cdc4fc4fc-wzc5d    2/2     Running   0          57s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metal-v1-7f499bb988-qtx7k   2/2     Running   0          57s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Generate the traffic for 5 mins and we will visualize it AMG later:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dj_pod=`kubectl get pod -n prod --no-headers -l app=dj -o jsonpath=&#x27;{.items[*].metadata.name}&#x27;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">loop_counter=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">while [ $loop_counter -le 300 ] ; do \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl exec -n prod -it $dj_pod  -c dj \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- curl jazz.prod.svc.cluster.local:9080 ; echo ; loop_counter=$[$loop_counter+1] ; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">done</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-an-amg-workspace">Create an AMG workspace<a class="hash-link" aria-label="Direct link to Create an AMG workspace" title="Direct link to Create an AMG workspace" href="/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg#create-an-amg-workspace">​</a></h3>
<p>To create an AMG workspace follow the steps in the <a href="https://aws.amazon.com/blogs/mt/amazon-managed-grafana-getting-started/" target="_blank" rel="noopener noreferrer">Getting Started with AMG</a> blog post.
To grant users access to the dashboard, you must enable AWS SSO. After you create the workspace, you can assign access to the Grafana workspace to an individual user or a user group.
By default, the user has a user type of viewer. Change the user type based on the user role. Add the AMP workspace as the data source and then start creating the dashboard.</p>
<p>In this example, the user name is <code>grafana-admin</code> and the user type is <code>Admin</code>.
Select the required data source. Review the configuration, and then choose <code>Create workspace</code>.</p>
<p><img decoding="async" loading="lazy" alt="Creating AMP Workspace" src="/observability-best-practices/assets/images/workspace-creation-403f403cf7493dddcb3351e74e87cad6.png" width="1440" height="526" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configure-amg-datasource">Configure AMG datasource<a class="hash-link" aria-label="Direct link to Configure AMG datasource" title="Direct link to Configure AMG datasource" href="/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg#configure-amg-datasource">​</a></h3>
<p>To configure AMP as a data source in AMG, in the <code>Data sources</code> section, choose
<code>Configure in Grafana</code>, which will launch a Grafana workspace in the browser.
You can also manually launch the Grafana workspace URL in the browser.</p>
<p><img decoding="async" loading="lazy" alt="Configuring Datasource" src="/observability-best-practices/assets/images/configuring-amp-datasource-32c4c6a83188d7a71e1fa28784c1274d.png" width="1656" height="1218" class="img_ev3q"></p>
<p>As you can see from the screenshots, you can view Envoy metrics like downstream
latency, connections, response code, and more. You can use the filters shown to
drill down to the envoy metrics of a particular application.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configure-amg-dashboard">Configure AMG dashboard<a class="hash-link" aria-label="Direct link to Configure AMG dashboard" title="Direct link to Configure AMG dashboard" href="/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg#configure-amg-dashboard">​</a></h3>
<p>After the data source is configured, import a custom dashboard to analyze the Envoy metrics.
For this we use a pre-defined dashboard, so choose <code>Import</code> (shown below), and
then enter the ID <code>11022</code>. This will import the Envoy Global dashboard so you can
start analyzing the Envoy metrics.</p>
<p><img decoding="async" loading="lazy" alt="Custom Dashboard" src="/observability-best-practices/assets/images/import-dashboard-23920a9362a89085cd907e27531bd6d5.png" width="1190" height="322" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configure-alerts-on-amg">Configure alerts on AMG<a class="hash-link" aria-label="Direct link to Configure alerts on AMG" title="Direct link to Configure alerts on AMG" href="/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg#configure-alerts-on-amg">​</a></h3>
<p>You can configure Grafana alerts when the metric increases beyond the intended threshold.
With AMG, you can configure how often the alert must be evaluated in the dashboard and send the notification.
Before you create alert rules, you must create a notification channel.</p>
<p>In this example, configure Amazon SNS as a notification channel. The SNS topic must be
prefixed with <code>grafana</code> for notifications to be successfully published to the topic
if you use the defaults, that is, the <a href="https://docs.aws.amazon.com/grafana/latest/userguide/AMG-manage-permissions.html#AMG-service-managed-account" target="_blank" rel="noopener noreferrer">service-managed permissions</a>.</p>
<p>Use the following command to create an SNS topic named <code>grafana-notification</code>:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">aws sns create-topic --name grafana-notification</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And subscribe to it via an email address. Make sure you specify the region and Account ID in the
below command:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">aws sns subscribe \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --topic-arn arn:aws:sns:&lt;region&gt;:&lt;account-id&gt;:grafana-notification \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	--protocol email \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	--notification-endpoint &lt;email-id&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now, add a new notification channel from the Grafana dashboard.
Configure the new notification channel named grafana-notification. For Type,
use AWS SNS from the drop down. For Topic, use the ARN of the SNS topic you just created.
For Auth provider, choose AWS SDK Default.</p>
<p><img decoding="async" loading="lazy" alt="Creating Notification Channel" src="/observability-best-practices/assets/images/alert-configuration-309c1b689c37ddd01054aec3f8e52664.png" width="1310" height="1214" class="img_ev3q"></p>
<p>Now configure an alert if downstream latency exceeds five milliseconds in a one-minute period.
In the dashboard, choose Downstream latency from the dropdown, and then choose Edit.
On the Alert tab of the graph panel, configure how often the alert rule should be evaluated
and the conditions that must be met for the alert to change state and initiate its notifications.</p>
<p>In the following configuration, an alert is created if the downstream latency exceeds the
threshold and notification will be sent through the configured grafana-alert-notification channel to the SNS topic.</p>
<p><img decoding="async" loading="lazy" alt="Alert Configuration" src="/observability-best-practices/assets/images/downstream-latency-136785406e3778d28fd1d34646ba97bb.png" width="1322" height="946" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="cleanup">Cleanup<a class="hash-link" aria-label="Direct link to Cleanup" title="Direct link to Cleanup" href="/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg#cleanup">​</a></h2>
<ol>
<li>Remove the resources and cluster:</li>
</ol>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl delete all --all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eksctl delete cluster --name AMP-EKS-CLUSTER</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="2">
<li>Remove the AMP workspace:</li>
</ol>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">aws amp delete-workspace --workspace-id `aws amp list-workspaces --alias prometheus-sample-app --query &#x27;workspaces[0].workspaceId&#x27; --output text`</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="3">
<li>Remove the amp-iamproxy-ingest-role IAM role:</li>
</ol>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">aws delete-role --role-name amp-iamproxy-ingest-role</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="4">
<li>Remove the AMG workspace by removing it from the console.</li>
</ol></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/aws-observability/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a class="table-of-contents__link toc-highlight" href="/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg#infrastructure">Infrastructure</a><ul><li><a class="table-of-contents__link toc-highlight" href="/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg#architecture">Architecture</a></li><li><a class="table-of-contents__link toc-highlight" href="/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg#prerequisites">Prerequisites</a></li><li><a class="table-of-contents__link toc-highlight" href="/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg#setup-an-eks-cluster">Setup an EKS cluster</a></li><li><a class="table-of-contents__link toc-highlight" href="/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg#install-app-mesh-controller">Install App Mesh Controller</a></li><li><a class="table-of-contents__link toc-highlight" href="/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg#set-up-amp">Set up AMP</a></li><li><a class="table-of-contents__link toc-highlight" href="/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg#scraping--ingesting-metrics">Scraping &amp; ingesting metrics</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg#sample-application">Sample application</a><ul><li><a class="table-of-contents__link toc-highlight" href="/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg#create-an-amg-workspace">Create an AMG workspace</a></li><li><a class="table-of-contents__link toc-highlight" href="/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg#configure-amg-datasource">Configure AMG datasource</a></li><li><a class="table-of-contents__link toc-highlight" href="/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg#configure-amg-dashboard">Configure AMG dashboard</a></li><li><a class="table-of-contents__link toc-highlight" href="/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg#configure-alerts-on-amg">Configure alerts on AMG</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/observability-best-practices/docs/recipes/recipes/servicemesh-monitoring-ampamg#cleanup">Cleanup</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Built with ❤️ at AWS. <br> © 2024.  Amazon.com, Inc. or its affiliates. All Rights Reserved.</div></div></div></footer></div>
</body>
</html>