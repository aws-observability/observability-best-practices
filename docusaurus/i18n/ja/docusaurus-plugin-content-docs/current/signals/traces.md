# トレース

トレースは、リクエストがアプリケーションのさまざまなコンポーネントを通過する際の全体的な経路を表します。

ログやメトリクスとは異なり、*トレース*は複数のアプリケーションまたはサービスからのイベントで構成され、レスポンスレイテンシー、サービス障害、リクエストパラメータ、メタデータなど、サービス間の接続に関するコンテキストを含みます。

:::tip
    [ログ](../signals/logs/)とトレースの間には概念的な類似性がありますが、トレースはクロスサービスのコンテキストで考慮されることを意図しているのに対し、ログは通常、単一のサービスまたはアプリケーションの実行に限定されます。
::::::tip
今日の開発者は、モジュール化された分散アプリケーションの構築に傾倒しています。これを[サービス指向アーキテクチャ](https://en.wikipedia.org/wiki/Service-oriented_architecture)と呼ぶ人もいれば、[マイクロサービス](https://aws.amazon.com/microservices/)と呼ぶ人もいます。名前に関係なく、これらの疎結合アプリケーションで問題が発生した場合、ログやイベントを見るだけでは、インシデントの根本原因を突き止めるには不十分な場合があります。リクエストフロー全体を可視化することが不可欠であり、これがトレースが価値を発揮する場面です。エンドツーエンドのリクエストフローを描写する一連の因果関係のあるイベントを通じて、トレースはその可視性を獲得するのに役立ちます。

トレースは、リクエストがシステムに入り、システムから出ていく際のフローに関する基本的な情報を提供するため、オブザーバビリティの重要な柱です。

:::tip
    トレースの一般的なユースケースには、パフォーマンスプロファイリング、本番環境の問題のデバッグ、障害の根本原因分析などがあります。
:::
## すべての統合ポイントをインストルメント化する

ワークロードのすべての機能とコードが 1 か所にある場合、ソースコードを見て、リクエストがさまざまな関数間でどのように渡されるかを簡単に確認できます。システムレベルでは、アプリが実行されているマシンがわかり、問題が発生した場合は、根本原因をすばやく見つけることができます。マイクロサービスベースのアーキテクチャでこれを行うことを想像してみてください。マイクロサービスベースのアーキテクチャでは、さまざまなコンポーネントが疎結合であり、分散環境で実行されています。相互接続された各リクエストのログを確認するために多数のシステムにログインすることは、不可能ではないにしても、非現実的です。

ここでオブザーバビリティが役立ちます。インストルメンテーションは、オブザーバビリティを向上させるための重要なステップです。より広い意味では、インストルメンテーションとは、コードを使用してアプリケーション内のイベントを測定することです。

一般的なインストルメンテーションアプローチは、システムに入る各リクエストに一意のトレース識別子を割り当て、そのトレース ID を異なるコンポーネントを通過する際に引き継ぎながら、追加のメタデータを付加していく方法です。

:::info
    あるサービスから別のサービスへのすべての接続は、中央コレクターにトレースを送信するように計装する必要があります。このアプローチにより、ワークロードの不透明な側面を可視化できます。
:::
:::info
    自動計装エージェントまたはライブラリを使用する場合、アプリケーションの計装はほぼ自動化されたプロセスになります。
:::

## トランザクション時間とステータスは重要なので、測定しましょう！

適切にインストルメント化されたアプリケーションは、エンドツーエンドのトレースを生成できます。これは、次のようなウォーターフォールグラフとして表示できます。

![WaterFall Trace](../images/waterfall-trace.png)

またはサービスマップ:

![servicemap Trace](../images/service-map-trace.png)

すべてのインタラクションに対するトランザクション時間とレスポンスコードを測定することが重要です。これにより、全体的な処理時間を計算し、SLA、SLO、またはビジネス KPI への準拠を追跡するのに役立ちます。

:::info
    インタラクションのレスポンスタイムとステータスコードを理解して記録することによってのみ、全体的なリクエストパターンとワークロードの健全性に寄与する要因を確認できます。
:::
## メタデータ、アノテーション、ラベルは最良の味方です

トレースは永続化され、一意の ID が割り当てられます。各トレースは *span* または *segment*（使用するツールによって異なります）に分割され、リクエストのパス内の各ステップが記録されます。span は、トレースが相互作用するエンティティを示し、親トレースと同様に、各 span には一意の ID とタイムスタンプが割り当てられ、追加のデータとメタデータも含めることができます。この情報は、問題が発生した正確な時刻と場所を示すため、デバッグに役立ちます。

これは実用的な例を通じて最もよく説明できます。e コマースアプリケーションは、認証、認可、配送、在庫、決済処理、フルフィルメント、商品検索、レコメンデーションなど、多くのドメインに分割される場合があります。しかし、これらの相互接続されたすべてのドメインからのトレースを検索するのではなく、トレースに顧客 ID のラベルを付けることで、この 1 人の人物に固有のインタラクションのみを検索できます。これにより、運用上の問題を診断する際に、検索範囲を即座に絞り込むことができます。

:::info
    命名規則はベンダーによって異なる場合がありますが、各トレースにはメタデータ、ラベル、またはアノテーションを追加でき、これらはワークロード全体で検索可能です。追加するにはコードの記述が必要ですが、ワークロードのオブザーバビリティが大幅に向上します。
:::
:::warning
    トレースはログではないため、トレースに含めるメタデータは慎重に選択してください。また、トレースデータは、高いサンプリングレートであっても、フォレンジックや監査を目的としたものではありません。
:::