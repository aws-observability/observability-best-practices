# AWS X-Ray

## サンプリングルール

X-Ray を使用したサンプリングルールは、AWS コンソール、ローカル設定ファイル、またはその両方で設定できます。ローカル設定はコンソールで設定したものよりも優先されます。

info
可能な限り、X-Ray コンソール、API、または CloudFormation を使用してください。これにより、実行時にアプリケーションのサンプリング動作を変更できます。


次の基準ごとに、サンプルレートを個別に設定できます。

* サービス名 (billing、payments など)
* サービスタイプ (EC2、Container など)
* HTTP メソッド
* URL パス
* リソース ARN
* ホスト (www.example.com など)

ベストプラクティスは、問題の診断とパフォーマンスプロファイルの理解に十分なデータを収集しつつ、管理できない量のデータを収集しないようなサンプルレートを設定することです。たとえば、ランディングページのトラフィックの 1% をサンプリングし、支払いページのリクエストの 10% をサンプリングすれば、優れたオブザーバビリティの実践に沿うことになります。

一部のトランザクションでは 100% をキャプチャしたい場合があるかもしれません。ただし、トレースはワークロードへのアクセスの監査証跡として意図されていないので注意が必要です。

warning
トレースは監査や法的分析のために使用することを意図していないため、100% のサンプルレートは避けてください。これにより、X-Ray (デフォルトで UDP エミッターを使用) がトランザクショントレースを決して失わないという誤った期待を生む可能性があります。


原則として、トランザクショントレースのキャプチャは、スタッフやAWS 請求書に過度の負荷をかけるべきではありません。ワークロードから発生するデータ量を学びながら、徐々にトレースを環境に追加してください。

info
デフォルトでは、X-Ray SDK は 1 秒ごとの最初のリクエストと、追加のリクエストの 5% を記録します。
許容できるリザーバサイズを必ず設定してください。リザーバサイズは、キャプチャするリクエストの最大数を 1 秒あたりで決定します。これにより、悪意のある攻撃、望まれない課金、設定エラーから保護されます。


## デーモンの設定

X-Ray デーモンは、テレメトリを X-Ray データプレーンに送信する作業を軽減することを目的としています。そのため、ソースアプリケーションが実行されるサーバー、コンテナ、またはインスタンスで多くのリソースを消費してはいけません。

info
ベストプラクティスは、X-Ray デーモンを別のインスタンスまたはコンテナで実行することです。これにより、[関心の分離](../faq/#what-is-the-separation-of-concerns) が強制され、ソースシステムが負荷をかけられることがなくなります。


info
Kubernetes などのコンテナオーケストレーションパターンでは、X-Ray デーモンをサイドカーとして運用するのが一般的な実践です。


デーモンには安全なデフォルト設定があり、ほとんどの場合、EC2、ECS、EKS、または Fargate 環境で追加の設定なしで動作できます。ただし、ハイブリッドおよびその他のクラウド環境では、Direct Connect または VPN を使用してリモート環境を統合する場合、[VPC エンドポイント](https://docs.aws.amazon.com/ja_jp/vpc/latest/privatelink/concepts.html) を反映するように `Endpoint` を調整する必要があるかもしれません。

tip
ソースアプリケーションと同じインスタンスまたは仮想マシン上で X-Ray デーモンを実行する必要がある場合は、X-Ray が許容できるシステムリソースを超えて消費しないように `TotalBufferSizeMB` 設定を行うことを検討してください。


## アノテーション

AWS X-Ray では、トレースに任意のメタデータを送信することができます。これらは *アノテーション* と呼ばれます。アノテーションは、トレースを論理的にグループ化できる強力な機能です。アノテーションはインデックス化されているため、単一のエンティティに関連するトレースを簡単に見つけることができます。

X-Ray の自動インストルメンテーション SDK を使用する場合、アノテーションが自動的に表示されないことがあります。コードにアノテーションを追加する必要があり、これによりトレースが大幅に強化され、X-Ray Insights の生成、アノテーションに基づくメトリクス、アラーム、システム動作からの異常検知モデル、ユーザーに影響を与えるコンポーネントが観測された際のチケット発行と修復の自動化が可能になります。

alert{type="info"}
アノテーションを使用して、環境内のデータフローを理解します。


alert{type="info"}
アノテーション付きトレースのパフォーマンスと結果に基づいてアラームを作成します。
