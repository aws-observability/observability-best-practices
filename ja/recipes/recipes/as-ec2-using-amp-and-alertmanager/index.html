<!doctype html>
<html lang="ja" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-recipes/recipes/as-ec2-using-amp-and-alertmanager" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Amazon Managed Service for Prometheus と Alert Manager を使用した Amazon EC2 の自動スケーリング | AWS Observability Best Practices</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://aws-observability.github.io/observability-best-practices/ja/recipes/recipes/as-ec2-using-amp-and-alertmanager"><meta data-rh="true" property="og:locale" content="ja"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" name="docusaurus_locale" content="ja"><meta data-rh="true" name="docsearch:language" content="ja"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Amazon Managed Service for Prometheus と Alert Manager を使用した Amazon EC2 の自動スケーリング | AWS Observability Best Practices"><meta data-rh="true" name="description" content="お客様は、既存の Prometheus ワークロードをクラウドに移行し、クラウドが提供するすべての機能を活用したいと考えています。AWS には EC2 Auto Scaling のようなサービスがあり、CPU やメモリ使用率などのメトリクスに基づいて Amazon Elastic Compute Cloud (Amazon EC2) インスタンスをスケールアウトできます。Prometheus メトリクスを使用するアプリケーションは、監視スタックを置き換えることなく、EC2 Auto Scaling に簡単に統合できます。このポストでは、Amazon Managed Service for Prometheus Alert Manager と連携するように Amazon EC2 Auto Scaling を設定する方法を説明します。このアプローチにより、自動スケーリングなどのサービスを活用しながら、Prometheus ベースのワークロードをクラウドに移行できます。"><meta data-rh="true" property="og:description" content="お客様は、既存の Prometheus ワークロードをクラウドに移行し、クラウドが提供するすべての機能を活用したいと考えています。AWS には EC2 Auto Scaling のようなサービスがあり、CPU やメモリ使用率などのメトリクスに基づいて Amazon Elastic Compute Cloud (Amazon EC2) インスタンスをスケールアウトできます。Prometheus メトリクスを使用するアプリケーションは、監視スタックを置き換えることなく、EC2 Auto Scaling に簡単に統合できます。このポストでは、Amazon Managed Service for Prometheus Alert Manager と連携するように Amazon EC2 Auto Scaling を設定する方法を説明します。このアプローチにより、自動スケーリングなどのサービスを活用しながら、Prometheus ベースのワークロードをクラウドに移行できます。"><link data-rh="true" rel="icon" href="/observability-best-practices/ja/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://aws-observability.github.io/observability-best-practices/ja/recipes/recipes/as-ec2-using-amp-and-alertmanager"><link data-rh="true" rel="alternate" href="https://aws-observability.github.io/observability-best-practices/recipes/recipes/as-ec2-using-amp-and-alertmanager" hreflang="en"><link data-rh="true" rel="alternate" href="https://aws-observability.github.io/observability-best-practices/ja/recipes/recipes/as-ec2-using-amp-and-alertmanager" hreflang="ja"><link data-rh="true" rel="alternate" href="https://aws-observability.github.io/observability-best-practices/recipes/recipes/as-ec2-using-amp-and-alertmanager" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/observability-best-practices/ja/blog/rss.xml" title="AWS Observability Best Practices RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/observability-best-practices/ja/blog/atom.xml" title="AWS Observability Best Practices Atom Feed"><link rel="stylesheet" href="/observability-best-practices/ja/assets/css/styles.c966ebab.css">
<script src="/observability-best-practices/ja/assets/js/runtime~main.a0938694.js" defer="defer"></script>
<script src="/observability-best-practices/ja/assets/js/main.ee8f381b.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="メインコンテンツまでスキップ"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">メインコンテンツまでスキップ</a></div><nav aria-label="ナビゲーション" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="ナビゲーションバーを開く" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/observability-best-practices/ja/"><div class="navbar__logo"><img src="/observability-best-practices/ja/img/logo.svg" alt="AWS Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/observability-best-practices/ja/img/logo.svg" alt="AWS Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">AWS Observability Best Practices</b></a><a class="navbar__item navbar__link" href="/observability-best-practices/ja/home">Home</a><a class="navbar__item navbar__link" href="/observability-best-practices/ja/guides/">Guides</a><a class="navbar__item navbar__link" href="/observability-best-practices/ja/signals/logs">Signals</a><a class="navbar__item navbar__link" href="/observability-best-practices/ja/tools/observability_accelerator">Tools</a><a class="navbar__item navbar__link" href="/observability-best-practices/ja/recipes/">Recipes</a><a class="navbar__item navbar__link" href="/observability-best-practices/ja/faq/general">FAQ</a><a class="navbar__item navbar__link" href="/observability-best-practices/ja/patterns/Tracing/xrayec2">Patterns</a><a class="navbar__item navbar__link" href="/observability-best-practices/ja/persona/cloud_engineer">Persona</a><a class="navbar__item navbar__link" href="/observability-best-practices/ja/resources/">Resources</a><a class="navbar__item navbar__link" href="/observability-best-practices/ja/contributors">Contributors</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>日本語</a><ul class="dropdown__menu"><li><a href="/observability-best-practices/recipes/recipes/as-ec2-using-amp-and-alertmanager" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li><li><a href="/observability-best-practices/ja/recipes/recipes/as-ec2-using-amp-and-alertmanager" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="ja">日本語</a></li></ul></div><a href="https://github.com/aws-observability/observability-best-practices" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="システムモード" aria-label="ダークモードを切り替える(現在はシステムモード)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="先頭へ戻る" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><main class="docMainContainer_TBSr docMainContainerEnhanced_lQrH"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">このページの見出し</button></div><div class="theme-doc-markdown markdown"><header><h1>Amazon Managed Service for Prometheus  と Alert Manager を使用した Amazon EC2 の自動スケーリング</h1></header>
<p>お客様は、既存の Prometheus ワークロードをクラウドに移行し、クラウドが提供するすべての機能を活用したいと考えています。AWS には <a href="https://aws.amazon.com/jp/ec2/autoscaling/" target="_blank" rel="noopener noreferrer" class="">EC2 Auto Scaling</a> のようなサービスがあり、CPU やメモリ使用率などのメトリクスに基づいて <a href="https://aws.amazon.com/jp/pm/ec2/" target="_blank" rel="noopener noreferrer" class="">Amazon Elastic Compute Cloud (Amazon EC2)</a> インスタンスをスケールアウトできます。Prometheus メトリクスを使用するアプリケーションは、監視スタックを置き換えることなく、EC2 Auto Scaling に簡単に統合できます。このポストでは、<a href="https://aws.amazon.com/jp/prometheus/" target="_blank" rel="noopener noreferrer" class="">Amazon Managed Service for Prometheus Alert Manager</a> と連携するように Amazon EC2 Auto Scaling を設定する方法を説明します。このアプローチにより、自動スケーリングなどのサービスを活用しながら、Prometheus ベースのワークロードをクラウドに移行できます。</p>
<p>Amazon Managed Service for Prometheus は、<a href="https://prometheus.io/docs/prometheus/latest/querying/basics/" target="_blank" rel="noopener noreferrer" class="">PromQL</a> を使用する<a href="https://docs.aws.amazon.com/ja_jp/prometheus/latest/userguide/AMP-Ruler.html" target="_blank" rel="noopener noreferrer" class="">アラートルール</a>をサポートしています。<a href="https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/" target="_blank" rel="noopener noreferrer" class="">Prometheus アラートルールのドキュメント</a>には、有効なアラートルールの構文と例が記載されています。同様に、Prometheus Alert Manager のドキュメ  ントには、有効な Alert Manager 設定の<a href="https://prometheus.io/docs/prometheus/latest/configuration/template_reference/" target="_blank" rel="noopener noreferrer" class="">構文</a>と<a href="https://prometheus.io/docs/prometheus/latest/configuration/template_examples/" target="_blank" rel="noopener noreferrer" class="">例</a>が記載されています。</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="ソリューション概要">ソリューション概要<a href="#ソリューション概要" class="hash-link" aria-label="ソリューション概要 への直接リンク" title="ソリューション概要 への直接リンク" translate="no">​</a></h2>
<p>まず、Amazon EC2 Auto Scaling の <a href="https://docs.aws.amazon.com/ja_jp/autoscaling/ec2/userguide/auto-scaling-groups.html" target="_blank" rel="noopener noreferrer" class="">Auto Scaling グループ</a> の概念について簡単に確認しましょう。Auto Scaling グループは、Amazon EC2 インスタンスの論理的なコレクションです。Auto Scaling グループは、事前に定義された起動テンプレートに基づいて EC2 インスタンスを起動できます。<a href="https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/ec2-launch-templates.html" target="_blank" rel="noopener noreferrer" class="">起動テンプレート</a> には、AMI ID、インスタンスタイプ、ネットワーク設定、<a href="https://aws.amazon.com/jp/iam/" target="_blank" rel="noopener noreferrer" class="">AWS Identity and Access Management (IAM)</a> インスタンスプロファイルなど、Amazon EC2 インスタンスの起動に使用される情報が含まれています。</p>
<p>Amazon EC2 Auto Scaling グループには、<a href="https://docs.aws.amazon.com/ja_jp/autoscaling/ec2/userguide/what-is-amazon-ec2-auto-scaling.html" target="_blank" rel="noopener noreferrer" class="">最小サイズ、最大サイズ、および希望容量</a> の概念があります。Amazon EC2 Auto Scaling は、Auto Scaling グループの現在の実行容量が希望容量を上回るか下回ると検出すると、必要に応じて自動的にスケールアウトまたはスケールインを行います。このスケーリングアプローチにより、容量とコストの両方に制限を設けながら、ワークロード内の弾力性を活用できます。</p>
<p>このソリューションを実証するために、2 つの Amazon EC2 インスタンスを含む Amazon EC2 Auto Scaling グループを作成しました。これらのインスタンスは、<a href="https://docs.aws.amazon.com/ja_jp/prometheus/latest/userguide/AMP-onboard-ingest-metrics-remote-write-EC2.html" target="_blank" rel="noopener noreferrer" class="">インスタンスメトリクスをリモートで書き込み</a>、Amazon Managed Service for Prometheus ワークスペースに送信します。Auto Scaling グループの最小サイズを 2（高可用性を維持するため）に設定し、グループの最大サイズを 10（コストを抑制するため）に設定しました。トラフィックが増加すると、負荷をサポートするために Amazon EC2 インスタンスが Auto Scaling グループの最大サイズまで自動的に追加されます。負荷が減少すると、Auto Scaling グループがグループの最小サイズに達するまで、それらの Amazon EC2 インスタンスは終了されます。このアプローチにより、クラウドの弾力性を活用してパフォーマンスの高いアプリケーションを実現できます。</p>
<p>リソースのスクレイピングが増えるにつれて、単一の Prometheus サーバーの能力を簡単に超えてしまう可能性があることに注意してください。この状況を回避するには、Prometheus サーバーをワークロードに合わせて線形にスケーリングします。このアプローチにより、必要な粒度でメトリクスデータを収集できます。</p>
<p>Prometheus ワークロードの Auto Scaling をサポートするために、以下のルールを持つ Amazon Managed Service for Prometheus ワークスペースを作成しました：</p>
<p><code>YAML</code></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">groups:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- name: example</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - alert: HostHighCpuLoad</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    expr: 100 - (avg(rate(node_cpu_seconds_total{mode=&quot;idle&quot;}[2m])) * 100) &gt; 60</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for: 5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      severity: warning</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      event_type: scale_up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      summary: Host high CPU load (instance {{ $labels.instance }})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      description: &quot;CPU load is &gt; 60%\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - alert: HostLowCpuLoad</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    expr: 100 - (avg(rate(node_cpu_seconds_total{mode=&quot;idle&quot;}[2m])) * 100) &lt; 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for: 5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      severity: warning</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      event_type: scale_down</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      summary: Host low CPU load (instance {{ $labels.instance }})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      description: &quot;CPU load is &lt; 30%\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>このルールセットは、<code>HostHighCpuLoad</code> と <code>HostLowCpuLoad</code> のルールを作成します。これらのアラートは、5 分間の CPU 使用率が 60% を超えるか、30% を下回った場合にトリガーされます。</p>
<p>アラートが発生すると、アラートマネージャーは <code>alert_type</code>（アラート名）と <code>event_type</code>（scale_down または scale_up）を含むメッセージを Amazon SNS トピックに転送します。</p>
<p><code>YAML</code></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">alertmanager_config: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  route: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    receiver: default_receiver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    repeat_interval: 5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  receivers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: default_receiver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      sns_configs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - topic_arn: &lt;ARN OF SNS TOPIC GOES HERE&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          send_resolved: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          sigv4:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            region: us-east-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          message: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            alert_type: {{ .CommonLabels.alertname }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            event_type: {{ .CommonLabels.event_type }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>AWS <a href="https://aws.amazon.com/jp/lambda/" target="_blank" rel="noopener noreferrer" class="">Lambda</a> 関数が Amazon SNS トピックをサブスクライブしています。Lambda 関数には、Amazon SNS メッセージを検査して <code>scale_up</code> または <code>scale_down</code> イベントを判断するロジックを実装しています。その後、Lambda 関数は Amazon EC2 Auto Scaling グループの希望容量を増減します。Amazon EC2 Auto Scaling グループは容量の変更要求を検出し、Amazon EC2 インスタンスを起動または終了します。</p>
<p>Auto Scaling をサポートする Lambda コードは以下の通りです：</p>
<p><code>Python</code></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import boto3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def lambda_handler(event, context):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(event)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    msg = event[&#x27;Records&#x27;][0][&#x27;Sns&#x27;][&#x27;Message&#x27;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    scale_type = &#x27;&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if msg.find(&#x27;scale_up&#x27;) &gt; -1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        scale_type = &#x27;scale_up&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        scale_type = &#x27;scale_down&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    get_desired_instance_count(scale_type)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def get_desired_instance_count(scale_type):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    client = boto3.client(&#x27;autoscaling&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    asg_name = os.environ[&#x27;ASG_NAME&#x27;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    response = client.describe_auto_scaling_groups(AutoScalingGroupNames=[ asg_name])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    minSize = response[&#x27;AutoScalingGroups&#x27;][0][&#x27;MinSize&#x27;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    maxSize = response[&#x27;AutoScalingGroups&#x27;][0][&#x27;MaxSize&#x27;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    desiredCapacity = response[&#x27;AutoScalingGroups&#x27;][0][&#x27;DesiredCapacity&#x27;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if scale_type == &quot;scale_up&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        desiredCapacity = min(desiredCapacity+1, maxSize)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if scale_type == &quot;scale_down&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        desiredCapacity = max(desiredCapacity - 1, minSize)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&#x27;Scale type: {}; new capacity: {}&#x27;.format(scale_type, desiredCapacity))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    response = client.set_desired_capacity(AutoScalingGroupName=asg_name, DesiredCapacity=desiredCapacity, HonorCooldown=False)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>完全なアーキテクチャは以下の図で確認できます。</p>
<p><img decoding="async" loading="lazy" alt="Architecture" src="/observability-best-practices/ja/assets/images/as-ec2-amp-alertmanager3-a7f7c99c80d1b4696adcea6abcaaf46e.png" width="1411" height="1081" class="img_ev3q"></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="ソリューションのテスト">ソリューションのテスト<a href="#ソリューションのテスト" class="hash-link" aria-label="ソリューションのテスト への直接リンク" title="ソリューションのテスト への直接リンク" translate="no">​</a></h2>
<p>AWS CloudFormation テンプレートを起動して、このソリューションを自動的にプロビジョニングできます。</p>
<p>スタックの前提条件：</p>
<ul>
<li class=""><a href="https://aws.amazon.com/jp/vpc/" target="_blank" rel="noopener noreferrer" class="">Amazon Virtual Private Cloud (Amazon VPC)</a></li>
<li class="">アウトバウンドトラフィックを許可する AWS セキュリティグループ</li>
</ul>
<p>Download Launch Stack Template リンクを選択して、アカウントでテンプレートをダウンロードしてセットアップします。設定プロセスの一部として、Amazon EC2 インスタンスに関連付けるサブネットとセキュリティグループを指定する必要があります。詳細は次の図を参照してください。</p>
<p><a href="https://prometheus-autoscale.s3.amazonaws.com/prometheus-autoscale.template" target="_blank" rel="noopener noreferrer" class="">## Download Launch Stack Template </a></p>
<p><img decoding="async" loading="lazy" alt="Launch Stack" src="/observability-best-practices/ja/assets/images/as-ec2-amp-alertmanager4-63dab0d7230022913dfb7193f39cce88.png" width="1415" height="1315" class="img_ev3q"></p>
<p>これは CloudFormation スタックの詳細画面で、スタック名は prometheus-autoscale に設定されています。スタックのパラメータには、Prometheus の Linux インストーラーの URL、Prometheus の Linux Node Exporter の URL、ソリューションで使用されるサブネットとセキュリティグループ、使用する AMI とインスタンスタイプ、Amazon EC2 Auto Scaling グループの最大容量が含まれています。</p>
<p>スタックのデプロイには約 8 分かかります。完了すると、作成された Amazon EC2 Auto Scaling グループ内で 2 つ の Amazon EC2 インスタンスがデプロイされ、実行されていることがわかります。Amazon Managed Service for Prometheus Alert Manager を介した自動スケーリングのソリューションを検証するために、<a href="https://docs.aws.amazon.com/ja_jp/systems-manager/latest/userguide/execute-remote-commands.html" target="_blank" rel="noopener noreferrer" class="">AWS Systems Manager Run Command</a> と <a href="https://docs.aws.amazon.com/ja_jp/fis/latest/userguide/actions-ssm-agent.html" target="_blank" rel="noopener noreferrer" class="">AWSFIS-Run-CPU-Stress 自動化ドキュメント</a> を使用して Amazon EC2 インスタンスに負荷をかけます。</p>
<p>Amazon EC2 Auto Scaling グループの CPU にストレスがかかると、Alert Manager がこれらのアラートを発行し、Lambda 関数が Auto Scaling グループをスケールアップすることで応答します。CPU 使用率が低下すると、Amazon Managed Service for Prometheus ワークスペースで CPU 低下アラートが発生し、Alert Manager がアラートを Amazon SNS トピックに発行し、Lambda 関数が Auto Scaling グループをスケールダウンすることで応答します。これは次の図で示されています。</p>
<p><img decoding="async" loading="lazy" alt="Dashboard" src="/observability-best-practices/ja/assets/images/as-ec2-amp-alertmanager5-844cc9ab4fa8958fb3db3b86b52d8df5.png" width="1405" height="702" class="img_ev3q"></p>
<p>Grafana ダッシュボードには、CPU が 100% までスパイクしたことを示す線があります。CPU が高くなっていますが、別の線はインスタンス数が 2 から 10 に段階的に増加したことを示しています。CPU が低下すると、インスタンス数は徐々に 2 まで減少します。</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="コスト">コスト<a href="#コスト" class="hash-link" aria-label="コスト への直接リンク" title="コスト への 直接リンク" translate="no">​</a></h2>
<p>Amazon Managed Service for Prometheus は、取り込まれたメトリクス、保存されたメトリクス、クエリされたメトリクスに基づいて料金が設定されています。最新の料金と料金例については、<a href="https://aws.amazon.com/jp/prometheus/pricing/" target="_blank" rel="noopener noreferrer" class="">Amazon Managed Service for Prometheus の料金ページ</a>をご覧ください。</p>
<p>Amazon SNS は、月間の API リクエスト数に基づいて料金が設定されています。Amazon SNS と Lambda 間のメッセージ配信は無料ですが、Amazon SNS と Lambda 間のデータ転送量に対して料金が発生します。<a href="https://aws.amazon.com/jp/sns/pricing/" target="_blank" rel="noopener noreferrer" class="">最新の Amazon SNS の料金詳細</a>をご覧ください。</p>
<p>Lambda は、関数の実行時間と関数へのリクエスト数に基づいて料金が設定されています。<a href="https://aws.amazon.com/jp/lambda/pricing/" target="_blank" rel="noopener noreferrer" class="">最新の AWS Lambda の料金詳細</a>をご覧ください。</p>
<p>Amazon EC2 Auto Scaling の使用には<a href="https://aws.amazon.com/jp/ec2/autoscaling/pricing/" target="_blank" rel="noopener noreferrer" class="">追加料金はかかりません</a>。</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="まとめ">まとめ<a href="#まとめ" class="hash-link" aria-label="まとめ への直接リンク" title="まとめ への直接リンク" translate="no">​</a></h2>
<p>Amazon Managed Service for Prometheus、Alert Manager、Amazon SNS、Lambda を使用することで、Amazon EC2 Auto Scaling グループのスケーリングアクティビティを制御できます。このソリューションでは、Amazon EC2 Auto Scaling を活用しながら、既存の Prometheus ワークロードを AWS に移行する方法を示しています。アプリケーションの負荷 が増加すると、需要に応じてシームレスにスケールします。</p>
<p>この例では、Amazon EC2 Auto Scaling グループは CPU に基づいてスケールしましたが、ワークロードからの任意の Prometheus メトリクスに対して同様のアプローチを取ることができます。このアプローチにより、スケーリングアクションをきめ細かく制御でき、ビジネス価値が最も高いメトリクスに基づいてワークロードをスケールできます。</p>
<p>以前のブログ記事では、<a href="https://aws.amazon.com/blogs/mt/using-amazon-managed-service-for-prometheus-alert-manager-to-receive-alerts-with-pagerduty/" target="_blank" rel="noopener noreferrer" class="">Amazon Managed Service for Prometheus Alert Manager を使用して PagerDuty でアラートを受信する方法</a> や、<a href="https://aws.amazon.com/blogs/mt/how-to-integrate-amazon-managed-service-for-prometheus-with-slack/" target="_blank" rel="noopener noreferrer" class="">Amazon Managed Service for Prometheus を Slack と統合する方法</a> についても説明しました。これらのソリューションは、最も有用な方法でワークスペースからアラートを受信する方法を示しています。</p>
<p>次のステップとして、Amazon Managed Service for Prometheus 用の<a href="https://docs.aws.amazon.com/ja_jp/prometheus/latest/userguide/AMP-rules-upload.html" target="_blank" rel="noopener noreferrer" class="">独自のルール設定ファイルを作成</a>し、独自の<a href="https://docs.aws.amazon.com/ja_jp/prometheus/latest/userguide/AMP-alertmanager-receiver.html" target="_blank" rel="noopener noreferrer" class="">アラートレシーバー</a>をセットアップする方法を確認してください。さらに、Alert Manager 内で使用できるアラートルールの優れた例については、Awesome Prometheus alerts をご覧ください。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/aws-observability/observability-best-practices/blob/main/docusaurus/docs/recipes/recipes/as-ec2-using-amp-and-alertmanager.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>このページを編集</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="ドキュメントページ"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#ソリューション概要" class="table-of-contents__link toc-highlight">ソリューション概要</a></li><li><a href="#ソリューションのテスト" class="table-of-contents__link toc-highlight">ソリューションのテスト</a></li><li><a href="#コスト" class="table-of-contents__link toc-highlight">コスト</a></li><li><a href="#まとめ" class="table-of-contents__link toc-highlight">まとめ</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Built with ❤️ at AWS. <br> © 2026.  Amazon.com, Inc. or its affiliates. All Rights Reserved.</div></div></div></footer></div>
</body>
</html>