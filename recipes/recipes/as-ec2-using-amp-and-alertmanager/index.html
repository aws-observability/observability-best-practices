<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-recipes/recipes/as-ec2-using-amp-and-alertmanager" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Auto-scaling Amazon EC2 using Amazon Managed Service for Prometheus and alert manager | AWS Observability Best Practices</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://aws-observability.github.io/observability-best-practices/recipes/recipes/as-ec2-using-amp-and-alertmanager"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" property="og:locale:alternate" content="ja"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Auto-scaling Amazon EC2 using Amazon Managed Service for Prometheus and alert manager | AWS Observability Best Practices"><meta data-rh="true" name="description" content="Customers want to migrate their existing Prometheus workloads to the cloud and utilize all that the cloud offers. AWS has services like Amazon EC2 Auto Scaling, which lets you scale out Amazon Elastic Compute Cloud (Amazon EC2) instances based on metrics like CPU or memory utilization. Applications that use Prometheus metrics can easily integrate into EC2 Auto Scaling without needing to replace their monitoring stack. In this post, I will walk you through configuring Amazon EC2 Auto Scaling to work with Amazon Managed Service for Prometheus Alert Manager. This approach lets you move a Prometheus-based workload to the cloud while taking advantage of services like autoscaling."><meta data-rh="true" property="og:description" content="Customers want to migrate their existing Prometheus workloads to the cloud and utilize all that the cloud offers. AWS has services like Amazon EC2 Auto Scaling, which lets you scale out Amazon Elastic Compute Cloud (Amazon EC2) instances based on metrics like CPU or memory utilization. Applications that use Prometheus metrics can easily integrate into EC2 Auto Scaling without needing to replace their monitoring stack. In this post, I will walk you through configuring Amazon EC2 Auto Scaling to work with Amazon Managed Service for Prometheus Alert Manager. This approach lets you move a Prometheus-based workload to the cloud while taking advantage of services like autoscaling."><link data-rh="true" rel="icon" href="/observability-best-practices/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://aws-observability.github.io/observability-best-practices/recipes/recipes/as-ec2-using-amp-and-alertmanager"><link data-rh="true" rel="alternate" href="https://aws-observability.github.io/observability-best-practices/recipes/recipes/as-ec2-using-amp-and-alertmanager" hreflang="en"><link data-rh="true" rel="alternate" href="https://aws-observability.github.io/observability-best-practices/ja/recipes/recipes/as-ec2-using-amp-and-alertmanager" hreflang="ja"><link data-rh="true" rel="alternate" href="https://aws-observability.github.io/observability-best-practices/recipes/recipes/as-ec2-using-amp-and-alertmanager" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/observability-best-practices/blog/rss.xml" title="AWS Observability Best Practices RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/observability-best-practices/blog/atom.xml" title="AWS Observability Best Practices Atom Feed"><link rel="stylesheet" href="/observability-best-practices/assets/css/styles.e835fd1b.css">
<script src="/observability-best-practices/assets/js/runtime~main.a9a0fea9.js" defer="defer"></script>
<script src="/observability-best-practices/assets/js/main.98f73edf.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/observability-best-practices/"><div class="navbar__logo"><img src="/observability-best-practices/img/logo.svg" alt="AWS Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/observability-best-practices/img/logo.svg" alt="AWS Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">AWS Observability Best Practices</b></a><a class="navbar__item navbar__link" href="/observability-best-practices/home">Home</a><a class="navbar__item navbar__link" href="/observability-best-practices/guides/">Guides</a><a class="navbar__item navbar__link" href="/observability-best-practices/signals/logs">Signals</a><a class="navbar__item navbar__link" href="/observability-best-practices/tools/observability_accelerator">Tools</a><a class="navbar__item navbar__link" href="/observability-best-practices/recipes/">Recipes</a><a class="navbar__item navbar__link" href="/observability-best-practices/faq/general">FAQ</a><a class="navbar__item navbar__link" href="/observability-best-practices/patterns/Tracing/xrayec2">Patterns</a><a class="navbar__item navbar__link" href="/observability-best-practices/persona/cloud_engineer">Persona</a><a class="navbar__item navbar__link" href="/observability-best-practices/resources/">Resources</a><a class="navbar__item navbar__link" href="/observability-best-practices/contributors">Contributors</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/observability-best-practices/recipes/recipes/as-ec2-using-amp-and-alertmanager" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/observability-best-practices/ja/recipes/recipes/as-ec2-using-amp-and-alertmanager" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="ja">日本語</a></li></ul></div><a href="https://github.com/aws-observability/observability-best-practices" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><main class="docMainContainer_TBSr docMainContainerEnhanced_lQrH"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Auto-scaling Amazon EC2 using Amazon Managed Service for Prometheus and alert manager</h1></header>
<p>Customers want to migrate their existing Prometheus workloads to the cloud and utilize all that the cloud offers. AWS has services like Amazon <a href="https://aws.amazon.com/ec2/autoscaling/" target="_blank" rel="noopener noreferrer">EC2 Auto Scaling</a>, which lets you scale out <a href="https://aws.amazon.com/pm/ec2/" target="_blank" rel="noopener noreferrer">Amazon Elastic Compute Cloud (Amazon EC2)</a> instances based on metrics like CPU or memory utilization. Applications that use Prometheus metrics can easily integrate into EC2 Auto Scaling without needing to replace their monitoring stack. In this post, I will walk you through configuring Amazon EC2 Auto Scaling to work with <a href="https://aws.amazon.com/prometheus/" target="_blank" rel="noopener noreferrer">Amazon Managed Service for Prometheus Alert Manager</a>. This approach lets you move a Prometheus-based workload to the cloud while taking advantage of services like autoscaling.</p>
<p>Amazon Managed Service for Prometheus provides support for <a href="https://docs.aws.amazon.com/prometheus/latest/userguide/AMP-Ruler.html" target="_blank" rel="noopener noreferrer">alerting rules</a> that use <a href="https://prometheus.io/docs/prometheus/latest/querying/basics/" target="_blank" rel="noopener noreferrer">PromQL</a>. The <a href="https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/" target="_blank" rel="noopener noreferrer">Prometheus alerting rules documentation</a> provides the syntax and examples of valid alerting rules. Likewise, the Prometheus alert manager documentation references both the <a href="https://prometheus.io/docs/prometheus/latest/configuration/template_reference/" target="_blank" rel="noopener noreferrer">syntax</a> and <a href="https://prometheus.io/docs/prometheus/latest/configuration/template_examples/" target="_blank" rel="noopener noreferrer">examples</a> of valid alert manager configurations.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="solution-overview">Solution overview<a href="#solution-overview" class="hash-link" aria-label="Direct link to Solution overview" title="Direct link to Solution overview">​</a></h2>
<p>First, let’s briefly review Amazon EC2 Auto Scaling‘s concept of an <a href="https://docs.aws.amazon.com/autoscaling/ec2/userguide/auto-scaling-groups.html" target="_blank" rel="noopener noreferrer">Auto Scaling group</a> which is a logical collection of Amazon EC2 instances. An Auto Scaling group can launch EC2 instances based on a predefined launch template. The <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-launch-templates.html" target="_blank" rel="noopener noreferrer">launch template</a> contains information used to launch the Amazon EC2 instance, including the AMI ID, the instance type, network settings, and <a href="https://aws.amazon.com/iam/" target="_blank" rel="noopener noreferrer">AWS Identity and Access Management (IAM)</a> instance profile.</p>
<p>Amazon EC2 Auto Scaling groups have a <a href="https://docs.aws.amazon.com/autoscaling/ec2/userguide/what-is-amazon-ec2-auto-scaling.html" target="_blank" rel="noopener noreferrer">minimum size, maximum size, and desired capacity</a> concepts. When Amazon EC2 Auto Scaling detects that the current running capacity of the Auto Scaling group is above or below the desired capacity, it will automatically scale out or scale in as needed. This scaling approach lets you utilize elasticity within your workload while still keeping bounds on both capacity and costs.</p>
<p>To demonstrate this solution, I have created an Amazon EC2 Auto Scaling group that contains two Amazon EC2 instances. These instances <a href="https://docs.aws.amazon.com/prometheus/latest/userguide/AMP-onboard-ingest-metrics-remote-write-EC2.html" target="_blank" rel="noopener noreferrer">remote write instance metrics</a> to an Amazon Managed Service for Prometheus workspace. I have set the Auto Scaling group’s minimum size to two (to maintain high availability), and I’ve set the group’s maximum size to 10 (to help control costs). As more traffic hits the solution, additional Amazon EC2 instances are automatically added to support the load, up to the Amazon EC2 Auto Scaling group’s maximum size. As the load decreases, those Amazon EC2 instances are terminated until the Amazon EC2 Auto Scaling group reaches the group’s minimum size. This approach lets you have a performant application by utilizing the elasticity of the cloud.</p>
<p>Note that as you scrape more and more resources, you could quickly overwhelm the capabilities of a single Prometheus server. You can avoid this situation by scaling Prometheus servers linearly with the workload. This approach ensures that you can collect metric data at the granularity that you want.</p>
<p>To support the Auto Scaling of a Prometheus workload, I have created an Amazon Managed Service for Prometheus workspace with the following rules:</p>
<p><code>YAML</code></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">groups:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- name: example</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - alert: HostHighCpuLoad</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    expr: 100 - (avg(rate(node_cpu_seconds_total{mode=&quot;idle&quot;}[2m])) * 100) &gt; 60</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for: 5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      severity: warning</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      event_type: scale_up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      summary: Host high CPU load (instance {{ $labels.instance }})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      description: &quot;CPU load is &gt; 60%\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - alert: HostLowCpuLoad</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    expr: 100 - (avg(rate(node_cpu_seconds_total{mode=&quot;idle&quot;}[2m])) * 100) &lt; 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for: 5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      severity: warning</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      event_type: scale_down</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      summary: Host low CPU load (instance {{ $labels.instance }})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      description: &quot;CPU load is &lt; 30%\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This rules set creates a <code>HostHighCpuLoad</code> and a <code>HostLowCpuLoad</code> rules. These alerts trigger when the CPU is greater than 60% or less than 30% utilization over a five-minute period.</p>
<p>After raising an alert, the alert manager will forward the message into an Amazon SNS topic, passing an <code>alert_type</code> (the alert name) and <code>event_type</code> (scale_down or scale_up).</p>
<p><code>YAML</code></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">alertmanager_config: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  route: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    receiver: default_receiver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    repeat_interval: 5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  receivers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: default_receiver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      sns_configs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - topic_arn: &lt;ARN OF SNS TOPIC GOES HERE&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          send_resolved: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          sigv4:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            region: us-east-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          message: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            alert_type: {{ .CommonLabels.alertname }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            event_type: {{ .CommonLabels.event_type }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>An AWS <a href="https://aws.amazon.com/lambda/" target="_blank" rel="noopener noreferrer">Lambda</a> function is subscribed to the Amazon SNS topic. I have written logic in the Lambda function to inspect the Amazon SNS message and determine if a <code>scale_up</code> or <code>scale_down</code> event should happen. Then, the Lambda function increments or decrements the desired capacity of the Amazon EC2 Auto Scaling group. The Amazon EC2 Auto Scaling group detects a requested change in capacity, and then invokes or deallocates Amazon EC2 instances.</p>
<p>The Lambda code to support Auto Scaling is as follows:</p>
<p><code>Python</code></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import boto3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def lambda_handler(event, context):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(event)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    msg = event[&#x27;Records&#x27;][0][&#x27;Sns&#x27;][&#x27;Message&#x27;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    scale_type = &#x27;&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if msg.find(&#x27;scale_up&#x27;) &gt; -1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        scale_type = &#x27;scale_up&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        scale_type = &#x27;scale_down&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    get_desired_instance_count(scale_type)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def get_desired_instance_count(scale_type):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    client = boto3.client(&#x27;autoscaling&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    asg_name = os.environ[&#x27;ASG_NAME&#x27;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    response = client.describe_auto_scaling_groups(AutoScalingGroupNames=[ asg_name])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    minSize = response[&#x27;AutoScalingGroups&#x27;][0][&#x27;MinSize&#x27;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    maxSize = response[&#x27;AutoScalingGroups&#x27;][0][&#x27;MaxSize&#x27;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    desiredCapacity = response[&#x27;AutoScalingGroups&#x27;][0][&#x27;DesiredCapacity&#x27;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if scale_type == &quot;scale_up&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        desiredCapacity = min(desiredCapacity+1, maxSize)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if scale_type == &quot;scale_down&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        desiredCapacity = max(desiredCapacity - 1, minSize)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&#x27;Scale type: {}; new capacity: {}&#x27;.format(scale_type, desiredCapacity))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    response = client.set_desired_capacity(AutoScalingGroupName=asg_name, DesiredCapacity=desiredCapacity, HonorCooldown=False)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The full architecture can be reviewed in the following figure.</p>
<p><img decoding="async" loading="lazy" alt="Architecture" src="/observability-best-practices/assets/images/as-ec2-amp-alertmanager3-a7f7c99c80d1b4696adcea6abcaaf46e.png" width="1411" height="1081" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="testing-out-the-solution">Testing out the solution<a href="#testing-out-the-solution" class="hash-link" aria-label="Direct link to Testing out the solution" title="Direct link to Testing out the solution">​</a></h2>
<p>You can launch an AWS CloudFormation template to automatically provision this solution.</p>
<p>Stack prerequisites:</p>
<ul>
<li>An <a href="https://aws.amazon.com/vpc/" target="_blank" rel="noopener noreferrer">Amazon Virtual Private Cloud (Amazon VPC)</a></li>
<li>An AWS Security Group that allows outbound traffic</li>
</ul>
<p>Select the Download Launch Stack Template link to download and set up the template in your account. As part of the configuration process, you must specify the subnets and the security groups that you want associated with the Amazon EC2 instances. See the following figure for details.</p>
<p><a href="https://prometheus-autoscale.s3.amazonaws.com/prometheus-autoscale.template" target="_blank" rel="noopener noreferrer">## Download Launch Stack Template </a></p>
<p><img decoding="async" loading="lazy" alt="Launch Stack" src="/observability-best-practices/assets/images/as-ec2-amp-alertmanager4-63dab0d7230022913dfb7193f39cce88.png" width="1415" height="1315" class="img_ev3q"></p>
<p>This is the CloudFormation stack details screen, where the stack name has been set as prometheus-autoscale. The stack parameters include a URL of the Linux installer for Prometheus, the URL for the Linux Node Exporter for Prometheus, the subnets and security groups used in the solution, the AMI and instance type to use, and the maximum capacity of the Amazon EC2 Auto Scaling group.</p>
<p>The stack will take approximately eight minutes to deploy. Once complete, you will find two Amazon EC2 instances that have been deployed and are running in the Amazon EC2 Auto Scaling group that has been created for you. To validate that this solution auto-scales via Amazon Managed Service for Prometheus Alert Manager, you apply load to the Amazon EC2 instances using the <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/execute-remote-commands.html" target="_blank" rel="noopener noreferrer">AWS Systems Manager Run Command</a> and the <a href="https://docs.aws.amazon.com/fis/latest/userguide/actions-ssm-agent.html#awsfis-run-cpu-stress" target="_blank" rel="noopener noreferrer">AWSFIS-Run-CPU-Stress automation document</a>.</p>
<p>As stress is applied to the CPUs in the Amazon EC2 Auto Scaling group, alert manager publishes these alerts, which the Lambda function responds to by scaling up the Auto Scaling group.  As CPU consumption decreases, the low CPU alert in the Amazon Managed Service for Prometheus workspace fires, alert manager publishes the alert to the Amazon SNS topic, and the Lambda function responds by responds by scaling down the Auto Scaling group, as demonstrated in the following figure.</p>
<p><img decoding="async" loading="lazy" alt="Dashboard" src="/observability-best-practices/assets/images/as-ec2-amp-alertmanager5-844cc9ab4fa8958fb3db3b86b52d8df5.png" width="1405" height="702" class="img_ev3q"></p>
<p>The Grafana dashboard has a line showing that CPU has spiked to 100%. Although the CPU is high, another line shows that the number of instances has stepped up from 2 to 10. Once CPU has decreased, the number of instances slowly decreases back down to 2.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="costs">Costs<a href="#costs" class="hash-link" aria-label="Direct link to Costs" title="Direct link to Costs">​</a></h2>
<p>Amazon Managed Service for Prometheus is priced based on the metrics ingested, metrics stored, and metrics queried. Visit the <a href="https://aws.amazon.com/prometheus/pricing/" target="_blank" rel="noopener noreferrer">Amazon Managed Service for Prometheus pricing page</a> for the latest pricing and pricing examples.</p>
<p>Amazon SNS is priced based on the number of monthly API requests made. Message delivery between Amazon SNS and Lambda is free, but it does charge for the amount of data transferred between Amazon SNS and Lambda. See the <a href="https://aws.amazon.com/sns/pricing/" target="_blank" rel="noopener noreferrer">latest Amazon SNS pricing details</a>.</p>
<p>Lambda is priced based on the duration of your function execution and the number of requests made to the function. See the latest <a href="https://aws.amazon.com/lambda/pricing/" target="_blank" rel="noopener noreferrer">AWS Lambda pricing details</a>.</p>
<p>There are <a href="https://aws.amazon.com/ec2/autoscaling/pricing/" target="_blank" rel="noopener noreferrer">no additional charges for using</a> Amazon EC2 Auto Scaling.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>By using Amazon Managed Service for Prometheus, alert manager, Amazon SNS, and Lambda, you can control the scaling activities of an Amazon EC2 Auto Scaling group. The solution in this post demonstrates how you can move existing Prometheus workloads to AWS, while also utilizing Amazon EC2 Auto Scaling. As load increases to the application, it seamlessly scales to meet demand.</p>
<p>In this example, the Amazon EC2 Auto Scaling group scaled based on CPU, but you can follow a similar approach for any Prometheus metric from your workload. This approach provides fine-grained control over scaling actions, thereby making sure that you can scale your workload on the metric that provides the most business value.</p>
<p>In previous blog posts, we’ve also demonstrated how you can use <a href="https://aws.amazon.com/blogs/mt/using-amazon-managed-service-for-prometheus-alert-manager-to-receive-alerts-with-pagerduty/" target="_blank" rel="noopener noreferrer">Amazon Managed Service for Prometheus Alert Manager to receive alerts with PagerDuty</a> and <a href="https://aws.amazon.com/blogs/mt/how-to-integrate-amazon-managed-service-for-prometheus-with-slack/" target="_blank" rel="noopener noreferrer">how to integrate Amazon Managed Service for Prometheus with Slack</a>. These solutions show how you can receive alerts from your workspace in the way that is most useful to you.</p>
<p>For next steps, see how to <a href="https://docs.aws.amazon.com/prometheus/latest/userguide/AMP-rules-upload.html" target="_blank" rel="noopener noreferrer">create your own rules configuration file</a> for Amazon Managed Service for Prometheus, and set up your own <a href="https://docs.aws.amazon.com/prometheus/latest/userguide/AMP-alertmanager-receiver.html" target="_blank" rel="noopener noreferrer">alert receiver</a>. Moreover, check out <a href="https://awesome-prometheus-alerts.grep.to/alertmanager" target="_blank" rel="noopener noreferrer">Awesome Prometheus alerts</a> for some good examples of alerting rules that can be used within alert manager.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/aws-observability/observability-best-practices/blob/main/docusaurus/docs/recipes/recipes/as-ec2-using-amp-and-alertmanager.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#solution-overview" class="table-of-contents__link toc-highlight">Solution overview</a></li><li><a href="#testing-out-the-solution" class="table-of-contents__link toc-highlight">Testing out the solution</a></li><li><a href="#costs" class="table-of-contents__link toc-highlight">Costs</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Built with ❤️ at AWS. <br> © 2025.  Amazon.com, Inc. or its affiliates. All Rights Reserved.</div></div></div></footer></div>
</body>
</html>